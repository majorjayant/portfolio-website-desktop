<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-indigo-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center">
                    <a href="/admin/" class="mr-4 text-sm text-white hover:text-gray-200">Admin Home</a>
                    <button id="logout-button" class="bg-white text-indigo-600 px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
                <div class="px-4 py-5 sm:px-6 bg-indigo-50">
                    <h2 class="text-lg leading-6 font-medium text-indigo-900">Site Configuration</h2>
                    <p class="mt-1 max-w-2xl text-sm text-indigo-500">Edit your website's configuration settings</p>
                </div>
                
                <div id="save-message" class="hidden px-4 py-3 text-center border-t border-b"></div>
                
                <form id="site-config-form" class="p-6">
                    <!-- General Website Information -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">General Website Information</h3>
                        
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <label for="about_title" class="block text-sm font-medium text-gray-700">Site Title</label>
                                <input type="text" name="about_title" id="about_title" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            </div>
                            
                            <div class="sm:col-span-1">
                                <label for="about_subtitle" class="block text-sm font-medium text-gray-700">Subtitle</label>
                                <input type="text" name="about_subtitle" id="about_subtitle" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            </div>
                            
                            <div class="sm:col-span-2">
                                <label for="about_description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="about_description" id="about_description" rows="4" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Website Images -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Website Images</h3>
                        
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <label for="image_favicon_url" class="block text-sm font-medium text-gray-700">Favicon URL</label>
                                <input type="url" name="image_favicon_url" id="image_favicon_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the website favicon (browser tab icon)</p>
                            </div>
                            
                            <div class="sm:col-span-1">
                                <label for="image_logo_url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                                <input type="url" name="image_logo_url" id="image_logo_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the website logo</p>
                            </div>
                            
                            <div class="sm:col-span-2">
                                <label for="image_banner_url" class="block text-sm font-medium text-gray-700">Banner URL</label>
                                <input type="url" name="image_banner_url" id="image_banner_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the main banner image</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Image -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Profile Image</h3>
                        
                        <div class="sm:col-span-2">
                            <label for="image_about_profile_url" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                            <input type="url" name="image_about_profile_url" id="image_about_profile_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            <p class="mt-1 text-xs text-gray-500">URL for your profile image</p>
                        </div>
                    </div>
                    
                    <!-- Gallery Photos -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Gallery Photos</h3>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 1</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo1_url" class="block text-sm font-medium text-gray-700">Photo 1 URL</label>
                                    <input type="url" name="image_about_photo1_url" id="image_about_photo1_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo1_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo1_alt" id="about_photo1_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 2</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo2_url" class="block text-sm font-medium text-gray-700">Photo 2 URL</label>
                                    <input type="url" name="image_about_photo2_url" id="image_about_photo2_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo2_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo2_alt" id="about_photo2_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 3</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo3_url" class="block text-sm font-medium text-gray-700">Photo 3 URL</label>
                                    <input type="url" name="image_about_photo3_url" id="image_about_photo3_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo3_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo3_alt" id="about_photo3_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 4</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo4_url" class="block text-sm font-medium text-gray-700">Photo 4 URL</label>
                                    <input type="url" name="image_about_photo4_url" id="image_about_photo4_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo4_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo4_alt" id="about_photo4_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" id="refresh-button" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2">
                            Refresh Data
                        </button>
                        <button type="submit" id="save-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <p class="text-center text-sm text-gray-500">
                    &copy; 2025 Portfolio Admin. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin dashboard loaded');
        
        const authLoading = document.getElementById('auth-loading');
        const notAuthenticated = document.getElementById('not-authenticated');
        const dashboardContent = document.getElementById('dashboard-content');
        const logoutButton = document.getElementById('logout-button');
        const siteConfigForm = document.getElementById('site-config-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const formContainer = document.getElementById('form-container');
        const apiError = document.getElementById('api-error');
        const saveButton = document.getElementById('save-button');
        
        // Get or create the save message element
        let saveMessage = document.getElementById('save-message');
        if (!saveMessage) {
            console.log('Creating new save message element');
            saveMessage = document.createElement('div');
            saveMessage.className = 'px-4 py-3 text-center border-t border-b hidden';
            saveMessage.id = 'save-message';
            
            // Insert before the form if possible
            const form = document.getElementById('site-config-form');
            if (form && form.parentNode) {
                form.parentNode.insertBefore(saveMessage, form);
            }
        }
        
        // API endpoints
        const API_BASE_URL = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio';
        const DIRECT_INVOKE_URL = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio';
        
        // Check authentication
        function checkAuthentication() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                console.log('User is not authenticated, redirecting to login');
                window.location.href = '/admin-direct/';
                return false;
            }
            return true;
        }
        
        // Log out function
        function logout() {
            console.log('Logging out');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login.html';
        }
        
        // Load site configuration
        async function fetchConfiguration() {
            showSaveMessage('Loading configuration...', 'text-blue-500 bg-blue-50');
            try {
                // Get authentication token
                const token = localStorage.getItem('admin_token');
                
                // Try GET method first, which is already supported in the Lambda
                const url = `${DIRECT_INVOKE_URL}?type=site_config`;
                console.log('Fetching config using GET with query parameter:', url);
                
                // Use GET with query parameter to specify the type
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': token || ''
                    }
                });
                
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to load configuration (Status: ${response.status})`);
                }
                
                const rawData = await response.json();
                console.log('Raw API response:', rawData);
                
                // Extract the site_config object from the response
                let config;
                if (rawData.site_config) {
                    // Direct structure from Lambda
                    console.log('Found site_config in direct response');
                    config = rawData.site_config;
                } else if (rawData.body && typeof rawData.body === 'string') {
                    // API Gateway might wrap the response in a body property
                    try {
                        console.log('Attempting to parse body from API Gateway response');
                        const parsedBody = JSON.parse(rawData.body);
                        if (parsedBody.site_config) {
                            console.log('Found site_config in parsed body');
                            config = parsedBody.site_config;
                        } else {
                            console.error('No site_config found in parsed body:', parsedBody);
                            showSaveMessage('Error: Received response from server but no configuration data was found', 'text-red-500 bg-red-50');
                            return;
                        }
                    } catch (e) {
                        console.error('Error parsing body:', e);
                        showSaveMessage('Error: Could not parse response from server', 'text-red-500 bg-red-50');
                        return;
                    }
                } else if (rawData.message && rawData.message.includes("Unknown request type")) {
                    console.error('Server responded with "Unknown request type"');
                    showSaveMessage('Error: Server does not recognize this request. The Lambda function may need to be updated.', 'text-red-500 bg-red-50');
                    return;
                } else {
                    console.error('Unexpected API response format:', rawData);
                    showSaveMessage('Error: Unexpected response format from server', 'text-red-500 bg-red-50');
                    return;
                }
                
                console.log('Extracted config for form:', config);
                
                if (!config || Object.keys(config).length === 0) {
                    console.error('No configuration data found in API response');
                    showSaveMessage('Error: No configuration data found in API response', 'text-red-500 bg-red-50');
                    return;
                }
                
                // Config data found, populate form
                hideSaveMessage();
                populateForm(config);
            } catch (error) {
                console.error('Error loading configuration:', error);
                showSaveMessage('Error loading configuration: ' + error.message, 'text-red-500 bg-red-50');
                
                // Add retry button
                const retryButton = document.createElement('button');
                retryButton.textContent = 'Retry';
                retryButton.className = 'ml-4 px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700';
                retryButton.onclick = fetchConfiguration;
                saveMessage.appendChild(retryButton);
            }
        }
        
        // Fill form with configuration data
        function populateForm(config) {
            console.log('Populating form with config:', config);
            
            // Helper function to set input values
            function setInputValue(id, value) {
                const input = document.getElementById(id);
                if (input) {
                    if (value !== undefined && value !== null) {
                        input.value = value;
                        console.log(`Set ${id} = ${value}`);
                    } else {
                        input.value = '';
                        console.log(`Field ${id} is empty (undefined/null value)`);
                    }
                } else {
                    console.warn(`Element with ID ${id} not found in the form`);
                }
            }
            
            // Set values for each form field
            setInputValue('about_title', config.about_title);
            setInputValue('about_subtitle', config.about_subtitle);
            setInputValue('about_description', config.about_description);
            setInputValue('image_favicon_url', config.image_favicon_url);
            setInputValue('image_logo_url', config.image_logo_url);
            setInputValue('image_banner_url', config.image_banner_url);
            setInputValue('image_about_profile_url', config.image_about_profile_url);
            setInputValue('image_about_photo1_url', config.image_about_photo1_url);
            setInputValue('image_about_photo2_url', config.image_about_photo2_url);
            setInputValue('image_about_photo3_url', config.image_about_photo3_url);
            setInputValue('image_about_photo4_url', config.image_about_photo4_url);
            setInputValue('about_photo1_alt', config.about_photo1_alt);
            setInputValue('about_photo2_alt', config.about_photo2_alt);
            setInputValue('about_photo3_alt', config.about_photo3_alt);
            setInputValue('about_photo4_alt', config.about_photo4_alt);
        }
        
        // Save site configuration
        async function saveSiteConfig(formData) {
            showSaveMessage('Saving configuration...', 'text-blue-500 bg-blue-50');
            
            // Convert form data to object
            const configData = {};
            formData.forEach((value, key) => {
                configData[key] = value;
            });
            
            console.log('Saving config data:', configData);
            
            try {
                // Get authentication token
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    throw new Error('Authentication token is missing');
                }
                
                // Prepare payload in the format the Lambda function expects
                const payload = {
                    action: 'update_site_config',
                    site_config: configData
                };
                
                console.log('Sending API payload:', payload);
                
                // Save to API
                const apiResponse = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify(payload)
                });

                console.log('API response status:', apiResponse.status);
                if (!apiResponse.ok) {
                    throw new Error(`API Error: ${apiResponse.status}`);
                }

                const apiData = await apiResponse.json();
                console.log('API response data:', apiData);
                
                if (apiData.body && typeof apiData.body === 'string') {
                    // Handle API Gateway response format
                    try {
                        const parsedBody = JSON.parse(apiData.body);
                        if (!parsedBody.success) {
                            throw new Error(parsedBody.message || 'API save failed');
                        }
                    } catch (e) {
                        throw new Error('Invalid response from API');
                    }
                } else if (!apiData.success) {
                    throw new Error(apiData.message || 'API save failed');
                }

                showSaveMessage('Configuration saved successfully!', 'text-green-500 bg-green-50');
                setTimeout(hideSaveMessage, 3000);

                // Refresh the configuration after saving
                await fetchConfiguration();
            } catch (error) {
                console.error('Error saving configuration:', error);
                showSaveMessage('Error saving configuration: ' + error.message, 'text-red-500 bg-red-50');
                
                // Add retry button
                const retryButton = document.createElement('button');
                retryButton.textContent = 'Retry Save';
                retryButton.className = 'ml-4 px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700';
                retryButton.onclick = () => saveSiteConfig(formData);
                saveMessage.appendChild(retryButton);
            }
        }
        
        // Show save message with appropriate styling
        function showSaveMessage(message, classNames) {
            saveMessage.textContent = message;
            saveMessage.className = 'px-4 py-3 text-center border-t border-b ' + classNames;
            saveMessage.classList.remove('hidden');
        }
        
        // Hide save message
        function hideSaveMessage() {
            saveMessage.classList.add('hidden');
        }
        
        // Event listeners
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
        
        if (siteConfigForm) {
            siteConfigForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(siteConfigForm);
                saveSiteConfig(formData);
            });
        }
        
        // Add refresh button event listener
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', fetchConfiguration);
        }
        
        // Check if user is authenticated
        if (checkAuthentication()) {
            // Load site configuration
            fetchConfiguration();
        }
    });
    </script>
</body>
</html> 
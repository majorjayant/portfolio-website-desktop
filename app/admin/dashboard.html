<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-indigo-600 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center">
                    <a href="/admin/" class="mr-4 text-sm text-white hover:text-gray-200">Admin Home</a>
                    <button id="logout-button" class="bg-white text-indigo-600 px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
                <div class="px-4 py-5 sm:px-6 bg-indigo-50">
                    <h2 class="text-lg leading-6 font-medium text-indigo-900">Site Configuration</h2>
                    <p class="mt-1 max-w-2xl text-sm text-indigo-500">Edit your website's configuration settings</p>
                </div>
                
                <div id="save-message" class="hidden px-4 py-3 text-center border-t border-b"></div>
                
                <form id="site-config-form" class="p-6">
                    <!-- General Website Information -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">General Website Information</h3>
                        
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <label for="about_title" class="block text-sm font-medium text-gray-700">Site Title</label>
                                <input type="text" name="about_title" id="about_title" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            </div>
                            
                            <div class="sm:col-span-1">
                                <label for="about_subtitle" class="block text-sm font-medium text-gray-700">Subtitle</label>
                                <input type="text" name="about_subtitle" id="about_subtitle" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            </div>
                            
                            <div class="sm:col-span-2">
                                <label for="about_description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="about_description" id="about_description" rows="4" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Website Images -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Website Images</h3>
                        
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                            <div class="sm:col-span-1">
                                <label for="image_favicon_url" class="block text-sm font-medium text-gray-700">Favicon URL</label>
                                <input type="url" name="image_favicon_url" id="image_favicon_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the website favicon (browser tab icon)</p>
                            </div>
                            
                            <div class="sm:col-span-1">
                                <label for="image_logo_url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                                <input type="url" name="image_logo_url" id="image_logo_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the website logo</p>
                            </div>
                            
                            <div class="sm:col-span-2">
                                <label for="image_banner_url" class="block text-sm font-medium text-gray-700">Banner URL</label>
                                <input type="url" name="image_banner_url" id="image_banner_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                <p class="mt-1 text-xs text-gray-500">URL for the main banner image</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Image -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Profile Image</h3>
                        
                        <div class="sm:col-span-2">
                            <label for="image_about_profile_url" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                            <input type="url" name="image_about_profile_url" id="image_about_profile_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                            <p class="mt-1 text-xs text-gray-500">URL for your profile image</p>
                        </div>
                    </div>
                    
                    <!-- Gallery Photos -->
                    <div class="mb-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Gallery Photos</h3>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 1</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo1_url" class="block text-sm font-medium text-gray-700">Photo 1 URL</label>
                                    <input type="url" name="image_about_photo1_url" id="image_about_photo1_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo1_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo1_alt" id="about_photo1_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 2</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo2_url" class="block text-sm font-medium text-gray-700">Photo 2 URL</label>
                                    <input type="url" name="image_about_photo2_url" id="image_about_photo2_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo2_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo2_alt" id="about_photo2_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6 border-b border-gray-200 pb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 3</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo3_url" class="block text-sm font-medium text-gray-700">Photo 3 URL</label>
                                    <input type="url" name="image_about_photo3_url" id="image_about_photo3_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo3_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo3_alt" id="about_photo3_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-4">Photo 4</h4>
                            <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <label for="image_about_photo4_url" class="block text-sm font-medium text-gray-700">Photo 4 URL</label>
                                    <input type="url" name="image_about_photo4_url" id="image_about_photo4_url" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                </div>
                                <div class="sm:col-span-1">
                                    <label for="about_photo4_alt" class="block text-sm font-medium text-gray-700">Alt Text</label>
                                    <input type="text" name="about_photo4_alt" id="about_photo4_alt" class="mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" placeholder="Alternative text for accessibility">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" id="refresh-button" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2">
                            Refresh Data
                        </button>
                        <button type="submit" id="save-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <p class="text-center text-sm text-gray-500">
                    &copy; 2025 Portfolio Admin. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <script>
    // API endpoints
    const API_BASE_URL = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio';
    const GET_CONFIG_URL = API_BASE_URL + '?action=get_site_config&type=site_config';
    const SAVE_CONFIG_URL = API_BASE_URL;
    
    // DOM elements
    document.addEventListener('DOMContentLoaded', function() {
        const siteConfigForm = document.getElementById('site-config-form');
        const logoutButton = document.getElementById('logout-button');
        const saveMessage = document.getElementById('save-message');
        
        // Check if user is logged in
        function checkAuthentication() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                console.log('No authentication token found, redirecting to login');
                window.location.href = '/admin-direct/';
                return false;
            }
            return true;
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin-direct/';
        }
        
        // Utility function to set input value
        function setInputValue(id, value) {
            const input = document.getElementById(id);
            if (input) {
                input.value = value || '';
                console.log(`Set ${id} = ${value}`);
            }
        }
        
        // Fetch site configuration
        async function fetchConfiguration() {
            console.log('Admin dashboard loaded');
            try {
                // Add cache buster to prevent caching
                const cacheBuster = new Date().getTime();
                const urlWithCacheBuster = `${GET_CONFIG_URL}&t=${cacheBuster}`;
                
                console.log('Fetching config using GET with cache buster:', urlWithCacheBuster);
                
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    console.error('Authentication token is missing');
                    return;
                }
                
                // Fetch configuration data
                const response = await fetch(urlWithCacheBuster, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch configuration: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Raw API response:', data);
                
                // Handle API Gateway response format
                let config = null;
                
                if (data.body && typeof data.body === 'string') {
                    console.log('Attempting to parse body from API Gateway response');
                    try {
                        const parsedBody = JSON.parse(data.body);
                        if (parsedBody.site_config) {
                            console.log('Found site_config in parsed body');
                            config = parsedBody.site_config;
                        } else {
                            console.log('No site_config found in parsed body:', parsedBody);
                        }
                    } catch (e) {
                        console.error('Error parsing API response body:', e);
                    }
                } else if (data.site_config) {
                    console.log('Found site_config directly in response');
                    config = data.site_config;
                }
                
                if (!config) {
                    console.error('No configuration data found in API response');
                    clearForm();
                    return;
                }
                
                console.log('Extracted config for form:', config);
                
                // Populate the form with configuration data
                populateForm(config);
            } catch (error) {
                console.error('Error loading configuration:', error);
                // Show an error message
                if (saveMessage) {
                    saveMessage.textContent = 'Error loading configuration: ' + error.message;
                    saveMessage.className = 'px-4 py-3 text-center border-t border-b text-red-500 bg-red-50';
                    saveMessage.classList.remove('hidden');
                    
                    // Add refresh button
                    const refreshButton = document.createElement('button');
                    refreshButton.textContent = 'Retry Loading';
                    refreshButton.className = 'ml-4 px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700';
                    refreshButton.onclick = fetchConfiguration;
                    saveMessage.appendChild(refreshButton);
                }
            }
        }
        
        // Clear form fields
        function clearForm() {
            const fields = ['about_title', 'about_subtitle', 'about_description',
                           'image_favicon_url', 'image_logo_url', 'image_banner_url',
                           'image_about_profile_url', 'image_about_photo1_url', 'image_about_photo2_url',
                           'image_about_photo3_url', 'image_about_photo4_url', 'about_photo1_alt',
                           'about_photo2_alt', 'about_photo3_alt', 'about_photo4_alt'];
            
            fields.forEach(fieldId => {
                setInputValue(fieldId, '');
            });
        }
        
        // Populate form with configuration data
        function populateForm(config) {
            console.log('Populating form with config:', config);
            
            // Check if config is valid
            if (!config || typeof config !== 'object') {
                console.error('Invalid configuration object:', config);
                return;
            }
            
            // Set values for each field
            setInputValue('about_title', config.about_title);
            setInputValue('about_subtitle', config.about_subtitle);
            setInputValue('about_description', config.about_description);
            setInputValue('image_favicon_url', config.image_favicon_url);
            setInputValue('image_logo_url', config.image_logo_url);
            setInputValue('image_banner_url', config.image_banner_url);
            setInputValue('image_about_profile_url', config.image_about_profile_url);
            setInputValue('image_about_photo1_url', config.image_about_photo1_url);
            setInputValue('image_about_photo2_url', config.image_about_photo2_url);
            setInputValue('image_about_photo3_url', config.image_about_photo3_url);
            setInputValue('image_about_photo4_url', config.image_about_photo4_url);
            setInputValue('about_photo1_alt', config.about_photo1_alt);
            setInputValue('about_photo2_alt', config.about_photo2_alt);
            setInputValue('about_photo3_alt', config.about_photo3_alt);
            setInputValue('about_photo4_alt', config.about_photo4_alt);
        }
        
        // Save site configuration
        async function saveSiteConfig(formData) {
            showSaveMessage('Saving configuration...', 'text-blue-500 bg-blue-50');
            
            // Convert form data to object
            const configData = {};
            formData.forEach((value, key) => {
                configData[key] = value;
            });
            
            console.log('Saving config data:', configData);
            
            try {
                // Get authentication token
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    throw new Error('Authentication token is missing');
                }
                
                // Prepare payload in the format the Lambda function expects
                const payload = {
                    action: 'update_site_config',
                    site_config: configData
                };
                
                console.log('Sending API payload:', payload);
                console.log('Send URL:', SAVE_CONFIG_URL);
                
                // Save to API without the custom header that was causing CORS issues
                const apiResponse = await fetch(SAVE_CONFIG_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                        // Removed X-Custom-Action header
                    },
                    body: JSON.stringify(payload)
                });

                console.log('API response status:', apiResponse.status);
                if (!apiResponse.ok) {
                    throw new Error(`API Error: ${apiResponse.status}`);
                }

                const apiData = await apiResponse.json();
                console.log('API response data:', apiData);
                
                // Extract the success status and message
                let success = false;
                let message = 'Unknown response format';
                
                if (apiData.body && typeof apiData.body === 'string') {
                    // Handle API Gateway response format
                    try {
                        const parsedBody = JSON.parse(apiData.body);
                        console.log('Parsed API Gateway response body:', parsedBody);
                        
                        // Check if we have the expected success field
                        if (parsedBody.success === true) {
                            success = true;
                            message = parsedBody.message || 'Configuration saved successfully';
                        } else if (parsedBody.site_config) {
                            // The Lambda returned site_config instead of success message
                            // This is a special case for legacy support
                            success = true;
                            message = 'Configuration saved and retrieved successfully';
                        } else {
                            message = parsedBody.message || 'No message provided';
                        }
                    } catch (e) {
                        console.error('Error parsing API Gateway response body:', e);
                        throw new Error('Invalid response format from API Gateway');
                    }
                } else {
                    // Direct Lambda response format
                    success = apiData.success === true;
                    message = apiData.message || 'No message provided';
                    
                    // Special case: API returned site_config directly
                    if (apiData.site_config) {
                        success = true;
                        message = 'Configuration saved and data refreshed';
                    }
                }
                
                // Check if the save was successful
                if (!success) {
                    throw new Error(message || 'Save operation failed');
                }

                showSaveMessage('Configuration saved successfully!', 'text-green-500 bg-green-50');
                setTimeout(hideSaveMessage, 3000);

                // Refresh the configuration after saving
                await fetchConfiguration();
            } catch (error) {
                console.error('Error saving configuration:', error);
                showSaveMessage('Error saving configuration: ' + error.message, 'text-red-500 bg-red-50');
                
                // Add retry button
                const retryButton = document.createElement('button');
                retryButton.textContent = 'Retry Save';
                retryButton.className = 'ml-4 px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700';
                retryButton.onclick = () => saveSiteConfig(formData);
                saveMessage.appendChild(retryButton);
            }
        }
        
        // Show save message with appropriate styling
        function showSaveMessage(message, classNames) {
            saveMessage.textContent = message;
            saveMessage.className = 'px-4 py-3 text-center border-t border-b ' + classNames;
            saveMessage.classList.remove('hidden');
        }
        
        // Hide save message
        function hideSaveMessage() {
            saveMessage.classList.add('hidden');
        }
        
        // Event listeners
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
        
        if (siteConfigForm) {
            siteConfigForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(siteConfigForm);
                saveSiteConfig(formData);
            });
        }
        
        // Add refresh button event listener
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', fetchConfiguration);
        }
        
        // Check if user is authenticated
        if (checkAuthentication()) {
            // Load site configuration
            fetchConfiguration();
        }
    });
    </script>
</body>
</html> 
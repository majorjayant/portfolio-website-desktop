<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin Dashboard - Work Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
    // Inline Auth Module - Prevents 404s from external files
    // Check if user is authenticated
    const Auth = {
        getCredentials() {
            return {
                username: localStorage.getItem('adminUsername'),
                password: localStorage.getItem('adminPassword'),
                apiEndpoint: localStorage.getItem('apiEndpoint') || 'https://f7r74v22od.execute-api.us-east-1.amazonaws.com/production'
            };
        },
        
        isAuthenticated() {
            const { username, password } = this.getCredentials();
            return Boolean(username && password);
        },
        
        logout() {
            localStorage.removeItem('adminUsername');
            localStorage.removeItem('adminPassword');
            // Add timestamp to prevent caching
            window.location.href = `login.html?t=${Date.now()}`;
        }
    };
    </script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: all 0.3s;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }
        /* Rich text editor styles */
        .rich-text-editor {
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            min-height: 200px;
        }
        .rich-text-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
        .rich-text-toolbar button {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .rich-text-toolbar button:hover {
            background-color: #f3f4f6;
        }
        .rich-text-content {
            min-height: 150px;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            background-color: #fff;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading indicator -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-3 text-gray-600">Verifying authentication...</p>
        </div>
    </div>

    <!-- Not authenticated message -->
    <div id="not-authenticated" class="hidden fixed inset-0 flex items-center justify-center bg-white z-40">
        <div class="text-center p-6 max-w-sm mx-auto">
            <div class="text-red-500 text-5xl mb-4"><i class="fas fa-lock"></i></div>
            <h2 class="text-2xl font-bold mb-2">Authentication Required</h2>
            <p class="mb-4 text-gray-600">Please log in to access the admin dashboard.</p>
            <button onclick="window.location.href='login.html?t=' + Date.now()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Go to Login
            </button>
        </div>
    </div>

    <!-- Main content (displayed when authenticated) -->
    <div id="authenticated-content" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div class="sidebar bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 z-20">
            <div class="flex items-center justify-between px-3">
                <div class="text-2xl font-semibold">Admin Panel</div>
                <button id="close-sidebar" class="md:hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="mt-10">
                <a href="dashboard.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>
                <a href="site-config.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-cog mr-2"></i>Site Configuration
                </a>
                <a href="work-experience.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded bg-gray-700 transition duration-200">
                    <i class="fas fa-briefcase mr-2"></i>Work Experience
                </a>
                <a href="education.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-graduation-cap mr-2"></i>Education
                </a>
                <a href="certifications.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-certificate mr-2"></i>Certifications
                </a>
                <a href="skills.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-tools mr-2"></i>Skills
                </a>
                <a href="toolkit.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-toolbox mr-2"></i>Toolkit
                </a>
                <a href="projects.html?t=<?= Date.now() ?>" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-project-diagram mr-2"></i>Projects
                </a>
                <div class="border-t border-gray-700 my-4"></div>
                <a href="#" id="logout-button" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-red-400">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-x-auto">
            <header class="bg-white shadow-sm py-4 px-4 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="show-sidebar" class="md:hidden mr-4">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-semibold">Work Experience Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refresh-data" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div id="last-updated" class="text-sm text-gray-500"></div>
                </div>
            </header>

            <main class="container mx-auto px-4 py-6">
                <!-- Work Experience Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Work Experience</h2>
                    <div class="space-y-4">
                        <div id="experience-items-container" class="border border-gray-200 rounded-lg p-4">
                            <!-- Experience items will be generated here -->
                        </div>
                        <button id="add-experience-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-plus mr-1"></i> Add Experience
                        </button>
                        <div class="mt-6 flex justify-end">
                            <button id="save-experience-btn" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                                <i class="fas fa-save mr-1"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript for the admin dashboard -->
    <script>
        // Get credentials from Auth module instead of directly accessing localStorage
        const { username, password, apiEndpoint } = Auth.getCredentials();
        let lastUpdate = new Date();
        let localExperienceData = [];

        // Simple rich text editor implementation
        function initSimpleEditor(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            
            // Create toolbar and content area
            const toolbar = document.createElement('div');
            toolbar.className = 'rich-text-toolbar';
            
            const content = document.createElement('div');
            content.className = 'rich-text-content';
            content.contentEditable = true;
            
            // Get the original textarea
            const textarea = container.querySelector('textarea');
            const initialValue = textarea ? textarea.value : '';
            content.innerHTML = initialValue;
            
            // Create toolbar buttons
            const buttons = [
                { cmd: 'bold', icon: 'fas fa-bold', title: 'Bold' },
                { cmd: 'italic', icon: 'fas fa-italic', title: 'Italic' },
                { cmd: 'underline', icon: 'fas fa-underline', title: 'Underline' },
                { cmd: 'insertUnorderedList', icon: 'fas fa-list-ul', title: 'Bullet List' },
                { cmd: 'insertOrderedList', icon: 'fas fa-list-ol', title: 'Numbered List' },
                { cmd: 'createLink', icon: 'fas fa-link', title: 'Insert Link' },
                { cmd: 'formatBlock', param: 'h2', icon: 'fas fa-heading', title: 'Heading' },
                { cmd: 'formatBlock', param: 'p', icon: 'fas fa-paragraph', title: 'Paragraph' }
            ];
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.type = 'button';
                button.innerHTML = `<i class="${btn.icon}"></i>`;
                button.title = btn.title;
                button.addEventListener('click', () => {
                    if (btn.cmd === 'createLink') {
                        const url = prompt('Enter the URL:');
                        if (url) document.execCommand(btn.cmd, false, url);
                    } else if (btn.param) {
                        document.execCommand(btn.cmd, false, btn.param);
                    } else {
                        document.execCommand(btn.cmd);
                    }
                    // Update the hidden textarea for form submission
                    if (textarea) textarea.value = content.innerHTML;
                });
                toolbar.appendChild(button);
            });
            
            // Update textarea when content changes
            content.addEventListener('input', () => {
                if (textarea) textarea.value = content.innerHTML;
            });
            
            // Clear existing content and append the new editor
            container.innerHTML = '';
            container.appendChild(toolbar);
            container.appendChild(content);
            
            return {
                getContent: () => content.innerHTML,
                setContent: (html) => { content.innerHTML = html; if (textarea) textarea.value = html; },
                setReadOnly: (isReadOnly) => { content.contentEditable = !isReadOnly; }
            };
        }

        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, checking auth status...");
            console.log("Auth status:", Auth.isAuthenticated() ? "Authenticated" : "Not authenticated");
            
            // Remove the timeout delay for immediate verification
            if (!Auth.isAuthenticated()) {
                console.log("Not authenticated, showing login message");
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('not-authenticated').classList.remove('hidden');
            } else {
                console.log("Authenticated, showing dashboard content");
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('authenticated-content').classList.remove('hidden');
                
                // Load data
                fetchExperienceData();
                
                // Update last updated time
                updateLastUpdatedTime();
            }
        });

        // Sidebar toggle for mobile
        document.getElementById('show-sidebar').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.add('active');
        });

        document.getElementById('close-sidebar').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.remove('active');
        });

        // Logout button - use Auth module's logout method
        document.getElementById('logout-button').addEventListener('click', function(e) {
            e.preventDefault();
            Auth.logout();
        });

        // Refresh data button
        document.getElementById('refresh-data').addEventListener('click', function() {
            fetchExperienceData();
        });

        // Add experience button
        document.getElementById('add-experience-btn').addEventListener('click', function() {
            addExperienceItem();
        });

        // Save experience button
        document.getElementById('save-experience-btn').addEventListener('click', function() {
            saveExperienceData();
        });

        // Update last updated time display
        function updateLastUpdatedTime() {
            const timeElement = document.getElementById('last-updated');
            if (timeElement) {
                timeElement.textContent = `Last updated: ${lastUpdate.toLocaleTimeString()}`;
            }
        }

        // Template for experience item
        function addExperienceItem(data = null) {
            const container = document.getElementById('experience-items-container');
            const itemId = `experience-item-${Date.now()}`;
            const isDeleted = false;
            
            // Extract values from data or use defaults
            const positionTitle = data?.positionTitle || '';
            const company = data?.company || '';
            const startDate = data?.startDate || '';
            const endDate = data?.endDate || '';
            const isCurrent = data?.isCurrent || false;
            const description = data?.description || '';
            
            // Create the experience item element
            const itemElement = document.createElement('div');
            itemElement.id = itemId;
            itemElement.className = 'experience-item bg-gray-50 p-4 rounded-lg mb-4';
            itemElement.dataset.deleted = isDeleted ? 'true' : 'false';
            
            // Create the HTML structure
            itemElement.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">${positionTitle || 'New Position'}</h3>
                    <div>
                        <button class="delete-toggle-btn px-2 py-1 bg-red-500 text-white rounded text-sm">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Position Title*</label>
                        <input type="text" class="position-title w-full p-2 border border-gray-300 rounded" value="${positionTitle}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company*</label>
                        <input type="text" class="company w-full p-2 border border-gray-300 rounded" value="${company}" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date*</label>
                        <input type="month" class="start-date w-full p-2 border border-gray-300 rounded" value="${startDate}" required>
                    </div>
                    <div class="end-date-field ${isCurrent ? 'opacity-50' : ''}">
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="month" class="end-date w-full p-2 border border-gray-300 rounded" value="${endDate}" ${isCurrent ? 'disabled' : ''}>
                    </div>
                    <div class="flex items-end">
                        <label class="inline-flex items-center mb-1">
                            <input type="checkbox" class="current-position form-checkbox" ${isCurrent ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-gray-700">Current Position</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description*</label>
                    <div class="editor-container">
                        <textarea class="description w-full p-2 border border-gray-300 rounded min-h-[100px]" ${isDeleted ? 'disabled' : ''}>${description}</textarea>
                    </div>
                </div>
            `;
            
            // Add to container
            container.appendChild(itemElement);
            
            // Add event listeners
            const deleteBtn = itemElement.querySelector('.delete-toggle-btn');
            const currentPositionCheckbox = itemElement.querySelector('.current-position');
            const endDateField = itemElement.querySelector('.end-date-field');
            const endDateInput = itemElement.querySelector('.end-date');
            const positionTitleInput = itemElement.querySelector('.position-title');
            const titleDisplay = itemElement.querySelector('h3');
            
            // Delete button
            deleteBtn.addEventListener('click', function() {
                const isDeleted = itemElement.dataset.deleted === 'true';
                
                if (isDeleted) {
                    // Restore
                    itemElement.dataset.deleted = 'false';
                    itemElement.classList.remove('bg-red-50', 'border-red-200');
                    itemElement.classList.add('bg-gray-50');
                    this.classList.remove('bg-green-500');
                    this.classList.add('bg-red-500');
                    this.innerHTML = '<i class="fas fa-trash mr-1"></i> Delete';
                    
                    // Enable all inputs
                    itemElement.querySelectorAll('input, textarea').forEach(input => {
                        input.disabled = false;
                    });
                    
                    // Re-check if current position is checked
                    if (currentPositionCheckbox.checked) {
                        endDateInput.disabled = true;
                    }
                } else {
                    // Delete
                    itemElement.dataset.deleted = 'true';
                    itemElement.classList.remove('bg-gray-50');
                    itemElement.classList.add('bg-red-50', 'border-red-200');
                    this.classList.remove('bg-red-500');
                    this.classList.add('bg-green-500');
                    this.innerHTML = '<i class="fas fa-undo mr-1"></i> Restore';
                    
                    // Disable all inputs
                    itemElement.querySelectorAll('input, textarea').forEach(input => {
                        input.disabled = true;
                    });
                }
            });
            
            // Current position checkbox
            currentPositionCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    endDateInput.disabled = true;
                    endDateField.classList.add('opacity-50');
                } else {
                    endDateInput.disabled = false;
                    endDateField.classList.remove('opacity-50');
                }
            });
            
            // Update title display when position title changes
            positionTitleInput.addEventListener('input', function() {
                titleDisplay.textContent = this.value || 'New Position';
            });
            
            // Initialize the rich text editor
            initSimpleEditor(`#${itemId} .editor-container`);
        }

        function getExperienceData() {
            const items = document.querySelectorAll('.experience-item');
            const experienceData = [];
            
            items.forEach(item => {
                const isDeleted = item.dataset.deleted === 'true';
                
                // Skip if marked for deletion
                if (isDeleted) return;
                
                const positionTitle = item.querySelector('.position-title').value.trim();
                const company = item.querySelector('.company').value.trim();
                const startDate = item.querySelector('.start-date').value;
                const isCurrent = item.querySelector('.current-position').checked;
                let endDate = '';
                if (!isCurrent) {
                    endDate = item.querySelector('.end-date').value;
                }
                
                // Get content from editor
                const editorContainer = item.querySelector('.editor-container');
                const editorContent = editorContainer.querySelector('.rich-text-content');
                let description = '';
                
                if (editorContent) {
                    description = editorContent.innerHTML;
                } else {
                    description = item.querySelector('textarea.description').value.trim();
                }
                
                // Validate required fields
                if (!positionTitle || !company || !startDate || !description) {
                    console.error('Missing required fields in experience item');
                    return;
                }
                
                experienceData.push({
                    positionTitle,
                    company,
                    startDate,
                    endDate,
                    isCurrent,
                    description
                });
            });
            
            return experienceData;
        }

        function loadExperienceData(data) {
            // Clear existing items
            const container = document.getElementById('experience-items-container');
            container.innerHTML = '';
            
            // Add each experience item
            if (data && data.length > 0) {
                data.forEach(item => {
                    addExperienceItem(item);
                });
            } else {
                // If no data, add an empty experience item
                addExperienceItem();
            }
        }

        function fetchExperienceData() {
            const url = `${apiEndpoint}/api/work-experience`;
            
            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Basic ${btoa(`${username}:${password}`)}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                localExperienceData = data;
                loadExperienceData(data);
                lastUpdate = new Date();
                updateLastUpdatedTime();
            })
            .catch(error => {
                console.error('Error fetching work experience data:', error);
                // Try to load from localStorage as fallback
                const savedData = localStorage.getItem('workExperienceData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        localExperienceData = parsedData;
                        loadExperienceData(parsedData);
                    } catch (e) {
                        console.error('Error parsing saved work experience data:', e);
                    }
                }
            })
            .finally(() => {
                // Hide loading indicator
                document.getElementById('loading').classList.add('hidden');
            });
        }

        function saveExperienceData() {
            const experienceData = getExperienceData();
            
            // Validate data
            if (!experienceData || experienceData.length === 0) {
                alert('No valid experience data to save. Please check required fields.');
                return;
            }
            
            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');
            
            // Save to API
            const url = `${apiEndpoint}/api/work-experience`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${btoa(`${username}:${password}`)}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(experienceData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                alert('Work experience data saved successfully!');
                // Update local data and UI
                localExperienceData = experienceData;
                localStorage.setItem('workExperienceData', JSON.stringify(experienceData));
                lastUpdate = new Date();
                updateLastUpdatedTime();
                
                // Refresh data from server
                fetchExperienceData();
            })
            .catch(error => {
                console.error('Error saving work experience data:', error);
                alert('Error saving work experience data. Please try again later.');
                
                // Save locally as fallback
                localStorage.setItem('workExperienceData', JSON.stringify(experienceData));
            })
            .finally(() => {
                // Hide loading indicator
                document.getElementById('loading').classList.add('hidden');
            });
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Work Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        accent: '#8b5cf6',
                        dark: '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: all 0.3s;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }
        .tox-tinymce {
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Loading indicator -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-3 text-gray-600">Verifying authentication...</p>
        </div>
    </div>

    <!-- Not authenticated message -->
    <div id="not-authenticated" class="hidden fixed inset-0 flex items-center justify-center bg-white z-40">
        <div class="text-center p-6 max-w-sm mx-auto">
            <div class="text-red-500 text-5xl mb-4"><i class="fas fa-lock"></i></div>
            <h2 class="text-2xl font-bold mb-2">Authentication Required</h2>
            <p class="mb-4 text-gray-600">Please log in to access the admin dashboard.</p>
            <button onclick="window.location.href='login.html'" class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-600">
                Go to Login
            </button>
        </div>
    </div>

    <!-- Main content (displayed when authenticated) -->
    <div id="authenticated-content" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div class="sidebar bg-dark text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 z-20">
            <div class="flex items-center justify-between px-3">
                <div class="text-2xl font-semibold">Admin Panel</div>
                <button id="close-sidebar" class="md:hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="mt-10">
                <a href="dashboard.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>
                <a href="site-config.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-cog mr-2"></i>Site Configuration
                </a>
                <a href="work-experience.html" class="block py-2.5 px-4 rounded bg-gray-700 transition duration-200">
                    <i class="fas fa-briefcase mr-2"></i>Work Experience
                </a>
                <a href="education.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-graduation-cap mr-2"></i>Education
                </a>
                <a href="certifications.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-certificate mr-2"></i>Certifications
                </a>
                <a href="skills.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-tools mr-2"></i>Skills
                </a>
                <a href="toolkit.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-toolbox mr-2"></i>Toolkit
                </a>
                <a href="projects.html" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-project-diagram mr-2"></i>Projects
                </a>
                <div class="border-t border-gray-700 my-4"></div>
                <a href="#" id="logout-button" class="block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 text-red-400">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-x-auto">
            <header class="bg-white shadow-sm py-4 px-4 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="show-sidebar" class="md:hidden mr-4">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-semibold">Work Experience Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refresh-data" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div id="last-updated" class="text-sm text-gray-500"></div>
                </div>
            </header>

            <main class="container mx-auto px-4 py-6">
                <!-- Work Experience Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Work Experience</h2>
                    <div class="space-y-4">
                        <div id="experience-items-container" class="border border-gray-200 rounded-lg p-4">
                            <!-- Experience items will be generated here -->
                        </div>
                        <button id="add-experience-btn" class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-plus mr-1"></i> Add Experience
                        </button>
                        <div class="mt-6 flex justify-end">
                            <button id="save-experience-btn" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                                <i class="fas fa-save mr-1"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript for the admin dashboard -->
    <script>
        let username = localStorage.getItem('adminUsername');
        let password = localStorage.getItem('adminPassword');
        let apiEndpoint = localStorage.getItem('apiEndpoint') || 'https://f7r74v22od.execute-api.us-east-1.amazonaws.com/production';
        let lastUpdate = new Date();
        let localExperienceData = [];

        // Authentication check
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!username || !password) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('not-authenticated').classList.remove('hidden');
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('authenticated-content').classList.remove('hidden');
                    
                    // Load data
                    fetchExperienceData();
                    
                    // Update last updated time
                    updateLastUpdatedTime();
                }
            }, 1000);
        });

        // Sidebar toggle for mobile
        document.getElementById('show-sidebar').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.add('active');
        });

        document.getElementById('close-sidebar').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.remove('active');
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('adminUsername');
            localStorage.removeItem('adminPassword');
            window.location.href = 'login.html';
        });

        // Refresh data button
        document.getElementById('refresh-data').addEventListener('click', function() {
            fetchExperienceData();
        });

        // Add experience button
        document.getElementById('add-experience-btn').addEventListener('click', function() {
            addExperienceItem();
        });

        // Save experience button
        document.getElementById('save-experience-btn').addEventListener('click', function() {
            saveExperienceData();
        });

        // Update the last updated time
        function updateLastUpdatedTime() {
            const timeElement = document.getElementById('last-updated');
            timeElement.textContent = `Last updated: ${lastUpdate.toLocaleTimeString()}`;
        }

        // Experience Items Functions
        function addExperienceItem(data = null) {
            const container = document.getElementById('experience-items-container');
            const itemId = `experience-item-${Date.now()}`;
            
            let isDeleted = data && data.isDeleted ? true : false;
            let positionTitle = data ? data.positionTitle : '';
            let company = data ? data.company : '';
            let startDate = data ? data.startDate : '';
            let endDate = data ? data.endDate : '';
            let isCurrent = data && data.isCurrent ? true : false;
            let description = data ? data.description : '';
            
            const newItem = document.createElement('div');
            newItem.className = `experience-item mb-4 p-4 border ${isDeleted ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'} rounded-lg`;
            newItem.id = itemId;
            newItem.dataset.deleted = isDeleted;
            
            newItem.innerHTML = `
                <div class="flex justify-between mb-2">
                    <h3 class="text-lg font-semibold">${isDeleted ? 'Marked for Deletion' : 'Experience Details'}</h3>
                    <button class="delete-toggle-btn text-sm px-2 py-1 rounded ${isDeleted ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                        ${isDeleted ? '<i class="fas fa-undo mr-1"></i> Restore' : '<i class="fas fa-trash mr-1"></i> Delete'}
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Position Title*</label>
                        <input type="text" class="position-title w-full p-2 border border-gray-300 rounded" value="${positionTitle}" ${isDeleted ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company*</label>
                        <input type="text" class="company w-full p-2 border border-gray-300 rounded" value="${company}" ${isDeleted ? 'disabled' : ''}>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date*</label>
                        <input type="date" class="start-date w-full p-2 border border-gray-300 rounded" value="${startDate}" ${isDeleted ? 'disabled' : ''}>
                    </div>
                    <div class="end-date-container ${isCurrent ? 'hidden' : ''}">
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" class="end-date w-full p-2 border border-gray-300 rounded" value="${endDate}" ${isDeleted ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="flex items-center mt-6">
                            <input type="checkbox" class="current-position mr-2 h-4 w-4" ${isCurrent ? 'checked' : ''} ${isDeleted ? 'disabled' : ''}>
                            <span class="text-sm font-medium text-gray-700">Current Position</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description*</label>
                    <textarea class="description w-full p-2 border border-gray-300 rounded min-h-[100px] tinymce-editor" ${isDeleted ? 'disabled' : ''}>${description}</textarea>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // Initialize TinyMCE on the new description field
            initTinyMCE(`#${itemId} .tinymce-editor`);
            
            // Setup event listeners for the new item
            const deleteToggleBtn = newItem.querySelector('.delete-toggle-btn');
            deleteToggleBtn.addEventListener('click', function() {
                toggleDeleteExperienceItem(itemId);
            });
            
            const currentCheckbox = newItem.querySelector('.current-position');
            currentCheckbox.addEventListener('change', function() {
                const endDateContainer = newItem.querySelector('.end-date-container');
                if (this.checked) {
                    endDateContainer.classList.add('hidden');
                } else {
                    endDateContainer.classList.remove('hidden');
                }
            });
        }

        function toggleDeleteExperienceItem(itemId) {
            const item = document.getElementById(itemId);
            const isCurrentlyDeleted = item.dataset.deleted === 'true';
            
            // Toggle the deleted status
            item.dataset.deleted = !isCurrentlyDeleted;
            
            // Update the UI
            if (!isCurrentlyDeleted) {
                // Mark as deleted
                item.classList.remove('bg-gray-50', 'border-gray-200');
                item.classList.add('bg-red-50', 'border-red-200');
                item.querySelector('h3').textContent = 'Marked for Deletion';
                
                const deleteBtn = item.querySelector('.delete-toggle-btn');
                deleteBtn.classList.remove('bg-red-500');
                deleteBtn.classList.add('bg-green-500');
                deleteBtn.innerHTML = '<i class="fas fa-undo mr-1"></i> Restore';
                
                // Disable all inputs
                item.querySelectorAll('input, textarea').forEach(input => {
                    input.disabled = true;
                });
                
                // Disable TinyMCE if it's initialized
                const editorId = item.querySelector('.tinymce-editor').id;
                if (editorId && tinymce.get(editorId)) {
                    tinymce.get(editorId).setMode('readonly');
                }
            } else {
                // Restore
                item.classList.remove('bg-red-50', 'border-red-200');
                item.classList.add('bg-gray-50', 'border-gray-200');
                item.querySelector('h3').textContent = 'Experience Details';
                
                const deleteBtn = item.querySelector('.delete-toggle-btn');
                deleteBtn.classList.remove('bg-green-500');
                deleteBtn.classList.add('bg-red-500');
                deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> Delete';
                
                // Enable all inputs
                item.querySelectorAll('input, textarea').forEach(input => {
                    input.disabled = false;
                });
                
                // Enable TinyMCE if it's initialized
                const editorId = item.querySelector('.tinymce-editor').id;
                if (editorId && tinymce.get(editorId)) {
                    tinymce.get(editorId).setMode('design');
                }
            }
        }

        function initTinyMCE(selector) {
            tinymce.init({
                selector: selector,
                height: 200,
                menubar: false,
                plugins: 'lists link code',
                toolbar: 'undo redo | formatselect | bold italic | bullist numlist | link | code',
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }'
            });
        }

        function getExperienceData() {
            const items = document.querySelectorAll('.experience-item');
            const experienceData = [];
            
            items.forEach(item => {
                const isDeleted = item.dataset.deleted === 'true';
                
                // Skip if marked for deletion
                if (isDeleted) return;
                
                const positionTitle = item.querySelector('.position-title').value.trim();
                const company = item.querySelector('.company').value.trim();
                const startDate = item.querySelector('.start-date').value;
                const isCurrent = item.querySelector('.current-position').checked;
                let endDate = '';
                if (!isCurrent) {
                    endDate = item.querySelector('.end-date').value;
                }
                
                // Get content from TinyMCE
                const textareaId = item.querySelector('.tinymce-editor').id;
                let description = '';
                if (textareaId && tinymce.get(textareaId)) {
                    description = tinymce.get(textareaId).getContent();
                } else {
                    description = item.querySelector('.description').value.trim();
                }
                
                // Validate required fields
                if (!positionTitle || !company || !startDate || !description) {
                    console.error('Missing required fields in experience item');
                    return;
                }
                
                experienceData.push({
                    positionTitle,
                    company,
                    startDate,
                    endDate,
                    isCurrent,
                    description
                });
            });
            
            return experienceData;
        }

        function loadExperienceData(data) {
            // Clear existing items
            const container = document.getElementById('experience-items-container');
            container.innerHTML = '';
            
            // Add each experience item
            if (data && data.length > 0) {
                data.forEach(item => {
                    addExperienceItem(item);
                });
            } else {
                // If no data, add an empty experience item
                addExperienceItem();
            }
        }

        function fetchExperienceData() {
            const url = `${apiEndpoint}/api/work-experience`;
            
            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Basic ${btoa(`${username}:${password}`)}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                localExperienceData = data;
                loadExperienceData(data);
                lastUpdate = new Date();
                updateLastUpdatedTime();
            })
            .catch(error => {
                console.error('Error fetching work experience data:', error);
                // Try to load from localStorage as fallback
                const savedData = localStorage.getItem('workExperienceData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        localExperienceData = parsedData;
                        loadExperienceData(parsedData);
                    } catch (e) {
                        console.error('Error parsing saved work experience data:', e);
                    }
                }
            })
            .finally(() => {
                // Hide loading indicator
                document.getElementById('loading').classList.add('hidden');
            });
        }

        function saveExperienceData() {
            const experienceData = getExperienceData();
            
            // Validate data
            if (!experienceData || experienceData.length === 0) {
                alert('No valid experience data to save. Please check required fields.');
                return;
            }
            
            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');
            
            // Save to API
            const url = `${apiEndpoint}/api/work-experience`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${btoa(`${username}:${password}`)}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(experienceData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                alert('Work experience data saved successfully!');
                // Update local data and UI
                localExperienceData = experienceData;
                localStorage.setItem('workExperienceData', JSON.stringify(experienceData));
                lastUpdate = new Date();
                updateLastUpdatedTime();
                
                // Refresh data from server
                fetchExperienceData();
            })
            .catch(error => {
                console.error('Error saving work experience data:', error);
                alert('Error saving work experience data. Please try again later.');
                
                // Save locally as fallback
                localStorage.setItem('workExperienceData', JSON.stringify(experienceData));
            })
            .finally(() => {
                // Hide loading indicator
                document.getElementById('loading').classList.add('hidden');
            });
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin-dashboard.css">
    <style>
        /* Styles for collapsible sections */
        .section-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        
        .section-header:hover {
            background-color: #f3f4f6;
        }
        
        .section-header .icon {
            transition: transform 0.3s ease;
        }
        
        .section-header.collapsed .icon {
            transform: rotate(-90deg);
        }
        
        .section-content {
            transition: max-height 0.5s ease, opacity 0.5s ease, padding 0.5s ease;
            max-height: 10000px; /* Start expanded */
            opacity: 1;
            overflow: hidden;
        }
        
        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
        
        .marked-for-deletion {
            background-color: #fee2e2 !important;
            position: relative;
        }
        
        .marked-for-deletion::after {
            content: "Marked for deletion";
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen bg-gray-100">
        <!-- Authentication check -->
        <div id="auth-loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-lg text-gray-600">Verifying authentication...</p>
            </div>
        </div>
        
        <!-- Not Authenticated Message -->
        <div id="not-authenticated" class="hidden fixed inset-0 flex items-center justify-center bg-white z-50">
            <div class="text-center">
                <div class="text-red-600 text-6xl mb-4">⚠️</div>
                <p class="text-lg text-gray-800 mb-4">You need to log in to access this page</p>
                <a href="/admin/login" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Go to Login
                </a>
            </div>
        </div>
        
        <!-- API Error Message -->
        <div id="api-error" class="hidden fixed top-4 right-4 p-4 bg-red-100 text-red-700 rounded-md shadow-md z-40">
            Error loading data. Please try again later.
        </div>
        
        <!-- Dashboard Content (hidden until authenticated) -->
        <div id="dashboard-content" class="hidden">
            <!-- Navigation -->
            <nav class="bg-indigo-600 shadow">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex">
                            <div class="flex-shrink-0 flex items-center">
                                <span class="text-white text-xl font-bold">Admin Dashboard</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <a href="/admin" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-indigo-700">
                                Admin Home
                            </a>
                            <button id="logout-button" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-indigo-700 hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="section-header mb-4" data-section="site-config">
                                <h2 class="text-lg leading-6 font-medium text-gray-900">
                                    Site Configuration
                                </h2>
                                <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                            <div id="loading-indicator" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                                <p class="text-gray-500">Loading configuration...</p>
                            </div>
                            <div id="form-container" class="hidden mt-4">
                                <form id="site-config-form" class="space-y-6">
                                    <div class="section-content" data-parent="site-config">
                                        <div class="section-header pl-0" data-section="general-info">
                                            <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">General Website Information</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="general-info">
                                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                                <!-- Site Title -->
                                                <div>
                                                    <label for="about_title" class="block text-sm font-medium text-gray-700">Site Title</label>
                                                    <input type="text" id="about_title" name="about_title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Subtitle -->
                                                <div>
                                                    <label for="about_subtitle" class="block text-sm font-medium text-gray-700">Subtitle</label>
                                                    <input type="text" id="about_subtitle" name="about_subtitle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Description -->
                                                <div class="sm:col-span-2">
                                                    <label for="about_description" class="block text-sm font-medium text-gray-700">Description</label>
                                                    <textarea id="about_description" name="about_description" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="section-content" data-parent="site-config">
                                        <div class="section-header pl-0" data-section="website-images">
                                            <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">Website Images</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="website-images">
                                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                                <!-- Favicon URL -->
                                                <div>
                                                    <label for="image_favicon_url" class="block text-sm font-medium text-gray-700">Favicon URL</label>
                                                    <input type="text" id="image_favicon_url" name="image_favicon_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">URL for the website favicon (browser tab icon)</p>
                                                </div>
                                                
                                                <!-- Logo URL -->
                                                <div>
                                                    <label for="image_logo_url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                                                    <input type="text" id="image_logo_url" name="image_logo_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">URL for the website logo</p>
                                                </div>
                                                
                                                <!-- Banner URL -->
                                                <div>
                                                    <label for="image_banner_url" class="block text-sm font-medium text-gray-700">Banner URL</label>
                                                    <input type="text" id="image_banner_url" name="image_banner_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">URL for the website banner image</p>
                                                </div>
                                                
                                                <!-- Mobile Banner URL -->
                                                <div>
                                                    <label for="image_mobile_banner_url" class="block text-sm font-medium text-gray-700">Mobile Banner URL</label>
                                                    <input type="text" id="image_mobile_banner_url" name="image_mobile_banner_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">URL for the mobile version of the banner image</p>
                                                </div>
                                                
                                                <!-- Profile Image URL -->
                                                <div>
                                                    <label for="image_about_profile_url" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                                                    <input type="text" id="image_about_profile_url" name="image_about_profile_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">URL for your main profile photo</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-content" data-parent="site-config">
                                        <div class="section-header pl-0" data-section="gallery-photos">
                                            <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">Gallery Photos</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="gallery-photos">
                                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                                <!-- Photo 1 URL -->
                                                <div>
                                                    <label for="image_about_photo1_url" class="block text-sm font-medium text-gray-700">Photo 1 URL</label>
                                                    <input type="text" id="image_about_photo1_url" name="image_about_photo1_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Photo 1 Alt Text -->
                                                <div>
                                                    <label for="about_photo1_alt" class="block text-sm font-medium text-gray-700">Photo 1 Alt Text</label>
                                                    <input type="text" id="about_photo1_alt" name="about_photo1_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                                </div>
                                                
                                                <!-- Photo 2 URL -->
                                                <div>
                                                    <label for="image_about_photo2_url" class="block text-sm font-medium text-gray-700">Photo 2 URL</label>
                                                    <input type="text" id="image_about_photo2_url" name="image_about_photo2_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Photo 2 Alt Text -->
                                                <div>
                                                    <label for="about_photo2_alt" class="block text-sm font-medium text-gray-700">Photo 2 Alt Text</label>
                                                    <input type="text" id="about_photo2_alt" name="about_photo2_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                                </div>
                                                
                                                <!-- Photo 3 URL -->
                                                <div>
                                                    <label for="image_about_photo3_url" class="block text-sm font-medium text-gray-700">Photo 3 URL</label>
                                                    <input type="text" id="image_about_photo3_url" name="image_about_photo3_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Photo 3 Alt Text -->
                                                <div>
                                                    <label for="about_photo3_alt" class="block text-sm font-medium text-gray-700">Photo 3 Alt Text</label>
                                                    <input type="text" id="about_photo3_alt" name="about_photo3_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                                </div>
                                                
                                                <!-- Photo 4 URL -->
                                                <div>
                                                    <label for="image_about_photo4_url" class="block text-sm font-medium text-gray-700">Photo 4 URL</label>
                                                    <input type="text" id="image_about_photo4_url" name="image_about_photo4_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                </div>
                                                
                                                <!-- Photo 4 Alt Text -->
                                                <div>
                                                    <label for="about_photo4_alt" class="block text-sm font-medium text-gray-700">Photo 4 Alt Text</label>
                                                    <input type="text" id="about_photo4_alt" name="about_photo4_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Work Experience -->
                                    <div class="section-content mb-8" data-parent="site-config">
                                        <div class="section-header" data-section="work-experience">
                                            <h3 class="text-lg font-medium text-gray-900">Work Experience</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="work-experience">
                                            <div id="work-experience-container" class="space-y-6">
                                                <!-- Work experience items will be dynamically added here -->
                                                <p id="work-experience-loading" class="text-gray-500">Loading work experience...</p>
                                            </div>
                                            <div class="mt-4">
                                                <button type="button" id="add-work-experience-button" class="inline-flex items-center px-4 py-2 border border-indigo-600 text-sm font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                    <svg class="-ml-1 mr-2 h-5 w-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    Add Work Experience
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Education -->
                                    <div class="section-content mb-8" data-parent="site-config">
                                        <div class="section-header" data-section="education">
                                            <h3 class="text-lg font-medium text-gray-900">Education</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="education">
                                            <div id="education-container" class="space-y-6">
                                                <!-- Education items will be dynamically added here -->
                                                <p id="education-loading-message" class="text-gray-500">Loading education...</p>
                                            </div>
                                            <div class="mt-4">
                                                <button type="button" id="add-education-button" class="inline-flex items-center px-4 py-2 border border-indigo-600 text-sm font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                    <svg class="-ml-1 mr-2 h-5 w-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    Add Education
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Certifications -->
                                    <div class="section-content mb-8" data-parent="site-config">
                                        <div class="section-header" data-section="certifications">
                                            <h3 class="text-lg font-medium text-gray-900">Certifications</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="certifications">
                                            <div id="certifications-container" class="space-y-6">
                                                <!-- Certification items will be dynamically added here -->
                                                <p id="certifications-loading-message" class="text-gray-500">Loading certifications...</p>
                                            </div>
                                            <div class="mt-4">
                                                <button type="button" id="add-certification-button" class="inline-flex items-center px-4 py-2 border border-indigo-600 text-sm font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                    <svg class="-ml-1 mr-2 h-5 w-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                    </svg>
                                                    Add Certification
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Skills -->
                                    <div class="section-content mb-8" data-parent="site-config">
                                        <div class="section-header" data-section="skills">
                                            <h3 class="text-lg font-medium text-gray-900">Skills</h3>
                                            <svg class="icon h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                        <div class="section-content" data-parent="skills">
                                            <!-- Key Metrics Section -->
                                            <div class="mb-6">
                                                <div class="section-header" data-section="key-metrics">
                                                    <h4 class="text-md font-medium text-gray-800 mb-2">Key Metrics</h4>
                                                    <svg class="icon h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="section-content" data-parent="key-metrics">
                                                    <p class="text-sm text-gray-500 mb-3">Add metrics like years of experience, projects completed, etc.</p>
                                                    <div id="key-metrics-container" class="space-y-3">
                                                        <!-- Key metrics items will be dynamically added here -->
                                                        <p id="key-metrics-loading-message" class="text-gray-500">Loading key metrics...</p>
                                                    </div>
                                                    <button type="button" id="add-key-metric-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                        <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Add Metric
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Skills Proficiency Section -->
                                            <div class="mb-6">
                                                <div class="section-header" data-section="skills-proficiency">
                                                    <h4 class="text-md font-medium text-gray-800 mb-2">Skills Proficiency</h4>
                                                    <svg class="icon h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="section-content" data-parent="skills-proficiency">
                                                    <p class="text-sm text-gray-500 mb-3">Add skills with proficiency percentages.</p>
                                                    <div id="skills-proficiency-container" class="space-y-3">
                                                        <!-- Skills proficiency items will be dynamically added here -->
                                                        <p id="skills-proficiency-loading-message" class="text-gray-500">Loading skills proficiency...</p>
                                                    </div>
                                                    <button type="button" id="add-skill-proficiency-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                        <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Add Skill
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Areas of Expertise Section -->
                                            <div class="mb-6">
                                                <div class="section-header" data-section="areas-of-expertise">
                                                    <h4 class="text-md font-medium text-gray-800 mb-2">Areas of Expertise</h4>
                                                    <svg class="icon h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="section-content" data-parent="areas-of-expertise">
                                                    <p class="text-sm text-gray-500 mb-3">Add your areas of expertise grouped by categories.</p>
                                                    <div id="expertise-container" class="space-y-3">
                                                        <!-- Expertise items will be dynamically added here -->
                                                        <p id="expertise-loading-message" class="text-gray-500">Loading areas of expertise...</p>
                                                    </div>
                                                    <button type="button" id="add-expertise-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                        <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Add Expertise Item
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Toolkit Section -->
                                            <div class="mb-6">
                                                <div class="section-header" data-section="toolkit">
                                                    <h4 class="text-md font-medium text-gray-800 mb-2">Toolkit</h4>
                                                    <svg class="icon h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="section-content" data-parent="toolkit">
                                                    <!-- Toolkit Categories -->
                                                    <div class="mb-4">
                                                        <h5 class="text-sm font-medium text-gray-700 mb-2">Categories</h5>
                                                        <div id="toolkit-categories-container" class="space-y-3">
                                                            <!-- Toolkit category items will be dynamically added here -->
                                                            <p id="toolkit-categories-loading-message" class="text-gray-500">Loading toolkit categories...</p>
                                                        </div>
                                                        <button type="button" id="add-toolkit-category-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                            <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                            </svg>
                                                            Add Category
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Toolkit Items -->
                                                    <div>
                                                        <h5 class="text-sm font-medium text-gray-700 mb-2">Items</h5>
                                                        <div id="toolkit-items-container" class="space-y-3">
                                                            <!-- Toolkit items will be dynamically added here -->
                                                            <p id="toolkit-items-loading-message" class="text-gray-500">Loading toolkit items...</p>
                                                        </div>
                                                        <button type="button" id="add-toolkit-item-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                            <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                            </svg>
                                                            Add Item
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Domain Experience Section -->
                                            <div class="mb-6">
                                                <div class="section-header" data-section="domain-experience">
                                                    <h4 class="text-md font-medium text-gray-800 mb-2">Domain Experience</h4>
                                                    <svg class="icon h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="section-content" data-parent="domain-experience">
                                                    <p class="text-sm text-gray-500 mb-3">Add your experience across different domains/industries.</p>
                                                    <div id="domain-experience-container" class="space-y-3">
                                                        <!-- Domain experience items will be dynamically added here -->
                                                        <p id="domain-experience-loading-message" class="text-gray-500">Loading domain experience...</p>
                                                    </div>
                                                    <button type="button" id="add-domain-experience-button" class="mt-3 inline-flex items-center px-3 py-1 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                        <svg class="-ml-0.5 mr-1 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                        </svg>
                                                        Add Domain Experience
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Template for new work experience items -->
                                    <template id="work-experience-template">
                                        <div class="work-experience-item bg-gray-50 rounded-md p-4 my-4 border border-gray-200">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-base font-medium text-gray-800">Work Experience Entry</h4>
                                                <button type="button" class="delete-work-experience text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <input type="hidden" class="workex-id" name="workex_id">
                                            
                                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                                                <!-- Job Title -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">Job Title</label>
                                                    <input type="text" class="workex-title mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                </div>
                                                
                                                <!-- Company Name -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">Company Name</label>
                                                    <input type="text" class="workex-company mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                </div>
                                                
                                                <!-- Location -->
                                                <div class="sm:col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700">Location</label>
                                                    <input type="text" class="workex-location mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                                </div>
                                                
                                                <!-- Date Range -->
                                                <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700">From Date</label>
                                                        <input type="month" class="workex-from-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700">To Date</label>
                                                        <input type="month" class="workex-to-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                                    </div>

                                                    <div class="flex items-center pb-2">
                                                        <input type="checkbox" class="workex-current h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                                        <label class="ml-2 block text-sm text-gray-700">Current Job</label>
                                                    </div>
                                                </div>
                                                
                                                <!-- Description / Responsibilities -->
                                                <div class="sm:col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700">Description / Responsibilities</label>
                                                    <textarea class="workex-description mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" rows="3" required></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div class="mt-6 flex justify-between items-center">
                                        <button type="button" id="refresh-button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                            </svg>
                                            Refresh Data
                                        </button>
                                        <button type="submit" id="save-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                                
                                <!-- Ensure rich text editors are initialized -->
                                <script>
                                    // Initialize rich text toolbars when the form becomes visible
                                    const observer = new MutationObserver(function(mutations) {
                                        mutations.forEach(function(mutation) {
                                            if (mutation.target.style.display !== 'none' && !mutation.target.classList.contains('hidden')) {
                                                console.log('Form container visible, initializing rich text editors');
                                                initRichTextToolbars();
                                            }
                                        });
                                    });
                                    
                                    // Start observing the form container
                                    const formContainer = document.getElementById('form-container');
                                    if (formContainer) {
                                        observer.observe(formContainer, { attributes: true, attributeFilter: ['style', 'class'] });
                                    }
                                    
                                    // Also try to initialize on page load
                                    document.addEventListener('DOMContentLoaded', function() {
                                        console.log('DOM loaded, trying to initialize rich text editors');
                                        setTimeout(initRichTextToolbars, 500);
                                    });
                                    
                                    // Add the missing initRichTextToolbars function
                                    function initRichTextToolbars() {
                                        console.log('Initializing rich text toolbars');
                                        
                                        // Find all textarea elements that need rich text editing
                                        const richTextAreas = document.querySelectorAll('textarea[data-rich-text="true"]');
                                        
                                        // If no textareas with rich text attribute are found, look for description fields
                                        if (richTextAreas.length === 0) {
                                            // Add toolbar to work experience description fields
                                            const workExDescriptions = document.querySelectorAll('.workex-description');
                                            workExDescriptions.forEach(textarea => {
                                                createToolbarForElement(textarea);
                                            });
                                            
                                            // Add toolbar to about description field if it exists
                                            const aboutDescription = document.getElementById('about_description');
                                            if (aboutDescription) {
                                                createToolbarForElement(aboutDescription);
                                            }
                                        } else {
                                            // Add toolbar to explicitly marked rich text areas
                                            richTextAreas.forEach(textarea => {
                                                createToolbarForElement(textarea);
                                            });
                                        }
                                    }
                                    
                                    // Helper function to create a toolbar for a specific element
                                    function createToolbarForElement(element) {
                                        // Skip if element already has a toolbar
                                        if (element.parentNode.querySelector('.rich-text-toolbar')) {
                                            return;
                                        }
                                        
                                        // Create toolbar container
                                        const toolbar = document.createElement('div');
                                        toolbar.className = 'rich-text-toolbar';
                                        toolbar.dataset.for = element.id;
                                        
                                        // Define buttons for the toolbar
                                        const buttons = [
                                            { icon: '<b>B</b>', title: 'Bold', action: 'b' },
                                            { icon: '<i>I</i>', title: 'Italic', action: 'i' },
                                            { icon: '<u>U</u>', title: 'Underline', action: 'u' },
                                            { icon: 'P', title: 'Paragraph', action: 'p' },
                                            { icon: 'H1', title: 'Heading 1', action: 'h1' },
                                            { icon: 'H2', title: 'Heading 2', action: 'h2' },
                                            { icon: 'BR', title: 'Line Break', action: 'br' },
                                            { icon: 'Link', title: 'Insert Link', action: 'link' },
                                            { icon: 'List', title: 'Bulleted List', action: 'ul' }
                                        ];
                                        
                                        // Create buttons
                                        buttons.forEach(btn => {
                                            const button = document.createElement('button');
                                            button.type = 'button';
                                            button.innerHTML = btn.icon;
                                            button.title = btn.title;
                                            button.className = 'tooltip';
                                            button.addEventListener('click', function() {
                                                insertTag(element.id, btn.action);
                                            });
                                            toolbar.appendChild(button);
                                        });
                                        
                                        // Insert toolbar before the element
                                        element.parentNode.insertBefore(toolbar, element);
                                    }
                                    
                                    // Function to insert HTML tags in textareas
                                    function insertTag(elementId, tag) {
                                        const textarea = document.getElementById(elementId);
                                        if (!textarea) return;
                                        
                                        const start = textarea.selectionStart;
                                        const end = textarea.selectionEnd;
                                        const selectedText = textarea.value.substring(start, end);
                                        let insertedText = '';
                                        
                                        // Handle different tag types
                                        switch(tag) {
                                            case 'b':
                                                insertedText = `<b>${selectedText}</b>`;
                                                break;
                                            case 'i':
                                                insertedText = `<i>${selectedText}</i>`;
                                                break;
                                            case 'u':
                                                insertedText = `<u>${selectedText}</u>`;
                                                break;
                                            case 'p':
                                                insertedText = `<p>${selectedText}</p>`;
                                                break;
                                            case 'h1':
                                                insertedText = `<h1>${selectedText}</h1>`;
                                                break;
                                            case 'h2':
                                                insertedText = `<h2>${selectedText}</h2>`;
                                                break;
                                            case 'br':
                                                insertedText = `${selectedText}<br>`;
                                                break;
                                            case 'link':
                                                const url = prompt('Enter URL:', 'https://');
                                                if (url) {
                                                    insertedText = `<a href="${url}" target="_blank">${selectedText || url}</a>`;
                                                }
                                                break;
                                            case 'ul':
                                                if (selectedText) {
                                                    // If there's already a line break in the selection, create list items
                                                    if (selectedText.includes('\n')) {
                                                        const items = selectedText.split('\n').filter(item => item.trim() !== '');
                                                        const listItems = items.map(item => `  <li>${item.trim()}</li>`).join('\n');
                                                        insertedText = `<ul>\n${listItems}\n</ul>`;
                                                    } else {
                                                        insertedText = `<ul>\n  <li>${selectedText}</li>\n</ul>`;
                                                    }
                                                } else {
                                                    insertedText = `<ul>\n  <li>List item</li>\n</ul>`;
                                                }
                                                break;
                                            default:
                                                return;
                                        }
                                        
                                        // Insert the new text
                                        textarea.focus();
                                        textarea.value = textarea.value.substring(0, start) + insertedText + textarea.value.substring(end);
                                        
                                        // Set cursor position after insertion
                                        const newCursorPos = start + insertedText.length;
                                        textarea.setSelectionRange(newCursorPos, newCursorPos);
                                        
                                        // Trigger change event to ensure form state updates
                                        const event = new Event('change', { bubbles: true });
                                        textarea.dispatchEvent(event);
                                    }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader mb-3 w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700">Saving changes...</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin dashboard loaded');
        
        const authLoading = document.getElementById('auth-loading');
        const notAuthenticated = document.getElementById('not-authenticated');
        const dashboardContent = document.getElementById('dashboard-content');
        const logoutButton = document.getElementById('logout-button');
        const siteConfigForm = document.getElementById('site-config-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const formContainer = document.getElementById('form-container');
        const apiError = document.getElementById('api-error');
        const saveButton = document.getElementById('save-button');
        
        // Check authentication
        checkAuth();
        
        // Insert HTML tags for formatting text fields
        function insertTag(fieldId, tag) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            const start = field.selectionStart;
            const end = field.selectionEnd;
            const currentValue = field.value;
            const selectedText = currentValue.substring(start, end);

            let newValue;
            let cursorPosition = start; // Default cursor position

            if (tag === 'br') {
                // Insert <br> tag at cursor position
                newValue = currentValue.substring(0, start) + '<br>' + currentValue.substring(end);
                cursorPosition = start + 4; // Move cursor after <br>
            } else if (tag === 'h1' || tag === 'h2' || tag === 'h3' || tag === 'h4' || tag === 'p') {
                // Block level elements
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                if (selectedText) {
                    // Wrap selection
                    newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                    cursorPosition = end + openTag.length + closeTag.length; // Move cursor after the wrapped text
                } else {
                    // Insert empty tags at cursor
                    newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                    cursorPosition = start + openTag.length; // Move cursor between the tags
                }
            } else if (tag === 'color') {
                // Insert color tag with a default color
                const colorCode = prompt('Enter a color code (hex, rgb, or color name):', '#3366cc');
                if (colorCode) {
                    const openTag = `<span style="color:${colorCode};">`;
                    const closeTag = `</span>`;
                    if (selectedText) {
                        // Wrap selection with color
                        newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                        cursorPosition = end + openTag.length + closeTag.length;
                    } else {
                        // Insert empty color tags
                        newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                        cursorPosition = start + openTag.length;
                    }
                } else {
                    return; // User canceled color input
                }
            } else if (tag === 'link') {
                // Insert link tag
                const url = prompt('Enter the URL:', 'https://');
                if (url) {
                    const linkText = selectedText || 'link text';
                    const fullLink = `<a href="${url}" target="_blank">${linkText}</a>`;
                    newValue = currentValue.substring(0, start) + fullLink + currentValue.substring(end);
                    cursorPosition = start + fullLink.length;
                } else {
                    return; // User canceled URL input
                }
            } else if (tag === 'ul' || tag === 'ol') {
                // Handle lists
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                const liText = selectedText || 'List item';
                const liItems = liText.split('\n').map(item => `<li>${item.trim()}</li>`).join('\n  ');
                
                newValue = currentValue.substring(0, start) + 
                          openTag + '\n  ' + liItems + '\n' + closeTag + 
                          currentValue.substring(end);
                          
                cursorPosition = start + openTag.length + 1;
            } else {
                // Inline elements (b, i, u, etc.)
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                if (selectedText) {
                    // Wrap selection
                    newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                    cursorPosition = end + openTag.length + closeTag.length; // Move cursor after the wrapped text
                } else {
                    // Insert empty tags at cursor
                    newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                    cursorPosition = start + openTag.length; // Move cursor between the tags
                }
            }

            field.value = newValue;
            // Set focus and cursor position
            field.focus();
            field.selectionStart = cursorPosition;
            field.selectionEnd = cursorPosition;
        }
        
        // Function to create a rich text toolbar for any element
        function createRichTextToolbar(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`Container with ID ${containerId} not found for toolbar creation`);
                return;
            }
            
            // Check if a toolbar already exists
            const existingToolbar = container.parentNode.querySelector('.rich-text-toolbar[data-for="' + containerId + '"]');
            if (existingToolbar) {
                console.log(`Toolbar already exists for ${containerId}, skipping creation`);
                return;
            }
            
            console.log(`Creating rich text toolbar for ${containerId}`);
            
            const toolbar = document.createElement('div');
            toolbar.className = 'flex flex-wrap items-center space-x-1 mb-1 rich-text-toolbar';
            toolbar.setAttribute('data-for', containerId);
            
            // Text formatting
            toolbar.innerHTML = `
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="b" title="Bold">B</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs italic rounded hover:bg-gray-300 tooltip" data-tag="i" title="Italic">I</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs underline rounded hover:bg-gray-300 tooltip" data-tag="u" title="Underline">U</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Headings and paragraph -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h1" title="Heading 1">H1</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h2" title="Heading 2">H2</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h3" title="Heading 3">H3</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="p" title="Paragraph">¶</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Lists -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="ul" title="Bullet List">• List</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="ol" title="Numbered List">1. List</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Additional formatting -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="color" title="Text Color">
                    <span style="color: #3366cc">A</span>
                </button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="link" title="Insert Link">
                    <span style="text-decoration: underline; color: blue;">🔗</span>
                </button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="br" title="Line Break">↵</button>
            `;
            
            // Add event listeners to buttons
            toolbar.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    const tag = this.dataset.tag;
                    if (tag) {
                        insertTag(containerId, tag);
                    }
                });
            });
            
            // Insert the toolbar right before the target element
            container.parentNode.insertBefore(toolbar, container);
            
            console.log(`Toolbar created for ${containerId}`);
        }
        
        // Initialize rich text toolbars for specific fields when the page loads
        function initRichTextToolbars() {
            console.log('Initializing rich text toolbars');
            
            // Main content fields
            const richTextFields = [
                'about_title', 
                'about_subtitle', 
                'about_description'
            ];
            
            richTextFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    console.log(`Creating toolbar for ${fieldId}`);
                    // Remove any existing toolbar first
                    const existingToolbar = field.parentNode.querySelector('.rich-text-toolbar');
                    if (existingToolbar) {
                        existingToolbar.remove();
                    }
                    createRichTextToolbar(fieldId);
                } else {
                    console.warn(`Field ${fieldId} not found`);
                }
            });
            
            // Work experience fields
            const workExFields = document.querySelectorAll('.workex-title, .workex-company, .workex-location, .workex-description');
            workExFields.forEach(field => {
                if (field.id && !field.parentNode.querySelector('.rich-text-toolbar')) {
                    console.log(`Creating work ex toolbar for ${field.id}`);
                    createRichTextToolbar(field.id);
                } else if (!field.id) {
                    // Generate an ID if missing
                    field.id = `workex-field-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                    console.log(`Generated ID and creating toolbar: ${field.id}`);
                    createRichTextToolbar(field.id);
                }
            });
            
            console.log('Rich text toolbar initialization complete');
        }
        
        function checkAuth() {
            console.log('Checking authentication');
            
            const token = localStorage.getItem('admin_token');
            console.log('Auth token:', token ? 'Found' : 'Not found');
            
            // Short delay to ensure the page loads properly
            setTimeout(() => {
                authLoading.classList.add('hidden');
                
                if (!token) {
                    console.log('No token found, showing not authenticated message');
                    notAuthenticated.classList.remove('hidden');
                    return;
                }
                
                // Token found, show dashboard
                console.log('Token found, showing dashboard');
                dashboardContent.classList.remove('hidden');
                loadSiteConfig();
            }, 1000);
        }
        
        function redirectToLogin() {
            window.location.href = '/admin/login';
        }
        
        // Logout handler
        logoutButton.addEventListener('click', function() {
            console.log('Logging out');
            localStorage.removeItem('admin_token');
            dashboardContent.classList.add('hidden');
            notAuthenticated.classList.remove('hidden');
        });
        
        // Load site configuration
        function loadSiteConfig() {
            console.log('Loading site configuration');
            
            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            formContainer.classList.add('hidden');
            
            // Use the confirmed working API endpoint
            const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=site_config';
            
            console.log('Fetching from API endpoint:', apiEndpoint);
            
            // Fetch site config data from the API
            fetch(apiEndpoint)
                .then(response => response.json())
            .then(data => {
                console.log('Successfully loaded site config from API:', data);
                
                // Hide loading indicator and show form
                loadingIndicator.classList.add('hidden');
                formContainer.classList.remove('hidden');
                
                // Fix: Pass the site_config object instead of the entire response
                populateForm(data.site_config);
                
                // Load work experience data if available
                if (data.work_experience) {
                    loadWorkExperienceData(data.work_experience);
                } else {
                    // Fetch work experience data separately if not included in site config
                    fetchWorkExperienceData();
                }
                    
                    // Load education data if available
                    if (data.education) {
                        loadEducationData(data.education);
                    } else {
                        // Fetch education data separately if not included in site config
                        fetchEducationData();
                    }
                    
                    // Load certification data if available
                    if (data.certifications) {
                        loadCertificationData(data.certifications);
                    } else {
                        // Fetch certification data separately if not included in site config
                        fetchCertificationData();
                    }
                    
                    // Load skills data if available
                    if (data.skills) {
                        // Load Key Metrics
                        if (data.skills.key_metrics) {
                            loadKeyMetricsData(data.skills.key_metrics);
                        } else {
                            addKeyMetricItem();
                        }
                        
                        // Load Skills Proficiency
                        if (data.skills.skills_proficiency) {
                            loadSkillProficiencyData(data.skills.skills_proficiency);
                        } else {
                            addSkillProficiencyItem();
                        }
                        
                        // Load Areas of Expertise
                        if (data.skills.areas_of_expertise) {
                            loadExpertiseData(data.skills.areas_of_expertise);
                        } else {
                            addExpertiseItem();
                        }
                        
                        // Load Toolkit Categories
                        if (data.skills.toolkit_categories) {
                            loadToolkitCategoriesData(data.skills.toolkit_categories);
                        } else {
                            addToolkitCategoryItem();
                        }
                        
                        // Load Toolkit Items
                        if (data.skills.toolkit_items) {
                            loadToolkitItemsData(data.skills.toolkit_items);
                        } else {
                            addToolkitItem();
                        }
                        
                        // Load Domain Experience
                        if (data.skills.domain_experience) {
                            loadDomainExperienceData(data.skills.domain_experience);
                        } else {
                            addDomainExperienceItem();
                        }
                    } else {
                        // Initialize empty skills sections
                        addKeyMetricItem();
                        addSkillProficiencyItem();
                        addExpertiseItem();
                        addToolkitCategoryItem();
                        addToolkitItem();
                        addDomainExperienceItem();
                }
            })
            .catch(error => {
                    console.error('Error loading data from API:', error);
                
                    // Hide loading indicator and show form
                loadingIndicator.classList.add('hidden');
                    formContainer.classList.remove('hidden');
                
                // Show error message
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) {
                        errorMessage.textContent = 'Error loading data. Please try refreshing the page.';
                        errorMessage.classList.remove('hidden');
                    }
                    
                    // Try to load site config from local file
                    fetch('/data/config.json')
                    .then(response => response.json())
                        .then(configData => {
                        populateForm(configData);
                        })
                        .catch(err => {
                            console.error('Error loading site config from local JSON:', err);
                        });
                        
                        // Try to load work experience data from local file
                        fetch('/data/experience.json')
                            .then(response => response.json())
                            .then(expData => {
                                loadWorkExperienceData(expData);
                            })
                            .catch(err => {
                                console.error('Error loading work experience from local JSON:', err);
                                // Add empty work experience item
                                addWorkExperienceItem();
                            });
                        
                    // Try to load education data from local file
                    fetch('/data/education.json')
                        .then(response => response.json())
                        .then(eduData => {
                            loadEducationData(eduData);
                        })
                        .catch(err => {
                            console.error('Error loading education from local JSON:', err);
                            // Add empty education item
                            addEducationItem();
                        });
                        
                    // Try to load certification data from local file
                    fetch('/data/certifications.json')
                        .then(response => response.json())
                        .then(certData => {
                            loadCertificationData(certData);
                        })
                        .catch(err => {
                            console.error('Error loading certifications from local JSON:', err);
                            // Add empty certification item
                            addCertificationItem();
                        });
                        
                    // Initialize empty skills sections
                    addKeyMetricItem();
                    addSkillProficiencyItem();
                    addExpertiseItem();
                    addToolkitCategoryItem();
                    addToolkitItem();
                    addDomainExperienceItem();
            });
        }
        
        // Populate form with site config data
        function populateForm(data) {
            console.log('Populating form with data:', data);
            
            // Populate simple text inputs
            document.getElementById('about_title').value = data.about_title || '';
            document.getElementById('about_subtitle').value = data.about_subtitle || '';
            document.getElementById('about_description').value = data.about_description || '';
            
            // Populate image URLs
            document.getElementById('image_favicon_url').value = data.image_favicon_url || '';
            document.getElementById('image_logo_url').value = data.image_logo_url || '';
            document.getElementById('image_banner_url').value = data.image_banner_url || '';
            document.getElementById('image_mobile_banner_url').value = data.image_mobile_banner_url || '';
            document.getElementById('image_about_profile_url').value = data.image_about_profile_url || '';
            
            // Populate gallery photos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`image_about_photo${i}_url`).value = data[`image_about_photo${i}_url`] || '';
                document.getElementById(`about_photo${i}_alt`).value = data[`about_photo${i}_alt`] || '';
            }
        }
        
        // Get form data
        function getFormData() {
            const formData = {};
            
            // Get simple text inputs
            formData.about_title = document.getElementById('about_title').value;
            formData.about_subtitle = document.getElementById('about_subtitle').value;
            formData.about_description = document.getElementById('about_description').value;
            
            // Get image URLs
            formData.image_favicon_url = document.getElementById('image_favicon_url').value;
            formData.image_logo_url = document.getElementById('image_logo_url').value;
            formData.image_banner_url = document.getElementById('image_banner_url').value;
            formData.image_mobile_banner_url = document.getElementById('image_mobile_banner_url').value;
            formData.image_about_profile_url = document.getElementById('image_about_profile_url').value;
            
            // Get gallery photos
            for (let i = 1; i <= 4; i++) {
                formData[`image_about_photo${i}_url`] = document.getElementById(`image_about_photo${i}_url`).value;
                formData[`about_photo${i}_alt`] = document.getElementById(`about_photo${i}_alt`).value;
            }
            
            return formData;
        }
        
        // Handle form submission
        siteConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            // Get the site config data
            const siteConfigData = getFormData();
            
            // Get the work experience data
            const workExperienceData = getWorkExperienceData();
            
            // Get education data
            const educationData = getEducationData();
            
            // Get certification data
            const certificationData = getCertificationData();
            
            // Get skills data
            const keyMetricsData = getKeyMetricsData();
            const skillProficiencyData = getSkillProficiencyData();
            const expertiseData = getExpertiseData();
            const toolkitCategoriesData = getToolkitCategoriesData();
            const toolkitItemsData = getToolkitItemsData();
            const domainExperienceData = getDomainExperienceData();
            
            // Validate skills data
            if (keyMetricsData === null || skillProficiencyData === null || expertiseData === null || 
                toolkitCategoriesData === null || toolkitItemsData === null || domainExperienceData === null) {
                console.error('Skills validation errors found');
                return; // Don't submit if there are validation errors
            }

            // Validate for required work experience fields
            const workExValidation = document.querySelectorAll('.workex-validation-error');
            if (workExValidation.length > 0) {
                console.error('Work experience validation errors found:', workExValidation.length);
                // Focus the first error
                workExValidation[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Don't submit if there are validation errors
            }
            
            // Validate for required education fields
            const eduValidation = document.querySelectorAll('.education-validation-error');
            if (eduValidation.length > 0) {
                console.error('Education validation errors found:', eduValidation.length);
                // Focus the first error
                eduValidation[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Don't submit if there are validation errors
            }
            
            // Validate for required certification fields
            const certValidation = document.querySelectorAll('.certification-validation-error');
            if (certValidation.length > 0) {
                console.error('Certification validation errors found:', certValidation.length);
                // Focus the first error
                certValidation[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Don't submit if there are validation errors
            }

            // Construct the data object to send
            const dataToSend = {
                site_config: siteConfigData,
                work_experience: workExperienceData,
                education: educationData,
                certifications: certificationData,
                skills: {
                    key_metrics: keyMetricsData,
                    skills_proficiency: skillProficiencyData,
                    areas_of_expertise: expertiseData,
                    toolkit_categories: toolkitCategoriesData,
                    toolkit_items: toolkitItemsData,
                    domain_experience: domainExperienceData
                }
            };

            console.log('Data to send:', dataToSend);
            
            // Show saving indicator
            const savingIndicator = document.getElementById('saving-indicator');
            const formActions = document.getElementById('form-actions');
            
            if (savingIndicator && formActions) {
                savingIndicator.classList.remove('hidden');
                formActions.classList.add('hidden');
            }
            
            // Send the data to the backend
            const apiUrl = '/api/save_config_all';
            
            fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                console.log('Response received:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                    
                    // Show success message
                const successMessage = document.getElementById('success-message');
                if (successMessage) {
                    successMessage.classList.remove('hidden');
                    
                    // Hide success message after 5 seconds
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                    }, 5000);
                }
                
                // Hide saving indicator and show form actions
                if (savingIndicator && formActions) {
                    savingIndicator.classList.add('hidden');
                    formActions.classList.remove('hidden');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                
                // Show error message
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.classList.remove('hidden');
                    
                    // Hide error message after 5 seconds
                setTimeout(() => {
                        errorMessage.classList.add('hidden');
                }, 5000);
                }
                
                // Hide saving indicator and show form actions
                if (savingIndicator && formActions) {
                    savingIndicator.classList.add('hidden');
                    formActions.classList.remove('hidden');
                }
            });
        });

        // Work Experience Functions
        function initWorkExperience() {
            console.log('Initializing work experience section');
            
            // Add event listener to the "Add Work Experience" button
            const addWorkExButton = document.getElementById('add-work-experience');
            if (addWorkExButton) {
                addWorkExButton.addEventListener('click', function() {
                    addWorkExperienceItem();
                });
            }
            
            // Initialize "current" checkbox behavior for existing items
            initCurrentCheckboxBehavior();
        }
        
        async function loadWorkExperienceData(existingData = null) {
            console.log('Loading work experience data...');
            
            // Re-query elements each time to ensure they are found
            const container = document.getElementById('work-experience-container');
            const loadingMsg = document.getElementById('work-experience-loading');
            
            if (!container) {
                console.error('Work experience container (#work-experience-container) not found! Cannot update UI.');
                return; // Exit if container is missing
            }
            if (!loadingMsg) {
                console.warn('Work experience loading message (#work-experience-loading) not found. Proceeding without it.');
            } else {
                 // Show loading message only if found
                 loadingMsg.style.display = 'block';
            }
            
            try {
                // Clear existing items from the container
                container.innerHTML = '';
                
                let experienceData = existingData;
                
                // If no existing data was provided, try to fetch it
                if (!experienceData) {
                    try {
                        // Use the same API endpoint as the site config but with work_experience type
                        const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=work_experience';
                        
                        const response = await fetch(apiEndpoint, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API request failed with status ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('Received work experience data from separate API call:', data);
                        experienceData = data.work_experience || data;
                    } catch (fetchError) {
                        console.error('Error fetching work experience data:', fetchError);
                    }
                }
                
                const items = experienceData && Array.isArray(experienceData) ? experienceData : [];

                if (items.length > 0) {
                     // Log the complete structure of the first item (if it exists)
                     console.log('First work experience item structure:', JSON.stringify(items[0], null, 2));
                    
                    // Sort items by from_date in descending order (newest first)
                    items.sort((a, b) => {
                        const dateA = a.from_date ? new Date(a.from_date) : new Date(0);
                        const dateB = b.from_date ? new Date(b.from_date) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    // Add each work experience item to the container
                    items.forEach(item => {
                        console.log('Adding work experience item:', item);
                        addWorkExperienceItem(null, item);
                    });
                    
                } else {
                    console.log('No work experience data found or data is not an array, adding empty item');
                    addWorkExperienceItem(null); // Add an empty item if no data
                }
            } catch (error) {
                console.error('Error processing work experience data:', error);
                // Attempt to add an empty item even if there's an error during processing
                 if (container) {
                     container.innerHTML = ''; // Clear potentially broken state
                     addWorkExperienceItem(null);
                     // Show error message within the container
                     const errorMsg = document.createElement('p');
                     errorMsg.className = 'error-message';
                     errorMsg.textContent = 'Failed to load or process work experience data. Displaying empty item.';
                     container.appendChild(errorMsg);
                 }
            } finally {
                // Hide loading message only if it was found initially
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
            }
        }
        
        function addWorkExperienceItem(e, data = {}) {
            if (e) e.preventDefault();
            
            console.log('Adding work experience item with data:', data);
            // Debug the entire work experience object
            console.log('Data object structure:', JSON.stringify(data, null, 2));
            
            const container = document.getElementById('work-experience-container');
            if (!container) {
                console.error('Work experience container not found');
                return;
            }
            
            const workExItem = document.createElement('div');
            workExItem.className = 'workex-item';
            workExItem.dataset.id = data.id || '';
            
            // Debug log to see what's in the job_title field
            console.log('Job title from data:', data.job_title);
            console.log('Company name from data:', data.company);
            
            // Create job title field
            const titleLabel = document.createElement('label');
            titleLabel.textContent = 'Job Title*:';
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'workex-title';
            titleInput.id = `workex-title-${Date.now()}`; // Unique ID for toolbar
            titleInput.required = true;
            titleInput.value = data.job_title || '';
            titleInput.placeholder = 'e.g. Software Engineer';
            
            // Create company name field
            const companyLabel = document.createElement('label');
            companyLabel.textContent = 'Company*:';
            const companyInput = document.createElement('input');
            companyInput.type = 'text';
            companyInput.className = 'workex-company';
            companyInput.id = `workex-company-${Date.now()}`; // Unique ID for toolbar
            companyInput.required = true;
            companyInput.value = data.company || '';
            companyInput.placeholder = 'e.g. Tech Company Inc.';
            
            // Create location field
            const locationLabel = document.createElement('label');
            locationLabel.textContent = 'Location:';
            const locationInput = document.createElement('input');
            locationInput.type = 'text';
            locationInput.className = 'workex-location';
            locationInput.id = `workex-location-${Date.now()}`; // Unique ID for toolbar
            locationInput.value = data.location || '';
            locationInput.placeholder = 'e.g. New York, NY';
            
            // Create dates container
            const datesContainer = document.createElement('div');
            datesContainer.className = 'workex-dates';
            
            // From date field
            const fromLabel = document.createElement('label');
            fromLabel.textContent = 'From:';
            const fromInput = document.createElement('input');
            fromInput.type = 'date';
            fromInput.className = 'workex-from-date';
            fromInput.value = data.from_date || '';
            
            // To date field
            const toLabel = document.createElement('label');
            toLabel.textContent = 'To:';
            const toInput = document.createElement('input');
            toInput.type = 'date';
            toInput.className = 'workex-to-date';
            toInput.value = data.to_date || '';
            
            // Current job checkbox
            const currentContainer = document.createElement('div');
            currentContainer.className = 'workex-current';
            const currentLabel = document.createElement('label');
            currentLabel.textContent = 'Current Job:';
            const currentInput = document.createElement('input');
            currentInput.type = 'checkbox';
            currentInput.className = 'workex-is-current';
            currentInput.checked = !!data.is_current;
            
            // Add event listener to disable to_date if current job is checked
            currentInput.addEventListener('change', function() {
                toInput.disabled = this.checked;
                if (this.checked) {
                    toInput.value = '';
                }
            });
            
            // Set initial state of to_date based on is_current
            toInput.disabled = currentInput.checked;
            
            // Add date fields to date container
            datesContainer.appendChild(fromLabel);
            datesContainer.appendChild(fromInput);
            datesContainer.appendChild(toLabel);
            datesContainer.appendChild(toInput);
            currentContainer.appendChild(currentLabel);
            currentContainer.appendChild(currentInput);
            datesContainer.appendChild(currentContainer);
            
            // Create description field
            const descLabel = document.createElement('label');
            descLabel.textContent = 'Description:';
            const descInput = document.createElement('textarea');
            descInput.className = 'workex-description';
            descInput.id = `workex-desc-${Date.now()}`; // Unique ID for toolbar
            descInput.value = data.description || '';
            descInput.placeholder = 'Describe your responsibilities and achievements...';
            descInput.rows = 4;
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'workex-delete-btn';
            deleteBtn.textContent = 'Delete';
            
            // Add a hidden input to track deletion status
            const deletedInput = document.createElement('input');
            deletedInput.type = 'hidden';
            deletedInput.className = 'workex-is-deleted';
            // Initialize based on DB state if available (should always be 0 when adding)
            deletedInput.value = '0'; 
            workExItem.appendChild(deletedInput);

            // Modify the delete button's event listener
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Mark this item for deletion? It will be removed when you save changes.')) {
                    // Mark as deleted by setting the hidden input value
                    const hiddenDeleteInput = workExItem.querySelector('.workex-is-deleted');
                    if (hiddenDeleteInput) {
                        hiddenDeleteInput.value = '1';
                    }
                    // Add a visual cue 
                    workExItem.classList.add('marked-for-deletion');
                    
                    // Disable fields and change button state
                    workExItem.querySelectorAll('input:not([type="hidden"]), textarea').forEach(el => {
                       el.disabled = true;
                    });
                    deleteBtn.textContent = 'Marked for Deletion';
                    deleteBtn.disabled = true;
                    console.log(`Marked item ID ${workExItem.dataset.id || '(new)'} for deletion.`);
                }
            });
            
            // Add fields to work experience item
            workExItem.appendChild(titleLabel);
            workExItem.appendChild(titleInput);
            workExItem.appendChild(companyLabel);
            workExItem.appendChild(companyInput);
            workExItem.appendChild(locationLabel);
            workExItem.appendChild(locationInput);
            workExItem.appendChild(datesContainer);
            workExItem.appendChild(descLabel);
            workExItem.appendChild(descInput);
            workExItem.appendChild(deleteBtn);
            
            // Add work experience item to container
            container.appendChild(workExItem);
            
            // Create formatting toolbars for rich text fields
            createRichTextToolbar(titleInput.id);
            createRichTextToolbar(companyInput.id);
            createRichTextToolbar(locationInput.id);
            createRichTextToolbar(descInput.id);
            
            return workExItem;
        }
        
        function initCurrentCheckboxBehavior() {
            // Find checkboxes within the dynamically added .workex-item elements
            const checkboxes = document.querySelectorAll('.workex-item .workex-is-current'); 
            checkboxes.forEach(checkbox => {
                // Find the parent .workex-item and then the date input within it
                const parentItem = checkbox.closest('.workex-item'); 
                if (!parentItem) return; // Skip if parent item not found
                
                const toDateInput = parentItem.querySelector('.workex-to-date');
                if (toDateInput) {
                    // Set initial state
                    if (checkbox.checked) {
                        toDateInput.disabled = true;
                        toDateInput.value = ''; // Clear value when disabled
                    } else {
                        toDateInput.disabled = false; 
                    }
                    
                    // Add change listener
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            toDateInput.disabled = true;
                            toDateInput.value = ''; // Clear value when disabled
                        } else {
                            toDateInput.disabled = false;
                        }
                    });
                }
            });
        }
        
        function getWorkExperienceData() {
            const workExItems = document.querySelectorAll('.workex-item');
            const data = [];
            
            workExItems.forEach(item => {
                const jobTitle = item.querySelector('.workex-title')?.value || '';
                const company = item.querySelector('.workex-company')?.value || '';
                
                // Do NOT skip items marked for deletion, we need to send their status
                // if (!jobTitle.trim() || !company.trim()) {
                //    console.log('Skipping work experience item with empty required fields');
                //    return;
                // }
                
                // Build work experience data object with correct field names
                const workExData = {
                    id: item.dataset.id || '',
                    job_title: jobTitle,
                    company_name: company,
                    location: item.querySelector('.workex-location')?.value || '',
                    from_date: item.querySelector('.workex-from-date')?.value || '',
                    to_date: item.querySelector('.workex-to-date')?.value || '',
                    is_current: item.querySelector('.workex-is-current')?.checked || false,
                    description: item.querySelector('.workex-description')?.value || '',
                    // Add the deletion status from the hidden input
                    is_deleted: parseInt(item.querySelector('.workex-is-deleted')?.value || '0', 10) // Default to 0 if not found
                };
                
                // Only include items if they have required fields OR are marked for deletion
                if ((jobTitle.trim() && company.trim()) || workExData.is_deleted === 1) {
                    console.log('Created work experience data object:', workExData);
                    data.push(workExData);
                } else {
                    console.log('Skipping item with empty required fields that is NOT marked for deletion:', item.dataset.id);
                }
            });
            
            console.log('Collected work experience data:', data);
            return data;
        }

        // Initialize work experience function on load
        initWorkExperience();

        // Add refresh button event listener
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                console.log('Refreshing data');
                // Show loading indicator
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (formContainer) formContainer.classList.add('hidden');
                
                // Load configuration again
                loadSiteConfig();
            });
        }

        // Education Functions
        function initEducation() {
            console.log('Initializing education section');
            
            // Add event listener to the "Add Education" button
            const addEduButton = document.getElementById('add-education-button');
            if (addEduButton) {
                addEduButton.addEventListener('click', function() {
                    addEducationItem();
                });
            }
        }
        
        function addEducationItem(itemData = {}, index = Date.now()) {
            console.log('Adding education item:', itemData);
            const container = document.getElementById('education-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'education-item bg-gray-50 rounded-md p-4 my-4 border border-gray-200';
            itemDiv.dataset.id = itemData.id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            itemDiv.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-base font-medium text-gray-800">Education Entry</h4>
                    <button type="button" class="delete-education text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="education-id" name="education_id" value="${itemData.id || ''}">
                <input type="hidden" class="education-is-deleted" name="education_is_deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                    <!-- Degree Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Degree Name*</label>
                        <input type="text" class="education-title mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.edu_title || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Institution Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Institution Name*</label>
                        <input type="text" class="education-name mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.edu_name || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Location -->
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" class="education-location mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                            value="${itemData.location || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">From Date*</label>
                            <input type="date" class="education-from-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                                value="${itemData.from_date || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">To Date</label>
                            <input type="date" class="education-to-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                                value="${itemData.to_date || ''}" ${(itemData.is_current || parseInt(itemData.is_deleted || 0) === 1) ? 'disabled' : ''}>
                        </div>

                        <div class="flex items-center pb-2">
                            <input type="checkbox" class="education-current h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                ${itemData.is_current ? 'checked' : ''} ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                            <label class="ml-2 block text-sm text-gray-700">Currently Enrolled</label>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(itemDiv);
            
            // Hide the loading message if it exists
            const loadingMsg = document.getElementById('education-loading-message');
            if (loadingMsg) {
                loadingMsg.classList.add('hidden');
            }
            
            // Add event listener for the current checkbox
            const currentCheckbox = itemDiv.querySelector('.education-current');
            const toDateInput = itemDiv.querySelector('.education-to-date');
            
            if (currentCheckbox && toDateInput) {
                currentCheckbox.addEventListener('change', function() {
                    toDateInput.disabled = this.checked;
                    if (this.checked) {
                        toDateInput.value = '';
                    }
                });
            }
            
            // Add event listener for the delete button
            const deleteButton = itemDiv.querySelector('.delete-education');
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    const isDeletedInput = itemDiv.querySelector('.education-is-deleted');
                    
                    // Toggle the deletion state
                    const isCurrentlyDeleted = parseInt(isDeletedInput.value || '0') === 1;
                    isDeletedInput.value = isCurrentlyDeleted ? '0' : '1';
                    
                    // Update visual indicators and disable inputs
                    if (!isCurrentlyDeleted) {
                        // Mark for deletion
                        itemDiv.classList.add('marked-for-deletion');
                        deleteButton.innerHTML = 'Marked for Deletion';
                        
                        // Disable all inputs in this item
                        itemDiv.querySelectorAll('input:not(.education-is-deleted), textarea').forEach(input => {
                            input.disabled = true;
                        });
                    } else {
                        // Unmark from deletion
                        itemDiv.classList.remove('marked-for-deletion');
                        deleteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        `;
                        
                        // Re-enable all inputs except the "to date" if "current" is checked
                        itemDiv.querySelectorAll('input:not(.education-is-deleted), textarea').forEach(input => {
                            if (input.classList.contains('education-to-date') && currentCheckbox.checked) {
                                input.disabled = true;
                            } else {
                                input.disabled = false;
                            }
                        });
                    }
                });
            }
        }
        
        // Get education data from the form
        function getEducationData() {
            const educationItems = document.querySelectorAll('.education-item');
            const data = [];
            
            educationItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.education-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.education-id').value || null;
                const eduTitle = item.querySelector('.education-title').value;
                const eduName = item.querySelector('.education-name').value;
                const location = item.querySelector('.education-location').value;
                const fromDate = item.querySelector('.education-from-date').value;
                const toDate = item.querySelector('.education-to-date').value;
                const isCurrent = item.querySelector('.education-current').checked;
                
                // Skip validation for items marked for deletion
                if (isDeleted === 0) {
                    // Basic validation for required fields
                    let isValid = true;
                    
                    if (!eduTitle) {
                        item.querySelector('.education-title').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-title').classList.remove('border-red-500');
                    }
                    
                    if (!eduName) {
                        item.querySelector('.education-name').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-name').classList.remove('border-red-500');
                    }
                    
                    if (!fromDate) {
                        item.querySelector('.education-from-date').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-from-date').classList.remove('border-red-500');
                    }
                    
                    if (!isValid) {
                        console.error('Education item has validation errors');
                        item.classList.add('education-validation-error');
                    } else {
                        item.classList.remove('education-validation-error');
                    }
                }
                
                // Create an education object
                const educationObject = {
                    id: id,
                    edu_title: eduTitle,
                    edu_name: eduName,
                    location: location,
                    from_date: fromDate || null,
                    to_date: isCurrent ? null : (toDate || null),
                    is_current: isCurrent,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(educationObject);
            });
            
            return data;
        }
        
        // Load education data into the form
        function loadEducationData(educationItems) {
            console.log('Loading education data:', educationItems);
            
            // Get the container
            const container = document.getElementById('education-items-container');
            if (!container) {
                console.error('Education container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no education items, add an empty one
            if (!educationItems || educationItems.length === 0) {
                addEducationItem();
                return;
            }
            
            // Otherwise, add each item to the form
            educationItems.forEach(item => addEducationItem(item));
        }
        
        // Fetch education data separately if needed
        async function fetchEducationData() {
            console.log('Fetching education data separately');
            
            try {
                const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=education';
                
                const response = await fetch(apiEndpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`API response not OK: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Successfully loaded education data:', data);
                
                // Load the education data
                loadEducationData(data.education || []);
            } catch (error) {
                console.error('Error fetching education data:', error);
                
                // Try loading from local JSON as fallback
                try {
                    const localResponse = await fetch('/data/education.json');
                    const localData = await localResponse.json();
                    loadEducationData(localData);
                } catch (localError) {
                    console.error('Error loading from local education JSON:', localError);
                    // Add an empty education item
                    addEducationItem();
                }
            }
        }

        // Initialize education function on load
        initEducation();
        
        // Initialize skills function on load
        initSkills();
        
        // Initialize certifications function on load
        initCertifications();
        
        // Skills Functions
        function initSkills() {
            console.log('Initializing skills section');
            
            // Add event listeners to the "Add" buttons
            document.getElementById('add-key-metric-button').addEventListener('click', function() {
                addKeyMetricItem();
            });
            
            document.getElementById('add-skill-proficiency-button').addEventListener('click', function() {
                addSkillProficiencyItem();
            });
            
            document.getElementById('add-expertise-button').addEventListener('click', function() {
                addExpertiseItem();
            });
            
            document.getElementById('add-toolkit-category-button').addEventListener('click', function() {
                const newCategory = addToolkitCategoryItem();
                // Update dropdowns after adding a new category
                setTimeout(() => {
                    updateToolkitItemCategoryDropdowns();
                }, 100);
            });
            
            document.getElementById('add-toolkit-item-button').addEventListener('click', function() {
                addToolkitItem();
            });
            
            document.getElementById('add-domain-experience-button').addEventListener('click', function() {
                addDomainExperienceItem();
            });
        }
        
        // Key Metrics Functions
        function addKeyMetricItem(itemData = {}, index = Date.now()) {
            console.log('Adding key metric item:', itemData);
            const container = document.getElementById('key-metrics-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('key-metrics-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'key-metric-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.metric_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the key metric item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Key Metric</h5>
                    <button type="button" class="delete-key-metric-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="key-metric-id" value="${itemData.metric_id || ''}">
                <input type="hidden" class="key-metric-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Metric Name <span class="text-red-500">*</span></label>
                        <input type="text" class="key-metric-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.metric_name || ''}" required>
                        <div class="key-metric-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Metric Value <span class="text-red-500">*</span></label>
                        <input type="text" class="key-metric-value mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.metric_value || ''}" required>
                        <div class="key-metric-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Display Order</label>
                        <input type="number" class="key-metric-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            itemDiv.querySelector('.delete-key-metric-btn').addEventListener('click', function() {
                toggleDeleteKeyMetricItem(itemDiv);
            });
            
            // Add event listeners for validation
            const requiredInputs = itemDiv.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateKeyMetricInput(input);
                });
                
                // Validate on initial load
                validateKeyMetricInput(input);
            });
            
            // Add the item to the container
            container.appendChild(itemDiv);
        }
        
        function validateKeyMetricInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }
        }
        
        function toggleDeleteKeyMetricItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.key-metric-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getKeyMetricsData() {
            const keyMetricItems = document.querySelectorAll('.key-metric-item');
            const data = [];
            
            keyMetricItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.key-metric-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.key-metric-id').value || null;
                const metricName = item.querySelector('.key-metric-name').value;
                const metricValue = item.querySelector('.key-metric-value').value;
                const displayOrder = parseInt(item.querySelector('.key-metric-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const nameInput = item.querySelector('.key-metric-name');
                    const valueInput = item.querySelector('.key-metric-value');
                    
                    const nameValid = validateKeyMetricInput(nameInput);
                    const valueValid = validateKeyMetricInput(valueInput);
                    
                    if (!nameValid || !valueValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.key-metric-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const keyMetricObject = {
                    metric_id: id,
                    metric_name: metricName,
                    metric_value: metricValue,
                    display_order: displayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(keyMetricObject);
            });
            
            return data;
        }
        
        function loadKeyMetricsData(keyMetrics) {
            console.log('Loading key metrics data:', keyMetrics);
            
            // Get the container
            const container = document.getElementById('key-metrics-container');
            if (!container) {
                console.error('Key metrics container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no key metrics, add an empty one
            if (!keyMetrics || keyMetrics.length === 0) {
                addKeyMetricItem();
                return;
            }
            
            // Otherwise, add each item to the form
            keyMetrics.forEach(item => addKeyMetricItem(item));
        }
        
        // Skills Proficiency Functions
        function addSkillProficiencyItem(itemData = {}, index = Date.now()) {
            console.log('Adding skill proficiency item:', itemData);
            const container = document.getElementById('skills-proficiency-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('skills-proficiency-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'skill-proficiency-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.skill_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the skill proficiency item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Skill Proficiency</h5>
                    <button type="button" class="delete-skill-proficiency-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="skill-proficiency-id" value="${itemData.skill_id || ''}">
                <input type="hidden" class="skill-proficiency-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Skill Name <span class="text-red-500">*</span></label>
                        <input type="text" class="skill-proficiency-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.skill_name || ''}" required>
                        <div class="skill-proficiency-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Proficiency % <span class="text-red-500">*</span></label>
                        <input type="number" class="skill-proficiency-level mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.proficiency_level || 0}" min="0" max="100" required>
                        <div class="skill-proficiency-validation-error hidden text-red-500 text-xs mt-1">This field is required and must be between 0-100</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Display Order</label>
                        <input type="number" class="skill-proficiency-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            itemDiv.querySelector('.delete-skill-proficiency-btn').addEventListener('click', function() {
                toggleDeleteSkillProficiencyItem(itemDiv);
            });
            
            // Add event listeners for validation
            const requiredInputs = itemDiv.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateSkillProficiencyInput(input);
                });
                
                // Validate on initial load
                validateSkillProficiencyInput(input);
            });
            
            // Add the item to the container
            container.appendChild(itemDiv);
        }
        
        function validateSkillProficiencyInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } 
            // Additional validation for proficiency level
            else if (input.classList.contains('skill-proficiency-level')) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0 || value > 100) {
                    errorElement.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    return false;
                }
            }
            
            // If all validation passes
            errorElement.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }
        
        function toggleDeleteSkillProficiencyItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.skill-proficiency-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getSkillProficiencyData() {
            const skillProficiencyItems = document.querySelectorAll('.skill-proficiency-item');
            const data = [];
            
            skillProficiencyItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.skill-proficiency-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.skill-proficiency-id').value || null;
                const skillName = item.querySelector('.skill-proficiency-name').value;
                const proficiencyLevel = parseInt(item.querySelector('.skill-proficiency-level').value || '0');
                const displayOrder = parseInt(item.querySelector('.skill-proficiency-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const nameInput = item.querySelector('.skill-proficiency-name');
                    const levelInput = item.querySelector('.skill-proficiency-level');
                    
                    const nameValid = validateSkillProficiencyInput(nameInput);
                    const levelValid = validateSkillProficiencyInput(levelInput);
                    
                    if (!nameValid || !levelValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.skill-proficiency-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const skillProficiencyObject = {
                    skill_id: id,
                    skill_name: skillName,
                    proficiency_level: proficiencyLevel,
                    display_order: displayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(skillProficiencyObject);
            });
            
            return data;
        }
        
        function loadSkillProficiencyData(skillProficiencies) {
            console.log('Loading skill proficiency data:', skillProficiencies);
            
            // Get the container
            const container = document.getElementById('skills-proficiency-container');
            if (!container) {
                console.error('Skill proficiency container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no skill proficiencies, add an empty one
            if (!skillProficiencies || skillProficiencies.length === 0) {
                addSkillProficiencyItem();
                return;
            }
            
            // Otherwise, add each item to the form
            skillProficiencies.forEach(item => addSkillProficiencyItem(item));
        }
        
        // Certifications Functions
        function initCertifications() {
            console.log('Initializing certifications section');
            
            // Add event listener to the "Add Certification" button
            const addCertButton = document.getElementById('add-certification-button');
            if (addCertButton) {
                addCertButton.addEventListener('click', function() {
                    addCertificationItem();
                });
            }
        }
        
        function addCertificationItem(itemData = {}, index = Date.now()) {
            console.log('Adding certification item:', itemData);
            const container = document.getElementById('certification-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'certification-item bg-gray-50 rounded-md p-4 my-4 border border-gray-200';
            itemDiv.dataset.id = itemData.id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            itemDiv.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-base font-medium text-gray-800">Certification Entry</h4>
                    <button type="button" class="delete-certification text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="certification-id" name="certification_id" value="${itemData.id || ''}">
                <input type="hidden" class="certification-is-deleted" name="certification_is_deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                    <!-- Certification Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Certification Name*</label>
                        <input type="text" class="certification-name mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.certification_name || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Issuer Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Issuer Name*</label>
                        <input type="text" class="certification-issuer mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.issuer_name || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Credential ID -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Credential ID</label>
                        <input type="text" class="certification-credential-id mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.credential_id || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                    </div>
                    
                    <!-- Credential Link -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Credential Link</label>
                        <input type="url" class="certification-credential-link mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.credential_link || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} placeholder="https://">
                    </div>
                    
                    <!-- Dates -->
                    <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Issued Date*</label>
                            <input type="date" class="certification-issued-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                                value="${itemData.issued_date || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Expiry Date</label>
                            <input type="date" class="certification-expiry-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                                value="${itemData.expiry_date || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea class="certification-description mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            rows="3" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>${itemData.description || ''}</textarea>
                    </div>
                </div>
            `;
            
            container.appendChild(itemDiv);
            
            // Hide the loading message if it exists
            const loadingMsg = document.getElementById('certification-loading-message');
            if (loadingMsg) {
                loadingMsg.classList.add('hidden');
            }
            
            // Add event listener for the delete button
            const deleteButton = itemDiv.querySelector('.delete-certification');
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    const isDeletedInput = itemDiv.querySelector('.certification-is-deleted');
                    
                    // Toggle the deletion state
                    const isCurrentlyDeleted = parseInt(isDeletedInput.value || '0') === 1;
                    isDeletedInput.value = isCurrentlyDeleted ? '0' : '1';
                    
                    // Update visual indicators and disable inputs
                    if (!isCurrentlyDeleted) {
                        // Mark for deletion
                        itemDiv.classList.add('marked-for-deletion');
                        deleteButton.innerHTML = 'Marked for Deletion';
                        
                        // Disable all inputs in this item
                        itemDiv.querySelectorAll('input:not(.certification-is-deleted), textarea').forEach(input => {
                            input.disabled = true;
                        });
                    } else {
                        // Unmark from deletion
                        itemDiv.classList.remove('marked-for-deletion');
                        deleteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        `;
                        
                        // Re-enable all inputs
                        itemDiv.querySelectorAll('input:not(.certification-is-deleted), textarea').forEach(input => {
                            input.disabled = false;
                        });
                    }
                });
            }
            
            // Create rich text toolbar for description
            const descriptionField = itemDiv.querySelector('.certification-description');
            if (descriptionField) {
                descriptionField.id = `certification-desc-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                createRichTextToolbar(descriptionField.id);
            }
        }
        
        // Get certification data from the form
        function getCertificationData() {
            const certificationItems = document.querySelectorAll('.certification-item');
            const data = [];
            
            certificationItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.certification-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.certification-id').value || null;
                const certificationName = item.querySelector('.certification-name').value;
                const issuerName = item.querySelector('.certification-issuer').value;
                const credentialId = item.querySelector('.certification-credential-id').value;
                const credentialLink = item.querySelector('.certification-credential-link').value;
                const issuedDate = item.querySelector('.certification-issued-date').value;
                const expiryDate = item.querySelector('.certification-expiry-date').value;
                const description = item.querySelector('.certification-description').value;
                
                // Skip validation for items marked for deletion
                if (isDeleted === 0) {
                    // Basic validation for required fields
                    let isValid = true;
                    
                    if (!certificationName) {
                        item.querySelector('.certification-name').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.certification-name').classList.remove('border-red-500');
                    }
                    
                    if (!issuerName) {
                        item.querySelector('.certification-issuer').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.certification-issuer').classList.remove('border-red-500');
                    }
                    
                    if (!issuedDate) {
                        item.querySelector('.certification-issued-date').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.certification-issued-date').classList.remove('border-red-500');
                    }
                    
                    if (!isValid) {
                        console.error('Certification item has validation errors');
                        item.classList.add('certification-validation-error');
                    } else {
                        item.classList.remove('certification-validation-error');
                    }
                }
                
                // Create a certification object
                const certificationObject = {
                    id: id,
                    certification_name: certificationName,
                    issuer_name: issuerName,
                    credential_id: credentialId || null,
                    credential_link: credentialLink || null,
                    issued_date: issuedDate || null,
                    expiry_date: expiryDate || null,
                    description: description || null,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(certificationObject);
            });
            
            console.log('Collected certification data:', data);
            return data;
        }
        
        // Load certification data into the form
        function loadCertificationData(certifications) {
            console.log('Loading certification data:', certifications);
            
            // Get the container
            const container = document.getElementById('certification-items-container');
            if (!container) {
                console.error('Certification items container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no certifications, add an empty one
            if (!certifications || certifications.length === 0) {
                addCertificationItem();
                return;
            }
            
            // Otherwise, add each certification to the form
            certifications.forEach(cert => {
                // Format dates to YYYY-MM-DD if needed
                if (cert.issue_date && !isValidDateFormat(cert.issue_date)) {
                    cert.issued_date = formatDateToYYYYMMDD(cert.issue_date);
                }
                
                if (cert.expiry_date && !isValidDateFormat(cert.expiry_date)) {
                    cert.expiry_date = formatDateToYYYYMMDD(cert.expiry_date);
                }
                
                addCertificationItem(cert);
            });
        }
        
        // Helper function to check if a date is in YYYY-MM-DD format
        function isValidDateFormat(dateString) {
            return /^\d{4}-\d{2}-\d{2}$/.test(dateString);
        }
        
        // Helper function to convert date to YYYY-MM-DD format
        function formatDateToYYYYMMDD(dateString) {
            try {
                // Try to parse the date
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return ''; // Return empty string if invalid date
                }
                
                // Format to YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return '';
            }
        }
        
        // Fetch certification data separately if needed
        async function fetchCertificationData() {
            console.log('Fetching certification data separately');
            
            try {
                const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=certifications';
                
                const response = await fetch(apiEndpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`API response not OK: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Successfully loaded certification data:', data);
                
                // Load the certification data
                loadCertificationData(data.certifications || []);
            } catch (error) {
                console.error('Error fetching certification data:', error);
                
                // Try loading from local JSON as fallback
                try {
                    const localResponse = await fetch('/data/certifications.json');
                    const localData = await localResponse.json();
                    loadCertificationData(localData);
                } catch (localError) {
                    console.error('Error loading from local certifications JSON:', localError);
                    // Add an empty certification item
                    addCertificationItem();
                }
            }
        }

        // Areas of Expertise Functions
        function addExpertiseItem(itemData = {}, index = Date.now()) {
            console.log('Adding expertise item:', itemData);
            const container = document.getElementById('expertise-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('expertise-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'expertise-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.expertise_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the expertise item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Area of Expertise</h5>
                    <button type="button" class="delete-expertise-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="expertise-id" value="${itemData.expertise_id || ''}">
                <input type="hidden" class="expertise-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Category <span class="text-red-500">*</span></label>
                        <input type="text" class="expertise-category mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.expertise_category || ''}" required>
                        <div class="expertise-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Expertise Item <span class="text-red-500">*</span></label>
                        <input type="text" class="expertise-item-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.expertise_item || ''}" required>
                        <div class="expertise-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Item Order</label>
                        <input type="number" class="expertise-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Category Order</label>
                        <input type="number" class="expertise-category-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.category_display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            itemDiv.querySelector('.delete-expertise-btn').addEventListener('click', function() {
                toggleDeleteExpertiseItem(itemDiv);
            });
            
            // Add event listeners for validation
            const requiredInputs = itemDiv.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateExpertiseInput(input);
                });
                
                // Validate on initial load
                validateExpertiseInput(input);
            });
            
            // Add the item to the container
            container.appendChild(itemDiv);
        }
        
        function validateExpertiseInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }
        }
        
        function toggleDeleteExpertiseItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.expertise-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getExpertiseData() {
            const expertiseItems = document.querySelectorAll('.expertise-item');
            const data = [];
            
            expertiseItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.expertise-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.expertise-id').value || null;
                const expertiseCategory = item.querySelector('.expertise-category').value;
                const expertiseItem = item.querySelector('.expertise-item-name').value;
                const displayOrder = parseInt(item.querySelector('.expertise-display-order').value || '0');
                const categoryDisplayOrder = parseInt(item.querySelector('.expertise-category-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const categoryInput = item.querySelector('.expertise-category');
                    const itemInput = item.querySelector('.expertise-item-name');
                    
                    const categoryValid = validateExpertiseInput(categoryInput);
                    const itemValid = validateExpertiseInput(itemInput);
                    
                    if (!categoryValid || !itemValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.expertise-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const expertiseObject = {
                    expertise_id: id,
                    expertise_category: expertiseCategory,
                    expertise_item: expertiseItem,
                    display_order: displayOrder,
                    category_display_order: categoryDisplayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(expertiseObject);
            });
            
            return data;
        }
        
        function loadExpertiseData(expertiseItems) {
            console.log('Loading expertise data:', expertiseItems);
            
            // Get the container
            const container = document.getElementById('expertise-container');
            if (!container) {
                console.error('Expertise container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no expertise items, add an empty one
            if (!expertiseItems || expertiseItems.length === 0) {
                addExpertiseItem();
                return;
            }
            
            // Otherwise, add each item to the form
            expertiseItems.forEach(item => addExpertiseItem(item));
        }
        
        // Toolkit Categories Functions
        function addToolkitCategoryItem(itemData = {}, index = Date.now()) {
            console.log('Adding toolkit category item:', itemData);
            const container = document.getElementById('toolkit-categories-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('toolkit-categories-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'toolkit-category-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.toolkit_category_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the toolkit category item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Toolkit Category</h5>
                    <button type="button" class="delete-toolkit-category-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="toolkit-category-id" value="${itemData.toolkit_category_id || ''}">
                <input type="hidden" class="toolkit-category-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-5">
                        <label class="block text-sm font-medium text-gray-700">Category Name <span class="text-red-500">*</span></label>
                        <input type="text" class="toolkit-category-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.toolkit_category_name || ''}" required>
                        <div class="toolkit-category-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Display Order</label>
                        <input type="number" class="toolkit-category-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            itemDiv.querySelector('.delete-toolkit-category-btn').addEventListener('click', function() {
                toggleDeleteToolkitCategoryItem(itemDiv);
                // Update toolkit item dropdowns after deleting a category
                setTimeout(() => {
                    updateToolkitItemCategoryDropdowns();
                }, 100);
            });
            
            // Add event listeners for validation
            const requiredInputs = itemDiv.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateToolkitCategoryInput(input);
                    // Update toolkit item dropdowns when category name changes
                    if (input.classList.contains('toolkit-category-name')) {
                        setTimeout(() => {
                            updateToolkitItemCategoryDropdowns();
                        }, 100);
                    }
                });
                
                // Validate on initial load
                validateToolkitCategoryInput(input);
            });
            
            // Add the item to the container
            container.appendChild(itemDiv);
            
            return itemDiv;
        }
        
        function validateToolkitCategoryInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }
        }
        
        function toggleDeleteToolkitCategoryItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.toolkit-category-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getToolkitCategoriesData() {
            const toolkitCategoryItems = document.querySelectorAll('.toolkit-category-item');
            const data = [];
            
            toolkitCategoryItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.toolkit-category-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.toolkit-category-id').value || null;
                const categoryName = item.querySelector('.toolkit-category-name').value;
                const displayOrder = parseInt(item.querySelector('.toolkit-category-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const nameInput = item.querySelector('.toolkit-category-name');
                    
                    const nameValid = validateToolkitCategoryInput(nameInput);
                    
                    if (!nameValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.toolkit-category-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const toolkitCategoryObject = {
                    toolkit_category_id: id,
                    toolkit_category_name: categoryName,
                    display_order: displayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(toolkitCategoryObject);
            });
            
            return data;
        }
        
        function loadToolkitCategoriesData(toolkitCategories) {
            console.log('Loading toolkit categories data:', toolkitCategories);
            
            // Get the container
            const container = document.getElementById('toolkit-categories-container');
            if (!container) {
                console.error('Toolkit categories container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no toolkit categories, add an empty one
            if (!toolkitCategories || toolkitCategories.length === 0) {
                addToolkitCategoryItem();
                return;
            }
            
            // Otherwise, add each item to the form
            toolkitCategories.forEach(item => addToolkitCategoryItem(item));
        }
        
        // Toolkit Items Functions
        function addToolkitItem(itemData = {}, index = Date.now()) {
            console.log('Adding toolkit item:', itemData);
            const container = document.getElementById('toolkit-items-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('toolkit-items-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'toolkit-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.toolkit_item_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the toolkit item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Toolkit Item</h5>
                    <button type="button" class="delete-toolkit-item-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="toolkit-item-id" value="${itemData.toolkit_item_id || ''}">
                <input type="hidden" class="toolkit-item-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Category <span class="text-red-500">*</span></label>
                        <select class="toolkit-item-category-id mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                            <option value="">Select Category</option>
                        </select>
                        <div class="toolkit-item-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Tool Name <span class="text-red-500">*</span></label>
                        <input type="text" class="toolkit-item-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.toolkit_item_name || ''}" required>
                        <div class="toolkit-item-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Display Order</label>
                        <input type="number" class="toolkit-item-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            const deleteButton = itemDiv.querySelector('.delete-toolkit-item-btn');
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    toggleDeleteToolkitItem(itemDiv);
                });
            }
            
            // Add the item to the container
            container.appendChild(itemDiv);
            
            // Populate category dropdown
            const categorySelect = itemDiv.querySelector('.toolkit-item-category-id');
            if (categorySelect) {
                // Set the options
                const options = getToolkitCategoryOptions(itemData.toolkit_category_id);
                categorySelect.innerHTML = `<option value="">Select Category</option>${options}`;
                
                // Try to set the selected value if it exists
                if (itemData.toolkit_category_id) {
                    categorySelect.value = itemData.toolkit_category_id;
                }
                
                // Add validation for the dropdown
                categorySelect.addEventListener('change', function() {
                    validateToolkitItemInput(categorySelect);
                });
                
                // Initial validation
                validateToolkitItemInput(categorySelect);
            }
            
            // Add event listeners for other validation
            const nameInput = itemDiv.querySelector('.toolkit-item-name');
            if (nameInput) {
                nameInput.addEventListener('input', function() {
                    validateToolkitItemInput(nameInput);
                });
                validateToolkitItemInput(nameInput);
            }
            
            return itemDiv;
        }
        
        // Helper function to get category options for select dropdown
        function getToolkitCategoryOptions(selectedCategoryId) {
            const categoryItems = document.querySelectorAll('.toolkit-category-item:not(.marked-for-deletion)');
            let options = '';
            
            categoryItems.forEach(item => {
                // Skip items marked for deletion
                if (item.classList.contains('marked-for-deletion')) {
                    return;
                }
                
                const categoryId = item.querySelector('.toolkit-category-id').value;
                const categoryName = item.querySelector('.toolkit-category-name').value;
                
                if (categoryId && categoryName) {
                    const selected = categoryId == selectedCategoryId ? 'selected' : '';
                    options += `<option value="${categoryId}" ${selected}>${categoryName}</option>`;
                }
            });
            
            return options;
        }

        // Modified function to update toolkit item category dropdowns
        function updateToolkitItemCategoryDropdowns() {
            console.log('Updating toolkit item category dropdowns');
            const toolkitItems = document.querySelectorAll('.toolkit-item');
            
            toolkitItems.forEach(item => {
                const categorySelect = item.querySelector('.toolkit-item-category-id');
                const currentValue = categorySelect.value;
                
                // Store current selection
                categorySelect.innerHTML = `
                    <option value="">Select Category</option>
                    ${getToolkitCategoryOptions(currentValue)}
                `;
                
                // Validate after update
                validateToolkitItemInput(categorySelect);
            });
        }

        // Modified loadToolkitItemsData to be called after categories are loaded
        function loadToolkitItemsData(toolkitItems) {
            console.log('Loading toolkit items data:', toolkitItems);
            
            // Get the container
            const container = document.getElementById('toolkit-items-container');
            if (!container) {
                console.error('Toolkit items container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no toolkit items, add an empty one
            if (!toolkitItems || toolkitItems.length === 0) {
                addToolkitItem();
                return;
            }
            
            // Otherwise, add each item to the form
            toolkitItems.forEach(item => addToolkitItem(item));
            
            // Update all category dropdowns after all items are added
            setTimeout(() => {
                updateToolkitItemCategoryDropdowns();
            }, 100);
        }

        // Modified loadToolkitCategoriesData to update toolkit item dropdowns after loading
        function loadToolkitCategoriesData(toolkitCategories) {
            console.log('Loading toolkit categories data:', toolkitCategories);
            
            // Get the container
            const container = document.getElementById('toolkit-categories-container');
            if (!container) {
                console.error('Toolkit categories container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no toolkit categories, add an empty one
            if (!toolkitCategories || toolkitCategories.length === 0) {
                addToolkitCategoryItem();
                return;
            }
            
            // Otherwise, add each item to the form
            toolkitCategories.forEach(item => addToolkitCategoryItem(item));
            
            // Update toolkit item category dropdowns after categories are loaded
            setTimeout(() => {
                updateToolkitItemCategoryDropdowns();
            }, 100);
        }
        
        function validateToolkitItemInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }
        }
        
        function toggleDeleteToolkitItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.toolkit-item-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getToolkitItemsData() {
            const toolkitItems = document.querySelectorAll('.toolkit-item');
            const data = [];
            
            toolkitItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.toolkit-item-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.toolkit-item-id').value || null;
                const categoryId = item.querySelector('.toolkit-item-category-id').value;
                const itemName = item.querySelector('.toolkit-item-name').value;
                const displayOrder = parseInt(item.querySelector('.toolkit-item-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const categoryInput = item.querySelector('.toolkit-item-category-id');
                    const nameInput = item.querySelector('.toolkit-item-name');
                    
                    const categoryValid = validateToolkitItemInput(categoryInput);
                    const nameValid = validateToolkitItemInput(nameInput);
                    
                    if (!categoryValid || !nameValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.toolkit-item-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const toolkitItemObject = {
                    toolkit_item_id: id,
                    toolkit_category_id: categoryId,
                    toolkit_item_name: itemName,
                    display_order: displayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(toolkitItemObject);
            });
            
            return data;
        }
        
        // Domain Experience Functions
        function addDomainExperienceItem(itemData = {}, index = Date.now()) {
            console.log('Adding domain experience item:', itemData);
            const container = document.getElementById('domain-experience-container');
            
            // Remove loading message if present
            const loadingMessage = document.getElementById('domain-experience-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'domain-experience-item bg-gray-50 rounded-md p-3 my-2 border border-gray-200';
            itemDiv.dataset.id = itemData.domain_id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            // Create the HTML structure for the domain experience item
            itemDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-sm font-medium text-gray-700">Domain Experience</h5>
                    <button type="button" class="delete-domain-experience-btn text-red-600 hover:text-red-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="domain-experience-id" value="${itemData.domain_id || ''}">
                <input type="hidden" class="domain-experience-is-deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-6 gap-4">
                    <div class="col-span-3">
                        <label class="block text-sm font-medium text-gray-700">Domain/Industry <span class="text-red-500">*</span></label>
                        <input type="text" class="domain-experience-name mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.domain_name || ''}" required>
                        <div class="domain-experience-validation-error hidden text-red-500 text-xs mt-1">This field is required</div>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Experience % <span class="text-red-500">*</span></label>
                        <input type="number" class="domain-experience-percentage mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.experience_percentage || 0}" min="0" max="100" required>
                        <div class="domain-experience-validation-error hidden text-red-500 text-xs mt-1">This field is required and must be between 0-100</div>
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Display Order</label>
                        <input type="number" class="domain-experience-display-order mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${itemData.display_order || 0}" min="0">
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            itemDiv.querySelector('.delete-domain-experience-btn').addEventListener('click', function() {
                toggleDeleteDomainExperienceItem(itemDiv);
            });
            
            // Add event listeners for validation
            const requiredInputs = itemDiv.querySelectorAll('input[required]');
            requiredInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateDomainExperienceInput(input);
                });
                
                // Validate on initial load
                validateDomainExperienceInput(input);
            });
            
            // Add the item to the container
            container.appendChild(itemDiv);
        }
        
        function validateDomainExperienceInput(input) {
            // Find the closest validation error element
            const errorElement = input.nextElementSibling;
            
            // Check if the input has a value
            if (!input.value.trim()) {
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                return false;
            } 
            // Additional validation for experience percentage
            else if (input.classList.contains('domain-experience-percentage')) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0 || value > 100) {
                    errorElement.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    return false;
                }
            }
            
            // If all validation passes
            errorElement.classList.add('hidden');
            input.classList.remove('border-red-500');
            return true;
        }
        
        function toggleDeleteDomainExperienceItem(itemDiv) {
            // Toggle the marked-for-deletion class
            itemDiv.classList.toggle('marked-for-deletion');
            
            // Update the is-deleted field
            const isDeletedField = itemDiv.querySelector('.domain-experience-is-deleted');
            isDeletedField.value = itemDiv.classList.contains('marked-for-deletion') ? 1 : 0;
        }
        
        function getDomainExperienceData() {
            const domainExperienceItems = document.querySelectorAll('.domain-experience-item');
            const data = [];
            
            domainExperienceItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.domain-experience-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.domain-experience-id').value || null;
                const domainName = item.querySelector('.domain-experience-name').value;
                const experiencePercentage = parseInt(item.querySelector('.domain-experience-percentage').value || '0');
                const displayOrder = parseInt(item.querySelector('.domain-experience-display-order').value || '0');
                
                // Skip validation for items marked for deletion
                if (isDeleted !== 1) {
                    // Validate required fields
                    const nameInput = item.querySelector('.domain-experience-name');
                    const percentageInput = item.querySelector('.domain-experience-percentage');
                    
                    const nameValid = validateDomainExperienceInput(nameInput);
                    const percentageValid = validateDomainExperienceInput(percentageInput);
                    
                    if (!nameValid || !percentageValid) {
                        // If any validation fails, show the appropriate error and scroll to it
                        const errorElement = item.querySelector('.domain-experience-validation-error:not(.hidden)');
                        if (errorElement) {
                            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return null; // Signal validation error
                    }
                }
                
                // Create data object
                const domainExperienceObject = {
                    domain_id: id,
                    domain_name: domainName,
                    experience_percentage: experiencePercentage,
                    display_order: displayOrder,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(domainExperienceObject);
            });
            
            return data;
        }
        
        function loadDomainExperienceData(domainExperience) {
            console.log('Loading domain experience data:', domainExperience);
            
            // Get the container
            const container = document.getElementById('domain-experience-container');
            if (!container) {
                console.error('Domain experience container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no domain experience items, add an empty one
            if (!domainExperience || domainExperience.length === 0) {
                addDomainExperienceItem();
                return;
            }
            
            // Otherwise, add each item to the form
            domainExperience.forEach(item => addDomainExperienceItem(item));
        }
    });
    
    <script>
        // Function to handle collapsible sections
        function setupCollapsibleSections() {
            // Get all section headers
            const sectionHeaders = document.querySelectorAll('.section-header');
            
            // Add click event listener to each header
            sectionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    // Toggle the collapsed class on the header
                    this.classList.toggle('collapsed');
                    
                    // Get the section ID from the data attribute
                    const sectionId = this.getAttribute('data-section');
                    
                    // Find all content elements related to this section
                    const contentElements = document.querySelectorAll(`.section-content[data-parent="${sectionId}"]`);
                    
                    // Toggle the collapsed class on each content element
                    contentElements.forEach(content => {
                        content.classList.toggle('collapsed');
                    });
                });
            });
            
            // Initial state - collapse all subsections except the main ones
            const subsectionHeaders = document.querySelectorAll('.section-header:not([data-section="site-config"]):not([data-section="work-experience"]):not([data-section="education"]):not([data-section="certifications"]):not([data-section="skills"])');
            subsectionHeaders.forEach(header => {
                // Simulate a click to collapse subsections
                header.click();
            });
        }
        
        // Initialize collapsible sections when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Setup after a short delay to ensure all elements are loaded
            setTimeout(() => {
                setupCollapsibleSections();
            }, 500);
        });
        
        // After form is loaded, setup collapsible sections again
        document.addEventListener('formLoaded', function() {
            setupCollapsibleSections();
        });
    </script>
</body>
</html> 
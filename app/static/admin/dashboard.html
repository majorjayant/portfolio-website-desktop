<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin-dashboard.css">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen bg-gray-100">
        <!-- Authentication check -->
        <div id="auth-loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-lg text-gray-600">Verifying authentication...</p>
            </div>
        </div>
        
        <!-- Not Authenticated Message -->
        <div id="not-authenticated" class="hidden fixed inset-0 flex items-center justify-center bg-white z-50">
            <div class="text-center">
                <div class="text-red-600 text-6xl mb-4">⚠️</div>
                <p class="text-lg text-gray-800 mb-4">You need to log in to access this page</p>
                <a href="/admin/login" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Go to Login
                </a>
            </div>
        </div>
        
        <!-- API Error Message -->
        <div id="api-error" class="hidden fixed top-4 right-4 p-4 bg-red-100 text-red-700 rounded-md shadow-md z-40">
            Error loading data. Please try again later.
        </div>
        
        <!-- Dashboard Content (hidden until authenticated) -->
        <div id="dashboard-content" class="hidden">
            <!-- Navigation -->
            <nav class="bg-indigo-600 shadow">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex">
                            <div class="flex-shrink-0 flex items-center">
                                <span class="text-white text-xl font-bold">Admin Dashboard</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <a href="/admin" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-indigo-700">
                                Admin Home
                            </a>
                            <button id="logout-button" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-indigo-700 hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h2 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                Site Configuration
                            </h2>
                            <div id="loading-indicator" class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                                <p class="text-gray-500">Loading configuration...</p>
                            </div>
                            <div id="form-container" class="hidden mt-4">
                                <form id="site-config-form" class="space-y-6">
                                    <div>
                                        <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">General Website Information</h3>
                                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                            <!-- Site Title -->
                                            <div>
                                                <label for="about_title" class="block text-sm font-medium text-gray-700">Site Title</label>
                                                <input type="text" id="about_title" name="about_title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Subtitle -->
                                            <div>
                                                <label for="about_subtitle" class="block text-sm font-medium text-gray-700">Subtitle</label>
                                                <input type="text" id="about_subtitle" name="about_subtitle" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Description -->
                                            <div class="sm:col-span-2">
                                                <label for="about_description" class="block text-sm font-medium text-gray-700">Description</label>
                                                <textarea id="about_description" name="about_description" rows="5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">Website Images</h3>
                                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                            <!-- Favicon URL -->
                                            <div>
                                                <label for="image_favicon_url" class="block text-sm font-medium text-gray-700">Favicon URL</label>
                                                <input type="text" id="image_favicon_url" name="image_favicon_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">URL for the website favicon (browser tab icon)</p>
                                            </div>
                                            
                                            <!-- Logo URL -->
                                            <div>
                                                <label for="image_logo_url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                                                <input type="text" id="image_logo_url" name="image_logo_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">URL for the website logo</p>
                                            </div>
                                            
                                            <!-- Banner URL -->
                                            <div>
                                                <label for="image_banner_url" class="block text-sm font-medium text-gray-700">Banner URL</label>
                                                <input type="text" id="image_banner_url" name="image_banner_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">URL for the website banner image</p>
                                            </div>
                                            
                                            <!-- Mobile Banner URL -->
                                            <div>
                                                <label for="image_mobile_banner_url" class="block text-sm font-medium text-gray-700">Mobile Banner URL</label>
                                                <input type="text" id="image_mobile_banner_url" name="image_mobile_banner_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">URL for the mobile version of the banner image</p>
                                            </div>
                                            
                                            <!-- Profile Image URL -->
                                            <div>
                                                <label for="image_about_profile_url" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                                                <input type="text" id="image_about_profile_url" name="image_about_profile_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">URL for your main profile photo</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 class="text-md font-medium text-gray-700 border-b pb-2 mb-4">Gallery Photos</h3>
                                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                            <!-- Photo 1 URL -->
                                            <div>
                                                <label for="image_about_photo1_url" class="block text-sm font-medium text-gray-700">Photo 1 URL</label>
                                                <input type="text" id="image_about_photo1_url" name="image_about_photo1_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Photo 1 Alt Text -->
                                            <div>
                                                <label for="about_photo1_alt" class="block text-sm font-medium text-gray-700">Photo 1 Alt Text</label>
                                                <input type="text" id="about_photo1_alt" name="about_photo1_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                            </div>
                                            
                                            <!-- Photo 2 URL -->
                                            <div>
                                                <label for="image_about_photo2_url" class="block text-sm font-medium text-gray-700">Photo 2 URL</label>
                                                <input type="text" id="image_about_photo2_url" name="image_about_photo2_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Photo 2 Alt Text -->
                                            <div>
                                                <label for="about_photo2_alt" class="block text-sm font-medium text-gray-700">Photo 2 Alt Text</label>
                                                <input type="text" id="about_photo2_alt" name="about_photo2_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                            </div>
                                            
                                            <!-- Photo 3 URL -->
                                            <div>
                                                <label for="image_about_photo3_url" class="block text-sm font-medium text-gray-700">Photo 3 URL</label>
                                                <input type="text" id="image_about_photo3_url" name="image_about_photo3_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Photo 3 Alt Text -->
                                            <div>
                                                <label for="about_photo3_alt" class="block text-sm font-medium text-gray-700">Photo 3 Alt Text</label>
                                                <input type="text" id="about_photo3_alt" name="about_photo3_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                            </div>
                                            
                                            <!-- Photo 4 URL -->
                                            <div>
                                                <label for="image_about_photo4_url" class="block text-sm font-medium text-gray-700">Photo 4 URL</label>
                                                <input type="text" id="image_about_photo4_url" name="image_about_photo4_url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                            </div>
                                            
                                            <!-- Photo 4 Alt Text -->
                                            <div>
                                                <label for="about_photo4_alt" class="block text-sm font-medium text-gray-700">Photo 4 Alt Text</label>
                                                <input type="text" id="about_photo4_alt" name="about_photo4_alt" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                <p class="mt-1 text-xs text-gray-500">Alternative text for accessibility</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Work Experience -->
                                    <div class="mb-8">
                                        <h3 class="text-lg font-medium text-gray-900 mb-4">Work Experience</h3>
                                        <div id="work-experience-container" class="space-y-6">
                                            <!-- Work experience items will be dynamically added here -->
                                            <p id="work-experience-loading" class="text-gray-500">Loading work experience...</p>
                                        </div>
                                        <div class="mt-4">
                                            <button type="button" id="add-work-experience" class="inline-flex items-center px-3 py-2 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                                </svg>
                                                Add Work Experience
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Education Section -->
                                    <div class="mb-8">
                                        <h3 class="text-lg font-medium text-gray-900 mb-4">Education</h3>
                                        <div id="education-items-container" class="space-y-6">
                                            <!-- Education items will be dynamically added here -->
                                            <p id="education-loading-message" class="text-gray-500">Loading education data...</p>
                                        </div>
                                        <div class="mt-4">
                                            <button type="button" id="add-education-button" class="inline-flex items-center px-3 py-2 border border-indigo-600 text-sm leading-4 font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                                </svg>
                                                Add Education
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Template for new work experience items -->
                                    <template id="work-experience-template">
                                        <div class="work-experience-item bg-gray-50 rounded-md p-4 my-4 border border-gray-200">
                                            <div class="flex justify-between items-start mb-3">
                                                <h4 class="text-base font-medium text-gray-800">Work Experience Entry</h4>
                                                <button type="button" class="delete-work-experience text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <input type="hidden" class="workex-id" name="workex_id">
                                            
                                            <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                                                <!-- Job Title -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">Job Title</label>
                                                    <input type="text" class="workex-title mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                </div>
                                                
                                                <!-- Company Name -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">Company Name</label>
                                                    <input type="text" class="workex-company mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                </div>
                                                
                                                <!-- Location -->
                                                <div class="sm:col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700">Location</label>
                                                    <input type="text" class="workex-location mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                                </div>
                                                
                                                <!-- Date Range -->
                                                <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700">From Date</label>
                                                        <input type="month" class="workex-from-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" required>
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700">To Date</label>
                                                        <input type="month" class="workex-to-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border">
                                                    </div>

                                                    <div class="flex items-center pb-2">
                                                        <input type="checkbox" class="workex-current h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                                        <label class="ml-2 block text-sm text-gray-700">Current Job</label>
                                                    </div>
                                                </div>
                                                
                                                <!-- Description / Responsibilities -->
                                                <div class="sm:col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700">Description / Responsibilities</label>
                                                    <textarea class="workex-description mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" rows="3" required></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div class="mt-6 flex justify-between items-center">
                                        <button type="button" id="refresh-button" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                            </svg>
                                            Refresh Data
                                        </button>
                                        <button type="submit" id="save-button" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                                
                                <!-- Ensure rich text editors are initialized -->
                                <script>
                                    // Initialize rich text toolbars when the form becomes visible
                                    const observer = new MutationObserver(function(mutations) {
                                        mutations.forEach(function(mutation) {
                                            if (mutation.target.style.display !== 'none' && !mutation.target.classList.contains('hidden')) {
                                                console.log('Form container visible, initializing rich text editors');
                                                initRichTextToolbars();
                                            }
                                        });
                                    });
                                    
                                    // Start observing the form container
                                    const formContainer = document.getElementById('form-container');
                                    if (formContainer) {
                                        observer.observe(formContainer, { attributes: true, attributeFilter: ['style', 'class'] });
                                    }
                                    
                                    // Also try to initialize on page load
                                    document.addEventListener('DOMContentLoaded', function() {
                                        console.log('DOM loaded, trying to initialize rich text editors');
                                        setTimeout(initRichTextToolbars, 500);
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader mb-3 w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700">Saving changes...</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin dashboard loaded');
        
        const authLoading = document.getElementById('auth-loading');
        const notAuthenticated = document.getElementById('not-authenticated');
        const dashboardContent = document.getElementById('dashboard-content');
        const logoutButton = document.getElementById('logout-button');
        const siteConfigForm = document.getElementById('site-config-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const formContainer = document.getElementById('form-container');
        const apiError = document.getElementById('api-error');
        const saveButton = document.getElementById('save-button');
        
        // Check authentication
        checkAuth();
        
        // Insert HTML tags for formatting text fields
        function insertTag(fieldId, tag) {
            const field = document.getElementById(fieldId);
            if (!field) return;

            const start = field.selectionStart;
            const end = field.selectionEnd;
            const currentValue = field.value;
            const selectedText = currentValue.substring(start, end);

            let newValue;
            let cursorPosition = start; // Default cursor position

            if (tag === 'br') {
                // Insert <br> tag at cursor position
                newValue = currentValue.substring(0, start) + '<br>' + currentValue.substring(end);
                cursorPosition = start + 4; // Move cursor after <br>
            } else if (tag === 'h1' || tag === 'h2' || tag === 'h3' || tag === 'h4' || tag === 'p') {
                // Block level elements
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                if (selectedText) {
                    // Wrap selection
                    newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                    cursorPosition = end + openTag.length + closeTag.length; // Move cursor after the wrapped text
                } else {
                    // Insert empty tags at cursor
                    newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                    cursorPosition = start + openTag.length; // Move cursor between the tags
                }
            } else if (tag === 'color') {
                // Insert color tag with a default color
                const colorCode = prompt('Enter a color code (hex, rgb, or color name):', '#3366cc');
                if (colorCode) {
                    const openTag = `<span style="color:${colorCode};">`;
                    const closeTag = `</span>`;
                    if (selectedText) {
                        // Wrap selection with color
                        newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                        cursorPosition = end + openTag.length + closeTag.length;
                    } else {
                        // Insert empty color tags
                        newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                        cursorPosition = start + openTag.length;
                    }
                } else {
                    return; // User canceled color input
                }
            } else if (tag === 'link') {
                // Insert link tag
                const url = prompt('Enter the URL:', 'https://');
                if (url) {
                    const linkText = selectedText || 'link text';
                    const fullLink = `<a href="${url}" target="_blank">${linkText}</a>`;
                    newValue = currentValue.substring(0, start) + fullLink + currentValue.substring(end);
                    cursorPosition = start + fullLink.length;
                } else {
                    return; // User canceled URL input
                }
            } else if (tag === 'ul' || tag === 'ol') {
                // Handle lists
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                const liText = selectedText || 'List item';
                const liItems = liText.split('\n').map(item => `<li>${item.trim()}</li>`).join('\n  ');
                
                newValue = currentValue.substring(0, start) + 
                          openTag + '\n  ' + liItems + '\n' + closeTag + 
                          currentValue.substring(end);
                          
                cursorPosition = start + openTag.length + 1;
            } else {
                // Inline elements (b, i, u, etc.)
                const openTag = `<${tag}>`;
                const closeTag = `</${tag}>`;
                if (selectedText) {
                    // Wrap selection
                    newValue = currentValue.substring(0, start) + openTag + selectedText + closeTag + currentValue.substring(end);
                    cursorPosition = end + openTag.length + closeTag.length; // Move cursor after the wrapped text
                } else {
                    // Insert empty tags at cursor
                    newValue = currentValue.substring(0, start) + openTag + closeTag + currentValue.substring(end);
                    cursorPosition = start + openTag.length; // Move cursor between the tags
                }
            }

            field.value = newValue;
            // Set focus and cursor position
            field.focus();
            field.selectionStart = cursorPosition;
            field.selectionEnd = cursorPosition;
        }
        
        // Function to create a rich text toolbar for any element
        function createRichTextToolbar(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`Container with ID ${containerId} not found for toolbar creation`);
                return;
            }
            
            // Check if a toolbar already exists
            const existingToolbar = container.parentNode.querySelector('.rich-text-toolbar[data-for="' + containerId + '"]');
            if (existingToolbar) {
                console.log(`Toolbar already exists for ${containerId}, skipping creation`);
                return;
            }
            
            console.log(`Creating rich text toolbar for ${containerId}`);
            
            const toolbar = document.createElement('div');
            toolbar.className = 'flex flex-wrap items-center space-x-1 mb-1 rich-text-toolbar';
            toolbar.setAttribute('data-for', containerId);
            
            // Text formatting
            toolbar.innerHTML = `
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="b" title="Bold">B</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs italic rounded hover:bg-gray-300 tooltip" data-tag="i" title="Italic">I</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs underline rounded hover:bg-gray-300 tooltip" data-tag="u" title="Underline">U</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Headings and paragraph -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h1" title="Heading 1">H1</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h2" title="Heading 2">H2</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 tooltip" data-tag="h3" title="Heading 3">H3</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="p" title="Paragraph">¶</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Lists -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="ul" title="Bullet List">• List</button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="ol" title="Numbered List">1. List</button>
                <span class="mx-1 text-gray-300">|</span>
                
                <!-- Additional formatting -->
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="color" title="Text Color">
                    <span style="color: #3366cc">A</span>
                </button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="link" title="Insert Link">
                    <span style="text-decoration: underline; color: blue;">🔗</span>
                </button>
                <button type="button" class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 tooltip" data-tag="br" title="Line Break">↵</button>
            `;
            
            // Add event listeners to buttons
            toolbar.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission
                    const tag = this.dataset.tag;
                    if (tag) {
                        insertTag(containerId, tag);
                    }
                });
            });
            
            // Insert the toolbar right before the target element
            container.parentNode.insertBefore(toolbar, container);
            
            console.log(`Toolbar created for ${containerId}`);
        }
        
        // Initialize rich text toolbars for specific fields when the page loads
        function initRichTextToolbars() {
            console.log('Initializing rich text toolbars');
            
            // Main content fields
            const richTextFields = [
                'about_title', 
                'about_subtitle', 
                'about_description'
            ];
            
            richTextFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    console.log(`Creating toolbar for ${fieldId}`);
                    // Remove any existing toolbar first
                    const existingToolbar = field.parentNode.querySelector('.rich-text-toolbar');
                    if (existingToolbar) {
                        existingToolbar.remove();
                    }
                    createRichTextToolbar(fieldId);
                } else {
                    console.warn(`Field ${fieldId} not found`);
                }
            });
            
            // Work experience fields
            const workExFields = document.querySelectorAll('.workex-title, .workex-company, .workex-location, .workex-description');
            workExFields.forEach(field => {
                if (field.id && !field.parentNode.querySelector('.rich-text-toolbar')) {
                    console.log(`Creating work ex toolbar for ${field.id}`);
                    createRichTextToolbar(field.id);
                } else if (!field.id) {
                    // Generate an ID if missing
                    field.id = `workex-field-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                    console.log(`Generated ID and creating toolbar: ${field.id}`);
                    createRichTextToolbar(field.id);
                }
            });
            
            console.log('Rich text toolbar initialization complete');
        }
        
        function checkAuth() {
            console.log('Checking authentication');
            
            const token = localStorage.getItem('admin_token');
            console.log('Auth token:', token ? 'Found' : 'Not found');
            
            // Short delay to ensure the page loads properly
            setTimeout(() => {
                authLoading.classList.add('hidden');
                
                if (!token) {
                    console.log('No token found, showing not authenticated message');
                    notAuthenticated.classList.remove('hidden');
                    return;
                }
                
                // Token found, show dashboard
                console.log('Token found, showing dashboard');
                dashboardContent.classList.remove('hidden');
                loadSiteConfig();
            }, 1000);
        }
        
        function redirectToLogin() {
            window.location.href = '/admin/login';
        }
        
        // Logout handler
        logoutButton.addEventListener('click', function() {
            console.log('Logging out');
            localStorage.removeItem('admin_token');
            dashboardContent.classList.add('hidden');
            notAuthenticated.classList.remove('hidden');
        });
        
        // Load site configuration
        function loadSiteConfig() {
            console.log('Loading site configuration');
            
            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            formContainer.classList.add('hidden');
            
            // Use the confirmed working API endpoint
            const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=site_config';
            
            console.log('Fetching from API endpoint:', apiEndpoint);
            
            fetch(apiEndpoint, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                mode: 'cors',
                credentials: 'omit'
            })
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`API response not OK: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Successfully loaded site config from API:', data);
                
                // Hide loading indicator and show form
                loadingIndicator.classList.add('hidden');
                formContainer.classList.remove('hidden');
                
                // Fix: Pass the site_config object instead of the entire response
                populateForm(data.site_config);
                
                // Load work experience data if available
                if (data.work_experience) {
                    loadWorkExperienceData(data.work_experience);
                } else {
                    // Fetch work experience data separately if not included in site config
                    fetchWorkExperienceData();
                }
                
                // Load education data if available
                if (data.education) {
                    loadEducationData(data.education);
                } else {
                    // Fetch education data separately if not included in site config
                    fetchEducationData();
                }
            })
            .catch(error => {
                console.error('Error loading from API:', error);
                
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
                
                // Show error message
                apiError.classList.remove('hidden');
                apiError.textContent = 'Error loading configuration data: ' + error.message;
                setTimeout(() => {
                    apiError.classList.add('hidden');
                }, 5000);
                
                // Try loading from local JSON file as fallback
                console.log('Trying to load from local JSON file');
                fetch('/data/site_config.json')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Loaded from local JSON:', data);
                        let configData = data;
                        if (data.site_configs) {
                            configData = data.site_configs;
                        }
                        if (data.site_config) {
                            configData = data.site_config;
                        }
                        populateForm(configData);
                        formContainer.classList.remove('hidden');
                        
                        // Try to load work experience data from local file
                        fetch('/data/experience.json')
                            .then(response => response.json())
                            .then(expData => {
                                loadWorkExperienceData(expData);
                            })
                            .catch(err => {
                                console.error('Error loading work experience from local JSON:', err);
                                // Add empty work experience item
                                addWorkExperienceItem();
                            });
                            
                        // Try to load education data from local file
                        fetch('/data/education.json')
                            .then(response => response.json())
                            .then(eduData => {
                                loadEducationData(eduData);
                            })
                            .catch(err => {
                                console.error('Error loading education from local JSON:', err);
                                // Add empty education item
                                addEducationItem();
                            });
                    })
                    .catch(localError => {
                        console.error('Error loading from local JSON:', localError);
                        // Show form anyway with empty values
                        formContainer.classList.remove('hidden');
                        
                        // Add empty work experience item
                        addWorkExperienceItem();
                        
                        // Add empty education item
                        addEducationItem();
                    });
            });
        }
        
        // Populate form with site config data
        function populateForm(data) {
            console.log('Populating form with data:', data);
            
            // Populate simple text inputs
            document.getElementById('about_title').value = data.about_title || '';
            document.getElementById('about_subtitle').value = data.about_subtitle || '';
            document.getElementById('about_description').value = data.about_description || '';
            
            // Populate image URLs
            document.getElementById('image_favicon_url').value = data.image_favicon_url || '';
            document.getElementById('image_logo_url').value = data.image_logo_url || '';
            document.getElementById('image_banner_url').value = data.image_banner_url || '';
            document.getElementById('image_mobile_banner_url').value = data.image_mobile_banner_url || '';
            document.getElementById('image_about_profile_url').value = data.image_about_profile_url || '';
            
            // Populate gallery photos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`image_about_photo${i}_url`).value = data[`image_about_photo${i}_url`] || '';
                document.getElementById(`about_photo${i}_alt`).value = data[`about_photo${i}_alt`] || '';
            }
        }
        
        // Get form data
        function getFormData() {
            const formData = {};
            
            // Get simple text inputs
            formData.about_title = document.getElementById('about_title').value;
            formData.about_subtitle = document.getElementById('about_subtitle').value;
            formData.about_description = document.getElementById('about_description').value;
            
            // Get image URLs
            formData.image_favicon_url = document.getElementById('image_favicon_url').value;
            formData.image_logo_url = document.getElementById('image_logo_url').value;
            formData.image_banner_url = document.getElementById('image_banner_url').value;
            formData.image_mobile_banner_url = document.getElementById('image_mobile_banner_url').value;
            formData.image_about_profile_url = document.getElementById('image_about_profile_url').value;
            
            // Get gallery photos
            for (let i = 1; i <= 4; i++) {
                formData[`image_about_photo${i}_url`] = document.getElementById(`image_about_photo${i}_url`).value;
                formData[`about_photo${i}_alt`] = document.getElementById(`about_photo${i}_alt`).value;
            }
            
            return formData;
        }
        
        // Handle form submission
        siteConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            // Get the site config data
            const siteConfigData = getFormData();
            
            // Get the work experience data
            const workExperienceData = getWorkExperienceData();
            
            // Get education data
            const educationData = getEducationData();

            // Validate for required work experience fields
            const workExValidation = document.querySelectorAll('.workex-validation-error');
            if (workExValidation.length > 0) {
                console.error('Work experience validation errors found:', workExValidation.length);
                // Focus the first error
                workExValidation[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Don't submit if there are validation errors
            }
            
            // Validate for required education fields
            const eduValidation = document.querySelectorAll('.education-validation-error');
            if (eduValidation.length > 0) {
                console.error('Education validation errors found:', eduValidation.length);
                // Focus the first error
                eduValidation[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Don't submit if there are validation errors
            }
            
            // Show loading overlay
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            // Use the API endpoint to send the data
            const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?action=update_site_config';
            
            // Get the token from storage
                const token = localStorage.getItem('admin_token');
                
            // Check if token exists
                if (!token) {
                console.error('No admin token found for authorization');
                document.getElementById('loading-overlay').classList.add('hidden');
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
                errorMsg.innerHTML = '<strong>Error:</strong> Authorization required. Please log in again.';
                siteConfigForm.prepend(errorMsg);
                
                    setTimeout(() => {
                    logout();
                }, 2000);
                    
                    return;
                }
                
            // Prepare the data to send
            const payload = {
                site_config: siteConfigData,
                work_experience: workExperienceData,
                education: educationData
            };
            
            console.log('Sending payload:', payload);
            
            fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                    'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                body: JSON.stringify(payload),
                mode: 'cors'
            })
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`API response not OK: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Save successful:', data);

                // Hide loading overlay
                document.getElementById('loading-overlay').classList.add('hidden');
                    
                    // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4';
                successMsg.innerHTML = '<strong>Success:</strong> Changes saved successfully.';
                siteConfigForm.prepend(successMsg);
                
                // Remove message after a few seconds
                    setTimeout(() => {
                    successMsg.remove();
                }, 5000);
            })
            .catch(error => {
                console.error('Error saving data:', error);
                
                // Hide loading overlay
                document.getElementById('loading-overlay').classList.add('hidden');
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
                errorMsg.innerHTML = `<strong>Error:</strong> ${error.message}`;
                siteConfigForm.prepend(errorMsg);
                
                // Remove message after a few seconds
                setTimeout(() => {
                    errorMsg.remove();
                }, 5000);
            });
        });

        // Work Experience Functions
        function initWorkExperience() {
            console.log('Initializing work experience section');
            
            // Add event listener to the "Add Work Experience" button
            const addWorkExButton = document.getElementById('add-work-experience');
            if (addWorkExButton) {
                addWorkExButton.addEventListener('click', function() {
                    addWorkExperienceItem();
                });
            }
            
            // Initialize "current" checkbox behavior for existing items
            initCurrentCheckboxBehavior();
        }
        
        async function loadWorkExperienceData(existingData = null) {
            console.log('Loading work experience data...');
            
            // Re-query elements each time to ensure they are found
            const container = document.getElementById('work-experience-container');
            const loadingMsg = document.getElementById('work-experience-loading');
            
            if (!container) {
                console.error('Work experience container (#work-experience-container) not found! Cannot update UI.');
                return; // Exit if container is missing
            }
            if (!loadingMsg) {
                console.warn('Work experience loading message (#work-experience-loading) not found. Proceeding without it.');
            } else {
                 // Show loading message only if found
                 loadingMsg.style.display = 'block';
            }
            
            try {
                // Clear existing items from the container
                container.innerHTML = '';
                
                let experienceData = existingData;
                
                // If no existing data was provided, try to fetch it
                if (!experienceData) {
                    try {
                        // Use the same API endpoint as the site config but with work_experience type
                        const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=work_experience';
                        
                        const response = await fetch(apiEndpoint, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API request failed with status ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('Received work experience data from separate API call:', data);
                        experienceData = data.work_experience || data;
                    } catch (fetchError) {
                        console.error('Error fetching work experience data:', fetchError);
                    }
                }
                
                const items = experienceData && Array.isArray(experienceData) ? experienceData : [];

                if (items.length > 0) {
                     // Log the complete structure of the first item (if it exists)
                     console.log('First work experience item structure:', JSON.stringify(items[0], null, 2));
                    
                    // Sort items by from_date in descending order (newest first)
                    items.sort((a, b) => {
                        const dateA = a.from_date ? new Date(a.from_date) : new Date(0);
                        const dateB = b.from_date ? new Date(b.from_date) : new Date(0);
                        return dateB - dateA;
                    });
                    
                    // Add each work experience item to the container
                    items.forEach(item => {
                        console.log('Adding work experience item:', item);
                        addWorkExperienceItem(null, item);
                    });
                    
                } else {
                    console.log('No work experience data found or data is not an array, adding empty item');
                    addWorkExperienceItem(null); // Add an empty item if no data
                }
            } catch (error) {
                console.error('Error processing work experience data:', error);
                // Attempt to add an empty item even if there's an error during processing
                 if (container) {
                     container.innerHTML = ''; // Clear potentially broken state
                     addWorkExperienceItem(null);
                     // Show error message within the container
                     const errorMsg = document.createElement('p');
                     errorMsg.className = 'error-message';
                     errorMsg.textContent = 'Failed to load or process work experience data. Displaying empty item.';
                     container.appendChild(errorMsg);
                 }
            } finally {
                // Hide loading message only if it was found initially
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
            }
        }
        
        function addWorkExperienceItem(e, data = {}) {
            if (e) e.preventDefault();
            
            console.log('Adding work experience item with data:', data);
            // Debug the entire work experience object
            console.log('Data object structure:', JSON.stringify(data, null, 2));
            
            const container = document.getElementById('work-experience-container');
            if (!container) {
                console.error('Work experience container not found');
                return;
            }
            
            const workExItem = document.createElement('div');
            workExItem.className = 'workex-item';
            workExItem.dataset.id = data.id || '';
            
            // Debug log to see what's in the job_title field
            console.log('Job title from data:', data.job_title);
            console.log('Company name from data:', data.company_name);
            
            // Create job title field
            const titleLabel = document.createElement('label');
            titleLabel.textContent = 'Job Title*:';
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'workex-title';
            titleInput.id = `workex-title-${Date.now()}`; // Unique ID for toolbar
            titleInput.required = true;
            titleInput.value = data.job_title || '';
            titleInput.placeholder = 'e.g. Software Engineer';
            
            // Create company name field
            const companyLabel = document.createElement('label');
            companyLabel.textContent = 'Company*:';
            const companyInput = document.createElement('input');
            companyInput.type = 'text';
            companyInput.className = 'workex-company';
            companyInput.id = `workex-company-${Date.now()}`; // Unique ID for toolbar
            companyInput.required = true;
            companyInput.value = data.company_name || '';
            companyInput.placeholder = 'e.g. Tech Company Inc.';
            
            // Create location field
            const locationLabel = document.createElement('label');
            locationLabel.textContent = 'Location:';
            const locationInput = document.createElement('input');
            locationInput.type = 'text';
            locationInput.className = 'workex-location';
            locationInput.id = `workex-location-${Date.now()}`; // Unique ID for toolbar
            locationInput.value = data.location || '';
            locationInput.placeholder = 'e.g. New York, NY';
            
            // Create dates container
            const datesContainer = document.createElement('div');
            datesContainer.className = 'workex-dates';
            
            // From date field
            const fromLabel = document.createElement('label');
            fromLabel.textContent = 'From:';
            const fromInput = document.createElement('input');
            fromInput.type = 'date';
            fromInput.className = 'workex-from-date';
            fromInput.value = data.from_date || '';
            
            // To date field
            const toLabel = document.createElement('label');
            toLabel.textContent = 'To:';
            const toInput = document.createElement('input');
            toInput.type = 'date';
            toInput.className = 'workex-to-date';
            toInput.value = data.to_date || '';
            
            // Current job checkbox
            const currentContainer = document.createElement('div');
            currentContainer.className = 'workex-current';
            const currentLabel = document.createElement('label');
            currentLabel.textContent = 'Current Job:';
            const currentInput = document.createElement('input');
            currentInput.type = 'checkbox';
            currentInput.className = 'workex-is-current';
            currentInput.checked = !!data.is_current;
            
            // Add event listener to disable to_date if current job is checked
            currentInput.addEventListener('change', function() {
                toInput.disabled = this.checked;
                if (this.checked) {
                    toInput.value = '';
                }
            });
            
            // Set initial state of to_date based on is_current
            toInput.disabled = currentInput.checked;
            
            // Add date fields to date container
            datesContainer.appendChild(fromLabel);
            datesContainer.appendChild(fromInput);
            datesContainer.appendChild(toLabel);
            datesContainer.appendChild(toInput);
            currentContainer.appendChild(currentLabel);
            currentContainer.appendChild(currentInput);
            datesContainer.appendChild(currentContainer);
            
            // Create description field
            const descLabel = document.createElement('label');
            descLabel.textContent = 'Description:';
            const descInput = document.createElement('textarea');
            descInput.className = 'workex-description';
            descInput.id = `workex-desc-${Date.now()}`; // Unique ID for toolbar
            descInput.value = data.description || '';
            descInput.placeholder = 'Describe your responsibilities and achievements...';
            descInput.rows = 4;
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'workex-delete-btn';
            deleteBtn.textContent = 'Delete';
            
            // Add a hidden input to track deletion status
            const deletedInput = document.createElement('input');
            deletedInput.type = 'hidden';
            deletedInput.className = 'workex-is-deleted';
            // Initialize based on DB state if available (should always be 0 when adding)
            deletedInput.value = '0'; 
            workExItem.appendChild(deletedInput);

            // Modify the delete button's event listener
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Mark this item for deletion? It will be removed when you save changes.')) {
                    // Mark as deleted by setting the hidden input value
                    const hiddenDeleteInput = workExItem.querySelector('.workex-is-deleted');
                    if (hiddenDeleteInput) {
                        hiddenDeleteInput.value = '1';
                    }
                    // Add a visual cue 
                    workExItem.classList.add('marked-for-deletion');
                    
                    // Disable fields and change button state
                    workExItem.querySelectorAll('input:not([type="hidden"]), textarea').forEach(el => {
                       el.disabled = true;
                    });
                    deleteBtn.textContent = 'Marked for Deletion';
                    deleteBtn.disabled = true;
                    console.log(`Marked item ID ${workExItem.dataset.id || '(new)'} for deletion.`);
                }
            });
            
            // Add fields to work experience item
            workExItem.appendChild(titleLabel);
            workExItem.appendChild(titleInput);
            workExItem.appendChild(companyLabel);
            workExItem.appendChild(companyInput);
            workExItem.appendChild(locationLabel);
            workExItem.appendChild(locationInput);
            workExItem.appendChild(datesContainer);
            workExItem.appendChild(descLabel);
            workExItem.appendChild(descInput);
            workExItem.appendChild(deleteBtn);
            
            // Add work experience item to container
            container.appendChild(workExItem);
            
            // Create formatting toolbars for rich text fields
            createRichTextToolbar(titleInput.id);
            createRichTextToolbar(companyInput.id);
            createRichTextToolbar(locationInput.id);
            createRichTextToolbar(descInput.id);
            
            return workExItem;
        }
        
        function initCurrentCheckboxBehavior() {
            // Find checkboxes within the dynamically added .workex-item elements
            const checkboxes = document.querySelectorAll('.workex-item .workex-is-current'); 
            checkboxes.forEach(checkbox => {
                // Find the parent .workex-item and then the date input within it
                const parentItem = checkbox.closest('.workex-item'); 
                if (!parentItem) return; // Skip if parent item not found
                
                const toDateInput = parentItem.querySelector('.workex-to-date');
                if (toDateInput) {
                    // Set initial state
                    if (checkbox.checked) {
                        toDateInput.disabled = true;
                        toDateInput.value = ''; // Clear value when disabled
                    } else {
                        toDateInput.disabled = false; 
                    }
                    
                    // Add change listener
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            toDateInput.disabled = true;
                            toDateInput.value = ''; // Clear value when disabled
                        } else {
                            toDateInput.disabled = false;
                        }
                    });
                }
            });
        }
        
        function getWorkExperienceData() {
            const workExItems = document.querySelectorAll('.workex-item');
            const data = [];
            
            workExItems.forEach(item => {
                const jobTitle = item.querySelector('.workex-title')?.value || '';
                const company = item.querySelector('.workex-company')?.value || '';
                
                // Do NOT skip items marked for deletion, we need to send their status
                // if (!jobTitle.trim() || !company.trim()) {
                //    console.log('Skipping work experience item with empty required fields');
                //    return;
                // }
                
                // Build work experience data object with correct field names
                const workExData = {
                    id: item.dataset.id || '',
                    job_title: jobTitle,
                    company_name: company,
                    location: item.querySelector('.workex-location')?.value || '',
                    from_date: item.querySelector('.workex-from-date')?.value || '',
                    to_date: item.querySelector('.workex-to-date')?.value || '',
                    is_current: item.querySelector('.workex-is-current')?.checked || false,
                    description: item.querySelector('.workex-description')?.value || '',
                    // Add the deletion status from the hidden input
                    is_deleted: parseInt(item.querySelector('.workex-is-deleted')?.value || '0', 10) // Default to 0 if not found
                };
                
                // Only include items if they have required fields OR are marked for deletion
                if ((jobTitle.trim() && company.trim()) || workExData.is_deleted === 1) {
                    console.log('Created work experience data object:', workExData);
                    data.push(workExData);
                } else {
                    console.log('Skipping item with empty required fields that is NOT marked for deletion:', item.dataset.id);
                }
            });
            
            console.log('Collected work experience data:', data);
            return data;
        }

        // Initialize work experience function on load
        initWorkExperience();

        // Add refresh button event listener
        const refreshButton = document.getElementById('refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                console.log('Refreshing data');
                // Show loading indicator
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (formContainer) formContainer.classList.add('hidden');
                
                // Load configuration again
                loadSiteConfig();
            });
        }

        // Education Functions
        function initEducation() {
            console.log('Initializing education section');
            
            // Add event listener to the "Add Education" button
            const addEduButton = document.getElementById('add-education-button');
            if (addEduButton) {
                addEduButton.addEventListener('click', function() {
                    addEducationItem();
                });
            }
        }
        
        function addEducationItem(itemData = {}, index = Date.now()) {
            console.log('Adding education item:', itemData);
            const container = document.getElementById('education-items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'education-item bg-gray-50 rounded-md p-4 my-4 border border-gray-200';
            itemDiv.dataset.id = itemData.id || '';
            
            // Add marked-for-deletion class if loaded item is already marked
            if (parseInt(itemData.is_deleted || 0) === 1) {
                itemDiv.classList.add('marked-for-deletion');
            }
            
            itemDiv.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-base font-medium text-gray-800">Education Entry</h4>
                    <button type="button" class="delete-education text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <input type="hidden" class="education-id" name="education_id" value="${itemData.id || ''}">
                <input type="hidden" class="education-is-deleted" name="education_is_deleted" value="${itemData.is_deleted || 0}">
                
                <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-2">
                    <!-- Degree Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Degree Name*</label>
                        <input type="text" class="education-title mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.edu_title || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Institution Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Institution Name*</label>
                        <input type="text" class="education-name mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border" 
                            value="${itemData.edu_name || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                    </div>
                    
                    <!-- Location -->
                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" class="education-location mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                            value="${itemData.location || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">From Date*</label>
                            <input type="date" class="education-from-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                                value="${itemData.from_date || ''}" ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''} required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">To Date</label>
                            <input type="date" class="education-to-date mt-1 p-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border"
                                value="${itemData.to_date || ''}" ${(itemData.is_current || parseInt(itemData.is_deleted || 0) === 1) ? 'disabled' : ''}>
                        </div>

                        <div class="flex items-center pb-2">
                            <input type="checkbox" class="education-current h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                ${itemData.is_current ? 'checked' : ''} ${parseInt(itemData.is_deleted || 0) === 1 ? 'disabled' : ''}>
                            <label class="ml-2 block text-sm text-gray-700">Currently Enrolled</label>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(itemDiv);
            
            // Hide the loading message if it exists
            const loadingMsg = document.getElementById('education-loading-message');
            if (loadingMsg) {
                loadingMsg.classList.add('hidden');
            }
            
            // Add event listener for the current checkbox
            const currentCheckbox = itemDiv.querySelector('.education-current');
            const toDateInput = itemDiv.querySelector('.education-to-date');
            
            if (currentCheckbox && toDateInput) {
                currentCheckbox.addEventListener('change', function() {
                    toDateInput.disabled = this.checked;
                    if (this.checked) {
                        toDateInput.value = '';
                    }
                });
            }
            
            // Add event listener for the delete button
            const deleteButton = itemDiv.querySelector('.delete-education');
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    const isDeletedInput = itemDiv.querySelector('.education-is-deleted');
                    
                    // Toggle the deletion state
                    const isCurrentlyDeleted = parseInt(isDeletedInput.value || '0') === 1;
                    isDeletedInput.value = isCurrentlyDeleted ? '0' : '1';
                    
                    // Update visual indicators and disable inputs
                    if (!isCurrentlyDeleted) {
                        // Mark for deletion
                        itemDiv.classList.add('marked-for-deletion');
                        deleteButton.innerHTML = 'Marked for Deletion';
                        
                        // Disable all inputs in this item
                        itemDiv.querySelectorAll('input:not(.education-is-deleted), textarea').forEach(input => {
                            input.disabled = true;
                        });
                    } else {
                        // Unmark from deletion
                        itemDiv.classList.remove('marked-for-deletion');
                        deleteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        `;
                        
                        // Re-enable all inputs except the "to date" if "current" is checked
                        itemDiv.querySelectorAll('input:not(.education-is-deleted), textarea').forEach(input => {
                            if (input.classList.contains('education-to-date') && currentCheckbox.checked) {
                                input.disabled = true;
                            } else {
                                input.disabled = false;
                            }
                        });
                    }
                });
            }
        }
        
        // Get education data from the form
        function getEducationData() {
            const educationItems = document.querySelectorAll('.education-item');
            const data = [];
            
            educationItems.forEach(item => {
                // Check if the item is marked for deletion
                const isDeleted = parseInt(item.querySelector('.education-is-deleted').value || '0');
                
                // Get all field values
                const id = item.querySelector('.education-id').value || null;
                const eduTitle = item.querySelector('.education-title').value;
                const eduName = item.querySelector('.education-name').value;
                const location = item.querySelector('.education-location').value;
                const fromDate = item.querySelector('.education-from-date').value;
                const toDate = item.querySelector('.education-to-date').value;
                const isCurrent = item.querySelector('.education-current').checked;
                
                // Skip validation for items marked for deletion
                if (isDeleted === 0) {
                    // Basic validation for required fields
                    let isValid = true;
                    
                    if (!eduTitle) {
                        item.querySelector('.education-title').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-title').classList.remove('border-red-500');
                    }
                    
                    if (!eduName) {
                        item.querySelector('.education-name').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-name').classList.remove('border-red-500');
                    }
                    
                    if (!fromDate) {
                        item.querySelector('.education-from-date').classList.add('border-red-500');
                        isValid = false;
                    } else {
                        item.querySelector('.education-from-date').classList.remove('border-red-500');
                    }
                    
                    if (!isValid) {
                        console.error('Education item has validation errors');
                        item.classList.add('education-validation-error');
                    } else {
                        item.classList.remove('education-validation-error');
                    }
                }
                
                // Create an education object
                const educationObject = {
                    id: id,
                    edu_title: eduTitle,
                    edu_name: eduName,
                    location: location,
                    from_date: fromDate || null,
                    to_date: isCurrent ? null : (toDate || null),
                    is_current: isCurrent,
                    is_deleted: isDeleted
                };
                
                // Add to the data array
                data.push(educationObject);
            });
            
            return data;
        }
        
        // Load education data into the form
        function loadEducationData(educationItems) {
            console.log('Loading education data:', educationItems);
            
            // Get the container
            const container = document.getElementById('education-items-container');
            if (!container) {
                console.error('Education container not found');
                return;
            }
            
            // Clear the container
            container.innerHTML = '';
            
            // If no education items, add an empty one
            if (!educationItems || educationItems.length === 0) {
                addEducationItem();
                return;
            }
            
            // Otherwise, add each item to the form
            educationItems.forEach(item => addEducationItem(item));
        }
        
        // Fetch education data separately if needed
        async function fetchEducationData() {
            console.log('Fetching education data separately');
            
            try {
                const apiEndpoint = 'https://zelbc2vwg2.execute-api.eu-north-1.amazonaws.com/Staging/website-portfolio?type=education';
                
                const response = await fetch(apiEndpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`API response not OK: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Successfully loaded education data:', data);
                
                // Load the education data
                loadEducationData(data.education || []);
            } catch (error) {
                console.error('Error fetching education data:', error);
                
                // Try loading from local JSON as fallback
                try {
                    const localResponse = await fetch('/data/education.json');
                    const localData = await localResponse.json();
                    loadEducationData(localData);
                } catch (localError) {
                    console.error('Error loading from local education JSON:', localError);
                    // Add an empty education item
                    addEducationItem();
                }
            }
        }
    });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                    }
                }
            }
        }
    </script>
    <style>
        .education-item {
            transition: all 0.3s ease;
        }
        .education-item.deleted {
            opacity: 0.5;
            background-color: #FEE2E2;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100">
    <div id="header-container"></div>

    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Education Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Education</h2>
                    <button id="add-education-btn" class="px-4 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Education
                    </button>
                </div>
                
                <div id="education-items-container" class="space-y-5">
                    <!-- Education items will be added here dynamically -->
                </div>
                
                <div class="flex justify-end mt-6">
                    <button id="save-education-btn" class="px-6 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Education
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-md shadow-md transform transition-transform duration-300 translate-x-full z-50">
        <div class="flex items-center">
            <i id="notification-icon" class="fas mr-2"></i>
            <p id="notification-message"></p>
        </div>
    </div>

    <script src="js/admin-utils.js"></script>
    <script>
        // Load header and footer components
        fetch('components/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
                const currentPage = 'education';
                document.querySelector(`.nav-link[data-page="${currentPage}"]`).classList.add('bg-gray-200');
            });

        fetch('components/footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-container').innerHTML = data;
            });

        // Education Functions
        function addEducationItem(data = {}) {
            const container = document.getElementById('education-items-container');
            const itemId = Date.now(); // Generate unique ID
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'education-item border rounded-lg p-4 ' + (data.deleted ? 'deleted' : '');
            itemDiv.setAttribute('data-id', itemId);
            itemDiv.setAttribute('data-deleted', data.deleted ? 'true' : 'false');
            
            itemDiv.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-lg font-medium">Education Item</h3>
                    <div class="flex space-x-2">
                        <button class="move-up-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="move-down-btn px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="toggle-delete-btn px-2 py-1 ${data.deleted ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'} rounded hover:opacity-80">
                            ${data.deleted ? '<i class="fas fa-undo"></i>' : '<i class="fas fa-trash"></i>'}
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Degree*</label>
                        <input type="text" class="degree w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.degree || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Institution*</label>
                        <input type="text" class="institution w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.institution || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Year*</label>
                        <input type="number" min="1900" max="2099" step="1" class="start-year w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.startYear || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                    
                    <div class="end-year-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Year*</label>
                        <div class="flex items-center">
                            <input type="number" min="1900" max="2099" step="1" class="end-year w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                value="${data.endYear || ''}" ${data.current || data.deleted ? 'disabled' : ''}>
                            <div class="ml-2 flex items-center">
                                <input type="checkbox" class="current-education h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                                    ${data.current ? 'checked' : ''} ${data.deleted ? 'disabled' : ''}>
                                <label class="ml-1 text-sm text-gray-700">Current</label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" class="location w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.location || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Institution URL</label>
                        <input type="url" class="institution-url w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.institutionUrl || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea class="description w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        rows="4" ${data.deleted ? 'disabled' : ''}>${data.description || ''}</textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPA</label>
                        <input type="text" class="gpa w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.gpa || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Major/Field of Study</label>
                        <input type="text" class="field-of-study w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="${data.fieldOfStudy || ''}" ${data.deleted ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Achievements & Activities</label>
                    <div class="achievements-container space-y-2">
                        ${generateAchievementsHTML(data.achievements || [], data.deleted)}
                    </div>
                    <button class="add-achievement-btn mt-2 px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300" 
                        ${data.deleted ? 'disabled' : ''}>
                        <i class="fas fa-plus mr-1"></i>Add Achievement
                    </button>
                </div>
            `;
            
            container.appendChild(itemDiv);
            
            // Add event listeners
            const currentEducationCheckbox = itemDiv.querySelector('.current-education');
            const endYearInput = itemDiv.querySelector('.end-year');
            
            if (currentEducationCheckbox) {
                currentEducationCheckbox.addEventListener('change', function() {
                    endYearInput.disabled = this.checked;
                    if (this.checked) {
                        endYearInput.value = '';
                    }
                });
            }
            
            const addAchievementBtn = itemDiv.querySelector('.add-achievement-btn');
            if (addAchievementBtn) {
                addAchievementBtn.addEventListener('click', function() {
                    addAchievementItem(this.parentElement.querySelector('.achievements-container'), '');
                });
            }
            
            const toggleDeleteBtn = itemDiv.querySelector('.toggle-delete-btn');
            if (toggleDeleteBtn) {
                toggleDeleteBtn.addEventListener('click', function() {
                    toggleDeleteItem(itemDiv);
                });
            }
            
            const moveUpBtn = itemDiv.querySelector('.move-up-btn');
            if (moveUpBtn) {
                moveUpBtn.addEventListener('click', function() {
                    moveItemUp(itemDiv);
                });
            }
            
            const moveDownBtn = itemDiv.querySelector('.move-down-btn');
            if (moveDownBtn) {
                moveDownBtn.addEventListener('click', function() {
                    moveItemDown(itemDiv);
                });
            }
        }

        function generateAchievementsHTML(achievements, isDisabled) {
            if (!achievements || achievements.length === 0) {
                return addAchievementItem(null, '', isDisabled, true);
            }
            
            let html = '';
            achievements.forEach(achievement => {
                html += addAchievementItem(null, achievement, isDisabled, true);
            });
            
            return html;
        }

        function addAchievementItem(container, value = '', isDisabled = false, returnHTML = false) {
            const html = `
                <div class="achievement-item flex items-center">
                    <input type="text" class="achievement w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        value="${value}" ${isDisabled ? 'disabled' : ''}>
                    <button class="remove-achievement-btn ml-2 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200" 
                        ${isDisabled ? 'disabled' : ''}>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            if (returnHTML) {
                return html;
            }
            
            if (container) {
                container.insertAdjacentHTML('beforeend', html);
                const newItem = container.lastElementChild;
                const removeBtn = newItem.querySelector('.remove-achievement-btn');
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        newItem.remove();
                    });
                }
            }
        }

        function toggleDeleteItem(itemDiv) {
            const isDeleted = itemDiv.getAttribute('data-deleted') === 'true';
            const newState = !isDeleted;
            
            itemDiv.setAttribute('data-deleted', newState);
            
            if (newState) {
                itemDiv.classList.add('deleted');
                itemDiv.querySelectorAll('input, textarea, select').forEach(input => {
                    input.disabled = true;
                });
                itemDiv.querySelectorAll('button:not(.toggle-delete-btn)').forEach(button => {
                    button.disabled = true;
                });
                
                const toggleBtn = itemDiv.querySelector('.toggle-delete-btn');
                toggleBtn.classList.remove('bg-red-500');
                toggleBtn.classList.add('bg-blue-500');
                toggleBtn.innerHTML = '<i class="fas fa-undo"></i>';
            } else {
                itemDiv.classList.remove('deleted');
                itemDiv.querySelectorAll('input, textarea, select').forEach(input => {
                    if (input.classList.contains('end-year')) {
                        const currentCheckbox = itemDiv.querySelector('.current-education');
                        if (currentCheckbox && currentCheckbox.checked) {
                            return; // Keep end year disabled if "current" is checked
                        }
                    }
                    input.disabled = false;
                });
                itemDiv.querySelectorAll('button:not(.toggle-delete-btn)').forEach(button => {
                    button.disabled = false;
                });
                
                const toggleBtn = itemDiv.querySelector('.toggle-delete-btn');
                toggleBtn.classList.remove('bg-blue-500');
                toggleBtn.classList.add('bg-red-500');
                toggleBtn.innerHTML = '<i class="fas fa-trash"></i>';
            }
        }

        function moveItemUp(itemDiv) {
            const prevItem = itemDiv.previousElementSibling;
            if (prevItem) {
                itemDiv.parentNode.insertBefore(itemDiv, prevItem);
            }
        }

        function moveItemDown(itemDiv) {
            const nextItem = itemDiv.nextElementSibling;
            if (nextItem) {
                itemDiv.parentNode.insertBefore(nextItem, itemDiv);
            }
        }

        function validateEducationForm() {
            let isValid = true;
            const items = document.querySelectorAll('.education-item:not(.deleted)');
            
            items.forEach(item => {
                const degreeInput = item.querySelector('.degree');
                const institutionInput = item.querySelector('.institution');
                const startYearInput = item.querySelector('.start-year');
                const endYearInput = item.querySelector('.end-year');
                const currentEducationCheckbox = item.querySelector('.current-education');
                
                const requiredInputs = [degreeInput, institutionInput, startYearInput];
                
                // Add end year to required inputs only if "current" is not checked
                if (!currentEducationCheckbox.checked) {
                    requiredInputs.push(endYearInput);
                }
                
                requiredInputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('border-red-500');
                        isValid = false;
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });
            });
            
            return isValid;
        }

        function getEducationData() {
            const items = document.querySelectorAll('.education-item');
            const data = [];
            
            items.forEach(item => {
                const isDeleted = item.getAttribute('data-deleted') === 'true';
                
                // Skip completely deleted items
                if (isDeleted) return;
                
                const degreeInput = item.querySelector('.degree');
                const institutionInput = item.querySelector('.institution');
                const startYearInput = item.querySelector('.start-year');
                const endYearInput = item.querySelector('.end-year');
                const currentEducationCheckbox = item.querySelector('.current-education');
                const locationInput = item.querySelector('.location');
                const institutionUrlInput = item.querySelector('.institution-url');
                const descriptionInput = item.querySelector('.description');
                const gpaInput = item.querySelector('.gpa');
                const fieldOfStudyInput = item.querySelector('.field-of-study');
                
                const achievementItems = Array.from(item.querySelectorAll('.achievement-item'));
                const achievements = achievementItems.map(achieveItem => {
                    const input = achieveItem.querySelector('.achievement');
                    return input.value.trim();
                }).filter(text => text !== '');
                
                data.push({
                    degree: degreeInput.value.trim(),
                    institution: institutionInput.value.trim(),
                    startYear: startYearInput.value ? parseInt(startYearInput.value) : null,
                    endYear: currentEducationCheckbox.checked ? null : (endYearInput.value ? parseInt(endYearInput.value) : null),
                    current: currentEducationCheckbox.checked,
                    location: locationInput.value.trim(),
                    institutionUrl: institutionUrlInput.value.trim(),
                    description: descriptionInput.value.trim(),
                    gpa: gpaInput.value.trim(),
                    fieldOfStudy: fieldOfStudyInput.value.trim(),
                    achievements: achievements
                });
            });
            
            return data;
        }

        async function loadEducation() {
            showLoading(true);
            try {
                const response = await fetchFromAPI('/education');
                if (response && response.data) {
                    const container = document.getElementById('education-items-container');
                    container.innerHTML = ''; // Clear container
                    
                    if (response.data.length === 0) {
                        // Add empty education item if no education exists
                        addEducationItem();
                    } else {
                        // Add education items from data
                        response.data.forEach(educationItem => {
                            addEducationItem(educationItem);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading education:', error);
                showNotification('Failed to load education', 'error');
                
                // Load local JSON data as fallback
                try {
                    const localResponse = await fetch('../js/education.json');
                    if (localResponse.ok) {
                        const data = await localResponse.json();
                        
                        const container = document.getElementById('education-items-container');
                        container.innerHTML = ''; // Clear container
                        
                        if (!data || data.length === 0) {
                            // Add empty education item if no education exists
                            addEducationItem();
                        } else {
                            // Add education items from data
                            data.forEach(educationItem => {
                                addEducationItem(educationItem);
                            });
                        }
                    }
                } catch (localError) {
                    console.error('Error loading local education:', localError);
                    // Add empty education item if everything fails
                    const container = document.getElementById('education-items-container');
                    container.innerHTML = ''; // Clear container
                    addEducationItem();
                }
            } finally {
                showLoading(false);
            }
        }

        async function saveEducation() {
            if (!validateEducationForm()) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const data = getEducationData();
            console.log('Education Data:', data);
            
            showLoading(true);
            try {
                const response = await fetchFromAPI('/education', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response && response.success) {
                    showNotification('Education saved successfully');
                } else {
                    throw new Error('Failed to save education');
                }
            } catch (error) {
                console.error('Error saving education:', error);
                showNotification('Failed to save education', 'error');
            } finally {
                showLoading(false);
            }
        }

        function initEducationPage() {
            // Load education
            loadEducation();
            
            // Add education button
            document.getElementById('add-education-btn').addEventListener('click', function() {
                addEducationItem();
            });
            
            // Save education button
            document.getElementById('save-education-btn').addEventListener('click', saveEducation);
            
            // Remove error indicator when user starts typing
            document.addEventListener('input', function(event) {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    event.target.classList.remove('border-red-500');
                }
            });
        }

        // Initialize page
        initPage(initEducationPage);
    </script>
</body>
</html> 
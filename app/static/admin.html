<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Admin | Jayant Arora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .admin-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            display: block;
            margin-top: 0.75rem;
            border-radius: 4px;
            object-fit: cover;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .photo-item {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        #status-message {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h1 class="mb-4 text-center">Site Content Admin</h1>
                
                <div id="status-message"></div>
                
                <div class="admin-panel">
                    <h2 class="mb-4">Edit About Section</h2>
                    
                    <form id="about-form">
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="subtitle" class="form-label">Subtitle</label>
                            <input type="text" class="form-control" id="subtitle" name="subtitle" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="6" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="profile_image" class="form-label">Profile Image URL</label>
                            <input type="text" class="form-control" id="profile_image" name="profile_image">
                            <div id="profile-image-preview"></div>
                        </div>
                        
                        <div class="mb-4">
                            <h4>Photos</h4>
                            <div id="photos-container" class="photo-grid">
                                <!-- Photos will be dynamically added here -->
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="/" class="btn btn-secondary">Back to Site</a>
                            <button type="button" id="reload-btn" class="btn btn-info">Reload Data</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
                
                <div class="admin-panel">
                    <h2 class="mb-3">Content Information</h2>
                    <div id="content-info">
                        <p>Loading content information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Store API token in session storage (in a real app, use a more secure approach)
        let apiToken = sessionStorage.getItem('admin_token');
        console.log('Initial token state:', apiToken ? 'Token found in session' : 'No token in session');
        
        const aboutForm = document.getElementById('about-form');
        const reloadBtn = document.getElementById('reload-btn');
        const statusMessage = document.getElementById('status-message');
        const contentInfo = document.getElementById('content-info');
        
        // Function to show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = type === 'success' ? 'status-success' : 'status-error';
            statusMessage.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Function to format date in IST timezone
        function formatDateIST(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-IN', { 
                    timeZone: 'Asia/Kolkata',
                    dateStyle: 'medium', 
                    timeStyle: 'medium' 
                }) + ' IST';
            } catch (e) {
                return dateString + ' (unable to format)';
            }
        }
        
        // Function to load content
        async function loadContent() {
            try {
                aboutForm.classList.add('loading');
                contentInfo.innerHTML = '<p>Loading content information...</p>';
                
                let data = null;
                let source = 'unknown';
                
                // Try the Netlify function first
                try {
                    console.log('Fetching content from Netlify function...');
                    const response = await fetch('/.netlify/functions/get-content');
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error:', response.status, errorText);
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    data = await response.json();
                    source = 'netlify_function';
                    console.log('Successfully loaded from Netlify function');
                } catch (apiError) {
                    console.warn('Failed to load from API:', apiError.message);
                    
                    // Try the static JSON file as fallback
                    try {
                        console.log('Trying static JSON fallback...');
                        const jsonResponse = await fetch('/data/site_config.json');
                        
                        if (!jsonResponse.ok) {
                            throw new Error(`JSON file error: ${jsonResponse.status}`);
                        }
                        
                        data = await jsonResponse.json();
                        source = 'static_json';
                        console.log('Successfully loaded from static JSON');
                    } catch (jsonError) {
                        console.error('Failed to load from static JSON:', jsonError.message);
                        showStatus(`Failed to load content: ${jsonError.message}`, 'error');
                        
                        // Create default content as last resort
                        data = {
                            about_content: {
                                title: '',
                                subtitle: '',
                                description: '',
                                profile_image: '',
                                photos: []
                            },
                            source: 'default_fallback',
                            timestamp: new Date().toISOString()
                        };
                        source = 'default';
                        console.log('Using default empty content');
                    }
                }
                
                if (data) {
                    console.log('Using content from source:', source);
                    
                    // Populate form fields
                    document.getElementById('title').value = data.about_content?.title || '';
                    document.getElementById('subtitle').value = data.about_content?.subtitle || '';
                    document.getElementById('description').value = data.about_content?.description || '';
                    document.getElementById('profile_image').value = data.about_content?.profile_image || '';
                    
                    // Show profile image preview
                    const profilePreview = document.getElementById('profile-image-preview');
                    profilePreview.innerHTML = '';
                    if (data.about_content?.profile_image) {
                        const img = document.createElement('img');
                        img.src = data.about_content.profile_image;
                        img.alt = 'Profile Preview';
                        img.className = 'preview-image mt-2';
                        profilePreview.appendChild(img);
                    }
                    
                    // Populate photos
                    const photosContainer = document.getElementById('photos-container');
                    photosContainer.innerHTML = '';
                    
                    // Ensure we have at least 4 photo slots
                    const photoCount = Math.max(4, data.about_content?.photos?.length || 0);
                    
                    for (let i = 0; i < photoCount; i++) {
                        const photo = (data.about_content?.photos && i < data.about_content.photos.length) 
                            ? data.about_content.photos[i] 
                            : { url: '', alt: '' };
                        
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        
                        const photoTitle = document.createElement('h5');
                        photoTitle.textContent = `Photo ${i + 1}`;
                        
                        const urlInput = document.createElement('input');
                        urlInput.type = 'text';
                        urlInput.className = 'form-control mb-2';
                        urlInput.placeholder = 'Photo URL';
                        urlInput.value = photo.url || '';
                        urlInput.name = `photo${i + 1}_url`;
                        
                        const altInput = document.createElement('input');
                        altInput.type = 'text';
                        altInput.className = 'form-control mb-2';
                        altInput.placeholder = 'Alt Text';
                        altInput.value = photo.alt || '';
                        altInput.name = `photo${i + 1}_alt`;
                        
                        const preview = document.createElement('div');
                        preview.className = 'photo-preview';
                        
                        if (photo.url) {
                            const img = document.createElement('img');
                            img.src = photo.url;
                            img.alt = photo.alt || `Photo ${i + 1}`;
                            img.className = 'preview-image';
                            preview.appendChild(img);
                        }
                        
                        photoItem.appendChild(photoTitle);
                        photoItem.appendChild(urlInput);
                        photoItem.appendChild(altInput);
                        photoItem.appendChild(preview);
                        photosContainer.appendChild(photoItem);
                    }
                    
                    // Display content info
                    contentInfo.innerHTML = `
                        <p><strong>Content Source:</strong> ${source}</p>
                        <p><strong>Last Updated:</strong> ${formatDateIST(data.last_updated || data.exported_at)}</p>
                        <p><strong>Source:</strong> ${data.update_source || data.export_source || source}</p>
                        <p><strong>Served By:</strong> ${data.served_by || source}</p>
                        <p><strong>Timestamp:</strong> ${formatDateIST(data.timestamp)}</p>
                    `;
                    
                    if (source !== 'default') {
                        showStatus('Content loaded successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Error loading content:', error);
                showStatus('Failed to load content: ' + error.message, 'error');
            } finally {
                aboutForm.classList.remove('loading');
            }
        }
        
        // Function to save content
        async function saveContent(event) {
            event.preventDefault();
            
            try {
                aboutForm.classList.add('loading');
                
                // Get form values
                const title = document.getElementById('title').value;
                const subtitle = document.getElementById('subtitle').value;
                const description = document.getElementById('description').value;
                const profileImage = document.getElementById('profile_image').value;
                
                // Get photos
                const photos = [];
                const photoItems = document.querySelectorAll('.photo-item');
                
                photoItems.forEach((item, index) => {
                    const urlInput = item.querySelector(`input[name="photo${index + 1}_url"]`);
                    const altInput = item.querySelector(`input[name="photo${index + 1}_alt"]`);
                    
                    if (urlInput && urlInput.value) {
                        photos.push({
                            url: urlInput.value,
                            alt: altInput ? altInput.value : `Photo ${index + 1}`
                        });
                    }
                });
                
                // Prepare payload
                const payload = {
                    title,
                    subtitle,
                    description,
                    profile_image: profileImage,
                    photos
                };
                
                console.log('Saving content with token:', apiToken ? 'Token present' : 'No token');
                
                // Send to API
                const response = await fetch('/.netlify/functions/update-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                // Check response status
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: 'Unknown error', details: errorText };
                    }
                    
                    console.error('API error response:', errorData);
                    
                    // Show appropriate error message based on status code
                    if (response.status === 401) {
                        showStatus(`Authentication failed: ${errorData.details || 'Invalid token'}. Please refresh and enter a valid token.`, 'error');
                    } else if (response.status === 400) {
                        showStatus(`Validation error: ${errorData.error || 'Missing required fields'}`, 'error');
                    } else if (response.status === 500) {
                        if (errorData.details && errorData.details.includes("Required environment variables not set")) {
                            showStatus(`Server configuration error: GitHub token and repository info not set in Netlify. Please check the README troubleshooting section.`, 'error');
                        } else {
                            showStatus(`Server error: ${errorData.details || 'Unknown server error'}. Check console for details.`, 'error');
                        }
                        console.error('Full error details:', errorData);
                    } else {
                        showStatus(`Failed to save content: ${errorData.error || 'Unknown error'} (${response.status})`, 'error');
                    }
                    return;
                }
                
                const data = await response.json();
                
                // Add success message with timestamp
                showStatus(`Content updated successfully! Changes will be live shortly. (${new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' })})`, 'success');
                
                // Update content information
                contentInfo.innerHTML = `
                    <p><strong>Last Updated:</strong> ${formatDateIST(data.updated_at)}</p>
                    <p><strong>Source:</strong> Admin interface</p>
                    <p><strong>Served By:</strong> Netlify Function</p>
                    <p><strong>Status:</strong> ${data.message || 'Update successful'}</p>
                `;
                
                // Auto reload content after 2 seconds
                setTimeout(() => {
                    loadContent();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving content:', error);
                showStatus(`Failed to save content: ${error.message}. Check console for details.`, 'error');
            } finally {
                aboutForm.classList.remove('loading');
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin page loaded, checking token...');
            
            // Debug info for troubleshooting
            const debugInfo = document.createElement('div');
            debugInfo.id = 'debug-info';
            debugInfo.style.display = 'none';
            debugInfo.className = 'mt-4 p-3 bg-light border';
            debugInfo.innerHTML = `
                <h5>Debug Information</h5>
                <p><strong>Page URL:</strong> ${window.location.href}</p>
                <p><strong>Hostname:</strong> ${window.location.hostname}</p>
                <p><strong>Environment:</strong> ${window.location.hostname.includes('netlify.app') ? 'Netlify' : 'Local/Other'}</p>
                <p><strong>Token Status:</strong> ${apiToken ? 'Token present in session' : 'No token in session'}</p>
                <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                <button id="toggle-debug-info" class="btn btn-sm btn-secondary">Hide Debug Info</button>
            `;
            
            document.querySelector('.container').appendChild(debugInfo);
            
            // Add debug toggle button at the top
            const debugToggleBtn = document.createElement('button');
            debugToggleBtn.id = 'show-debug-info';
            debugToggleBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
            debugToggleBtn.textContent = 'Show Debug Info';
            debugToggleBtn.addEventListener('click', function() {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.style.display = 'block';
                this.style.display = 'none';
            });
            
            document.querySelector('h1.mb-4').insertAdjacentElement('afterend', debugToggleBtn);
            
            // Toggle debug info
            document.getElementById('toggle-debug-info').addEventListener('click', function() {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.style.display = 'none';
                document.getElementById('show-debug-info').style.display = 'inline-block';
            });
            
            // Check for API token
            if (!apiToken) {
                console.log('No token in session storage, prompting user');
                const newToken = prompt('Enter your admin token for content management:');
                if (newToken) {
                    console.log('Token provided, storing in session');
                    apiToken = newToken;
                    sessionStorage.setItem('admin_token', newToken);
                    
                    // Update debug info
                    document.querySelector('#debug-info').innerHTML = document.querySelector('#debug-info').innerHTML.replace(
                        'No token in session', 'Token present in session (newly added)'
                    );
                } else {
                    console.warn('No token provided, continuing but updates will fail');
                    showStatus('Warning: No authentication token provided. You can view content but cannot save changes.', 'error');
                }
            } else {
                console.log('Token found in session storage');
            }
            
            // Test API connection
            fetch('/.netlify/functions/get-content')
                .then(response => {
                    console.log('API connection test:', response.status, response.ok ? 'OK' : 'Failed');
                    if (!response.ok) {
                        showStatus(`API connection issue: ${response.status} ${response.statusText}. Functions may not be deployed correctly.`, 'error');
                        throw new Error(`API error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API environment:', data.environment || 'No environment info');
                    const newDebugInfo = `
                        <p><strong>API Status:</strong> Connected</p>
                        <p><strong>Content Source:</strong> ${data.fetch_source || 'Unknown'}</p>
                        <p><strong>GitHub Config:</strong> ${data.environment?.github_configured ? 'Configured' : 'Not configured'}</p>
                        <p><strong>Running on Netlify:</strong> ${data.environment?.netlify ? 'Yes' : 'No'}</p>
                    `;
                    document.querySelector('#debug-info').insertAdjacentHTML('beforeend', newDebugInfo);
                })
                .catch(err => {
                    console.error('API test failed:', err);
                    document.querySelector('#debug-info').insertAdjacentHTML('beforeend', 
                        `<p><strong>API Status:</strong> <span class="text-danger">Failed - ${err.message}</span></p>`
                    );
                });
            
            // Set up event listeners
            aboutForm.addEventListener('submit', saveContent);
            reloadBtn.addEventListener('click', function() {
                console.log('Manual reload requested');
                showStatus('Reloading content...', 'success');
                loadContent();
            });
            
            // Monitor profile image input for preview
            const profileImageInput = document.getElementById('profile_image');
            if (profileImageInput) {
                profileImageInput.addEventListener('input', function() {
                    const preview = document.getElementById('profile-image-preview');
                    preview.innerHTML = '';
                    
                    if (this.value) {
                        const img = document.createElement('img');
                        img.src = this.value;
                        img.alt = 'Profile Preview';
                        img.className = 'preview-image mt-2';
                        img.onerror = function() {
                            this.style.display = 'none';
                            preview.innerHTML += '<div class="alert alert-warning mt-2">Invalid image URL</div>';
                        };
                        preview.appendChild(img);
                    }
                });
            }
            
            // Add preview for photo URLs
            document.addEventListener('input', function(event) {
                if (event.target.name && event.target.name.endsWith('_url')) {
                    const photoItem = event.target.closest('.photo-item');
                    if (photoItem) {
                        const preview = photoItem.querySelector('.photo-preview');
                        preview.innerHTML = '';
                        
                        if (event.target.value) {
                            const img = document.createElement('img');
                            img.src = event.target.value;
                            img.alt = 'Photo Preview';
                            img.className = 'preview-image';
                            img.onerror = function() {
                                this.style.display = 'none';
                                preview.innerHTML += '<div class="alert alert-warning mt-2">Invalid image URL</div>';
                            };
                            preview.appendChild(img);
                        }
                    }
                }
            });
            
            // Initial load
            console.log('Loading initial content...');
            loadContent();
        });
    </script>
</body>
</html> 